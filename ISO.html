<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO智能文件管理系统 - 支持多文件上传和在线预览</title>
    <style>
        :root {
            --primary-color: #5D3FD3; /* 紫色 */
            --secondary-color: #FF6B6B; /* 红色 */
            --success-color: #1DD1A1; /* 绿色 */
            --warning-color: #FF9F43; /* 橙色 */
            --info-color: #54A0FF; /* 蓝色 */
            --danger-color: #FF4757; /* 深红 */
            --light-bg: #F8F9FA;
            --border-color: #E9ECEF;
            --text-primary: #2C3E50;
            --text-secondary: #6C757D;
            --social-color: #9B59B6; /* 社会责任体系颜色 */
            --environment-color: #1ABC9C; /* 环境体系颜色 */
            --other-color: #95A5A6; /* 其他体系颜色 */
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 13px;
        }
        
        .container {
            max-width: 1700px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 头部 */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBwYXR0ZXJuVHJhbnNmb3JtPSJyb3RhdGUoNDUpIj48cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxMCIgZmlsbD0icmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSI+PC9yZWN0PjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNwYXR0ZXJuKSI+PC9yZWN0Pjwvc3ZnPg==');
            opacity: 0.3;
        }
        
        .header h1 {
            margin-bottom: 8px;
            font-size: 26px;
            font-weight: 700;
            position: relative;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .header-subtitle {
            display: flex;
            gap: 15px;
            margin-top: 12px;
            font-size: 13px;
        }
        
        /* ISO架构说明 - 修复为一行显示 */
        .iso-architecture {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .iso-architecture:hover {
            box-shadow: var(--hover-shadow);
        }
        
        /* 修复：确保4个卡片在一行显示 */
        .architecture-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .level-card {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid;
            transition: transform 0.3s, box-shadow 0.3s;
            background: white;
            height: 100%;
        }
        
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }
        
        .level-1 { border-left-color: var(--danger-color); }
        .level-2 { border-left-color: var(--warning-color); }
        .level-3 { border-left-color: var(--info-color); }
        .level-4 { border-left-color: var(--success-color); }
        
        .level-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .level-badge {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        /* 主布局 */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 25px;
        }
        
        /* 侧边栏 */
        .sidebar {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            height: fit-content;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .sidebar:hover {
            box-shadow: var(--hover-shadow);
        }
        
        .sidebar-section {
            margin-bottom: 30px;
        }
        
        .sidebar-section h3 {
            color: var(--primary-color);
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--light-bg);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
        }
        
        /* ISO分类选择 */
        .level-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .level-btn {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 10px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 13px;
        }
        
        .level-btn:hover {
            background-color: var(--light-bg);
            border-color: var(--secondary-color);
            transform: translateX(5px);
        }
        
        .level-btn.active {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #FF8E8E 100%);
            color: white;
            border-color: var(--secondary-color);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.2);
        }
        
        /* 部门分类 */
        .department-list {
            list-style: none;
            padding: 0;
        }
        
        .department-item {
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid transparent;
            font-size: 13px;
        }
        
        .department-item:hover {
            background-color: var(--light-bg);
            transform: translateX(5px);
        }
        
        .department-item.active {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.1) 0%, rgba(126, 87, 194, 0.1) 100%);
            border-left-color: var(--primary-color);
            font-weight: 600;
        }
        
        .department-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
            color: var(--primary-color);
        }
        
        /* 体系筛选 */
        .system-filter {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .system-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 13px;
        }
        
        .system-checkbox:hover {
            background-color: var(--light-bg);
        }
        
        /* 智能分类统计 */
        .classification-stats {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
            border-radius: 12px;
            padding: 20px;
        }
        
        .stat-item {
            margin-bottom: 15px;
        }
        
        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
        }
        
        /* 主内容区 */
        .main-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .main-content:hover {
            box-shadow: var(--hover-shadow);
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .header-left h2 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 22px;
            font-weight: 700;
        }
        
        .header-left p {
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 13px;
            transition: all 0.3s;
            background: var(--light-bg);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 63, 211, 0.1);
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
        }
        
        /* 控制栏 */
        .control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
            border-radius: 14px;
        }
        
        .upload-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--success-color) 0%, #1abc9c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(29, 209, 161, 0.2);
        }
        
        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(29, 209, 161, 0.3);
        }
        
        /* 文件列表表格 */
        .files-table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .files-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .files-table thead {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.1) 0%, rgba(126, 87, 194, 0.1) 100%);
        }
        
        .files-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
            font-size: 13px;
        }
        
        .files-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }
        
        .files-table tbody tr:hover {
            background-color: rgba(93, 63, 211, 0.03);
        }
        
        .files-table td {
            padding: 16px;
            vertical-align: middle;
        }
        
        /* 文件信息单元格 */
        .file-info-cell {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .file-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            flex-shrink: 0;
        }
        
        .file-icon.pdf { background-color: rgba(255, 107, 107, 0.1); color: var(--secondary-color); }
        .file-icon.word { background-color: rgba(84, 160, 255, 0.1); color: var(--info-color); }
        .file-icon.excel { background-color: rgba(29, 209, 161, 0.1); color: var(--success-color); }
        .file-icon.image { background-color: rgba(255, 159, 67, 0.1); color: var(--warning-color); }
        .file-icon.text { background-color: rgba(149, 165, 166, 0.1); color: var(--other-color); }
        .file-icon.default { background-color: rgba(93, 63, 211, 0.1); color: var(--primary-color); }
        
        .file-details {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
            word-break: break-word;
            font-size: 14px;
        }
        
        .file-description {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* 分类徽章 */
        .classification-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            letter-spacing: 0.3px;
        }
        
        .level-1-badge { background-color: rgba(255, 71, 87, 0.1); color: var(--danger-color); }
        .level-2-badge { background-color: rgba(255, 159, 67, 0.1); color: var(--warning-color); }
        .level-3-badge { background-color: rgba(84, 160, 255, 0.1); color: var(--info-color); }
        .level-4-badge { background-color: rgba(29, 209, 161, 0.1); color: var(--success-color); }
        
        .department-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .dept-quality { background-color: rgba(84, 160, 255, 0.1); color: var(--info-color); }
        .dept-production { background-color: rgba(29, 209, 161, 0.1); color: var(--success-color); }
        .dept-tech { background-color: rgba(255, 159, 67, 0.1); color: var(--warning-color); }
        .dept-sales { background-color: rgba(155, 89, 182, 0.1); color: var(--social-color); }
        .dept-admin { background-color: rgba(93, 63, 211, 0.1); color: var(--primary-color); }
        .dept-hr { background-color: rgba(26, 188, 156, 0.1); color: var(--environment-color); }
        .dept-finance { background-color: rgba(255, 107, 107, 0.1); color: var(--secondary-color); }
        .dept-environment { background-color: rgba(26, 188, 156, 0.1); color: var(--environment-color); }
        .dept-safety { background-color: rgba(255, 159, 67, 0.1); color: var(--warning-color); }
        
        /* 体系徽章 */
        .system-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .system-iso { background-color: rgba(84, 160, 255, 0.1); color: var(--info-color); }
        .system-iatf { background-color: rgba(29, 209, 161, 0.1); color: var(--success-color); }
        .system-ohs { background-color: rgba(255, 159, 67, 0.1); color: var(--warning-color); }
        .system-social { background-color: rgba(155, 89, 182, 0.1); color: var(--social-color); }
        .system-iso14001 { background-color: rgba(26, 188, 156, 0.1); color: var(--environment-color); }
        .system-other { background-color: rgba(149, 165, 166, 0.1); color: var(--other-color); }
        
        /* 体系统计卡片样式 */
        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .system-stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid;
            transition: transform 0.3s;
        }
        
        .system-stat-card:hover {
            transform: translateY(-5px);
        }
        
        .system-stat-card.iso { border-top-color: var(--info-color); }
        .system-stat-card.iatf { border-top-color: var(--success-color); }
        .system-stat-card.ohs { border-top-color: var(--warning-color); }
        .system-stat-card.social { border-top-color: var(--social-color); }
        .system-stat-card.iso14001 { border-top-color: var(--environment-color); }
        .system-stat-card.other { border-top-color: var(--other-color); }
        
        .system-stat-card h4 {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .system-stat-card .count {
            font-size: 20px;
            font-weight: 700;
        }
        
        /* 文件操作 */
        .file-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 7px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .action-preview {
            background-color: rgba(84, 160, 255, 0.1);
            color: var(--info-color);
        }
        
        .action-preview:hover {
            background-color: var(--info-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .action-download {
            background-color: rgba(29, 209, 161, 0.1);
            color: var(--success-color);
        }
        
        .action-download:hover {
            background-color: var(--success-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .action-delete {
            background-color: rgba(255, 107, 107, 0.1);
            color: var(--secondary-color);
        }
        
        .action-delete:hover {
            background-color: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
            color: var(--primary-color);
        }
        
        /* 预览模态框 */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            flex-direction: column;
        }
        
        .preview-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);
            color: white;
            padding: 18px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-title {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-actions {
            display: flex;
            gap: 10px;
        }
        
        .preview-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: 500;
        }
        
        .preview-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        
        .preview-body {
            flex: 1;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .preview-content {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        
        .preview-area {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        /* 预览内容样式 */
        .pdf-preview {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 100%;
            display: block;
            margin: 0 auto;
        }
        
        .text-preview {
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            padding: 25px;
            background: var(--light-bg);
            border-radius: 10px;
            max-height: 80vh;
            overflow: auto;
        }
        
        /* Word和Excel预览样式 */
        .office-preview {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .unsupported-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .unsupported-preview i {
            font-size: 64px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        /* 文件信息面板 */
        .file-info-panel {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            margin-bottom: 10px;
        }
        
        .info-item label {
            font-weight: 600;
            color: var(--primary-color);
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .info-item div {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        /* 上传模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-header h3 {
            color: var(--primary-color);
            font-size: 20px;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: var(--primary-color);
        }
        
        /* 上传表单 */
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 13px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 13px;
            transition: all 0.3s;
            background: var(--light-bg);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 63, 211, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(93, 63, 211, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(93, 63, 211, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--text-secondary) 0%, #868e96 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.2);
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }
        
        /* 智能分类结果 */
        .classification-result {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .classification-result.show {
            display: block;
        }
        
        .result-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed rgba(93, 63, 211, 0.2);
        }
        
        .result-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .confidence-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--secondary-color) 0%, #FF8E8E 100%);
            border-radius: 10px;
            transition: width 1s ease;
        }
        
        /* 手动调整分类 */
        .manual-adjustment {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .adjustment-section {
            margin-bottom: 20px;
        }
        
        .adjustment-section h4 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .adjustment-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .adjustment-option {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 500;
            background: white;
        }
        
        .adjustment-option:hover {
            background: var(--light-bg);
            border-color: var(--primary-color);
        }
        
        .adjustment-option.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .adjustment-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--success-color) 0%, #1abc9c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(29, 209, 161, 0.2);
        }
        
        .adjustment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(29, 209, 161, 0.3);
        }
        
        /* 通知消息 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #1abc9c 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger-color) 0%, #ff6b81 100%);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--info-color) 0%, #2e86de 100%);
        }
        
        /* 部门统计 */
        .department-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h4 {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .stat-card .count {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* 文件拖放区 */
        .file-drop-area {
            border: 3px dashed var(--primary-color);
            border-radius: 16px;
            padding: 40px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 25px;
            background: rgba(93, 63, 211, 0.03);
        }
        
        .file-drop-area:hover {
            background: rgba(93, 63, 211, 0.08);
            border-color: var(--secondary-color);
            transform: translateY(-5px);
        }
        
        .file-drop-icon {
            font-size: 56px;
            color: var(--primary-color);
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        /* 版本信息 */
        .version-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--light-bg);
            padding: 5px 12px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 500;
        }
        
        /* 智能分类规则展示 */
        .classification-rules {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .rule-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed rgba(93, 63, 211, 0.2);
        }
        
        .rule-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .rule-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .keyword-tag {
            background: white;
            border: 1px solid rgba(93, 63, 211, 0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            color: var(--primary-color);
        }
        
        /* 预览工具条 */
        .preview-toolbar {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);
            color: white;
            border-bottom: none;
        }
        
        .toolbar-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 500;
        }
        
        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 多文件上传样式 */
        .multi-file-upload-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .multi-file-btn {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-primary);
        }
        
        .multi-file-btn:hover {
            background: var(--light-bg);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        /* 上传文件列表 */
        .upload-files-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background: var(--light-bg);
        }
        
        .upload-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .upload-file-item:last-child {
            margin-bottom: 0;
        }
        
        .upload-file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .upload-file-icon {
            font-size: 20px;
            color: var(--primary-color);
            width: 30px;
            text-align: center;
        }
        
        .upload-file-name {
            font-weight: 500;
            font-size: 13px;
            word-break: break-all;
        }
        
        .upload-file-size {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .upload-file-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .upload-file-status.pending {
            background: rgba(var(--warning-color-rgb, 255, 159, 67), 0.1);
            color: var(--warning-color);
        }
        
        .upload-file-status.analyzing {
            background: rgba(var(--info-color-rgb, 84, 160, 255), 0.1);
            color: var(--info-color);
        }
        
        .upload-file-status.ready {
            background: rgba(var(--success-color-rgb, 29, 209, 161), 0.1);
            color: var(--success-color);
        }
        
        .upload-file-status.error {
            background: rgba(var(--danger-color-rgb, 255, 71, 87), 0.1);
            color: var(--danger-color);
        }
        
        .upload-file-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            transition: color 0.3s;
        }
        
        .upload-file-remove:hover {
            color: var(--danger-color);
        }
        
        /* 上传进度 */
        .upload-progress {
            margin-top: 20px;
            padding: 15px;
            background: rgba(93, 63, 211, 0.05);
            border-radius: 10px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .progress-bar-container {
            height: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* 批量分类设置 */
        .batch-classification {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        
        .batch-classification-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .batch-classification-content {
            display: none;
        }
        
        .batch-classification-content.show {
            display: block;
        }
        
        .batch-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            gap: 10px;
        }
        
        .page-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .page-btn:hover:not(:disabled) {
            background: var(--light-bg);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .page-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0 10px;
        }
        
        /* Office文件预览使用Google Docs Viewer */
        .office-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                margin-bottom: 25px;
            }
            
            /* 响应式调整：在小屏幕上改为2列 */
            .architecture-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .search-box {
                width: 100%;
            }
            
            .files-table-container {
                font-size: 12px;
            }
            
            .files-table th,
            .files-table td {
                padding: 12px;
            }
            
            .file-actions {
                flex-direction: column;
            }
            
            .preview-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .preview-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .multi-file-upload-controls {
                flex-direction: column;
            }
            
            .batch-options {
                grid-template-columns: 1fr;
            }
            
            /* 响应式调整：在更小的屏幕上改为1列 */
            .architecture-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <h1><i class="fas fa-brain"></i> ISO智能文件管理系统</h1>
            <p>严格遵守ISO标准四级架构，支持多文件上传和智能分类</p>
            <div class="header-subtitle">
                <span><i class="fas fa-check-circle"></i> 支持ISO、IATF16949、职业健康、社会责任、ISO14001环境管理体系</span>
                <span><i class="fas fa-bolt"></i> 支持批量上传和智能分类</span>
            </div>
        </header>
        
        <!-- 主布局 -->
        <div class="main-layout">
            <!-- 侧边栏 -->
            <aside class="sidebar">
                <!-- ISO分类选择 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-filter"></i> 文件分类</h3>
                    <div class="level-buttons">
                        <button class="level-btn active" data-level="all">
                            <i class="fas fa-layer-group"></i> 全部文件
                        </button>
                        <button class="level-btn" data-level="1">
                            <i class="fas fa-book"></i> 一级：管理手册
                        </button>
                        <button class="level-btn" data-level="2">
                            <i class="fas fa-file-alt"></i> 二级：程序文件
                        </button>
                        <button class="level-btn" data-level="3">
                            <i class="fas fa-tasks"></i> 三级：作业指导书
                        </button>
                        <button class="level-btn" data-level="4">
                            <i class="fas fa-clipboard-list"></i> 四级：记录表单
                        </button>
                    </div>
                </div>
                
                <!-- 部门选择 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-building"></i> 部门分类</h3>
                    <ul class="department-list" id="departmentList">
                        <!-- 动态生成 -->
                    </ul>
                </div>
                
                <!-- 体系筛选 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-certificate"></i> 体系筛选</h3>
                    <div class="system-filter">
                        <label class="system-checkbox">
                            <input type="checkbox" id="isoFilter" checked>
                            <span>ISO质量管理体系</span>
                        </label>
                        <label class="system-checkbox">
                            <input type="checkbox" id="iatfFilter" checked>
                            <span>IATF16949汽车行业</span>
                        </label>
                        <label class="system-checkbox">
                            <input type="checkbox" id="ohsFilter" checked>
                            <span>职业健康安全体系</span>
                        </label>
                        <label class="system-checkbox">
                            <input type="checkbox" id="socialFilter" checked>
                            <span>社会责任体系</span>
                        </label>
                        <label class="system-checkbox">
                            <input type="checkbox" id="iso14001Filter" checked>
                            <span>ISO14001环境体系</span>
                        </label>
                        <label class="system-checkbox">
                            <input type="checkbox" id="otherFilter" checked>
                            <span>其他体系/备用</span>
                        </label>
                    </div>
                </div>
                
                <!-- 智能分类统计 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-chart-bar"></i> 分类统计</h3>
                    <div class="classification-stats">
                        <div class="stat-item">
                            <div class="stat-label">
                                <span>一级文件</span>
                                <span id="level1Count">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="level1Bar" style="width: 0%; background: linear-gradient(135deg, var(--danger-color) 0%, #ff6b81 100%);"></div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span>二级文件</span>
                                <span id="level2Count">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="level2Bar" style="width: 0%; background: linear-gradient(135deg, var(--warning-color) 0%, #ffbe76 100%);"></div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span>三级文件</span>
                                <span id="level3Count">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="level3Bar" style="width: 0%; background: linear-gradient(135deg, var(--info-color) 0%, #2e86de 100%);"></div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span>四级文件</span>
                                <span id="level4Count">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="level4Bar" style="width: 0%; background: linear-gradient(135deg, var(--success-color) 0%, #1abc9c 100%);"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 体系分布统计 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-chart-pie"></i> 体系分布</h3>
                    <div class="system-stats" id="systemStats">
                        <!-- 动态生成 -->
                    </div>
                </div>
                
                <!-- 智能分类规则 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-cogs"></i> 分类规则</h3>
                    <div class="classification-rules">
                        <div class="rule-item">
                            <strong>智能分类已启用</strong>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                系统根据文件名和内容自动识别ISO级别、部门和体系类型
                            </div>
                        </div>
                        <div class="rule-item">
                            <strong>支持批量上传</strong>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                                可一次上传多个文件或整个文件夹，系统会智能分类每个文件
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 预览支持格式 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-eye"></i> 预览支持格式</h3>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        <div style="margin-bottom: 5px;"><i class="fas fa-file-pdf"></i> PDF文件</div>
                        <div style="margin-bottom: 5px;"><i class="fas fa-file-image"></i> 图片文件 (JPG, PNG)</div>
                        <div style="margin-bottom: 5px;"><i class="fas fa-file-alt"></i> 文本文件 (TXT)</div>
                        <div style="margin-bottom: 5px;"><i class="fas fa-file-word"></i> Word文件 (DOC, DOCX)</div>
                        <div><i class="fas fa-file-excel"></i> Excel文件 (XLS, XLSX)</div>
                    </div>
                </div>
            </aside>
            
            <!-- 主内容区 -->
            <main class="main-content">
                <!-- ISO架构说明 - 修复为一行显示 -->
                <section class="iso-architecture">
                    <h3><i class="fas fa-sitemap"></i> 管理体系文件架构</h3>
                    <div class="architecture-grid">
                        <div class="level-card level-1">
                            <div class="level-header">
                                <span class="level-badge">一级</span>
                                <span>管理手册</span>
                            </div>
                            <p>描述组织的方针、目标和体系的范围，包括质量、环境、安全等</p>
                        </div>
                        <div class="level-card level-2">
                            <div class="level-header">
                                <span class="level-badge">二级</span>
                                <span>程序文件</span>
                            </div>
                            <p>描述跨部门的管理活动，规定谁、做什么、何时做</p>
                        </div>
                        <div class="level-card level-3">
                            <div class="level-header">
                                <span class="level-badge">三级</span>
                                <span>作业指导书</span>
                            </div>
                            <p>详细描述具体工作任务如何执行，指导具体操作</p>
                        </div>
                        <div class="level-card level-4">
                            <div class="level-header">
                                <span class="level-badge">四级</span>
                                <span>记录表单</span>
                            </div>
                            <p>提供客观证据，证明管理活动已按计划执行</p>
                        </div>
                    </div>
                </section>
                
                <!-- 内容头部 -->
                <div class="content-header">
                    <div class="header-left">
                        <h2 id="currentTitle">全部文件</h2>
                        <p id="fileSummary">共 <span id="fileCount">0</span> 个文件，第 <span id="currentPage">1</span> 页</p>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="搜索文件名或描述...">
                    </div>
                </div>
                
                <!-- 控制栏 -->
                <div class="control-bar">
                    <div>
                        <button class="upload-btn" onclick="openUploadModal()">
                            <i class="fas fa-upload"></i> 批量上传文件（智能分类）
                        </button>
                    </div>
                    <div id="currentFilters" style="font-size: 12px; color: var(--text-secondary);">
                        <!-- 动态显示当前筛选条件 -->
                    </div>
                </div>
                
                <!-- 文件列表表格 -->
                <div class="files-table-container">
                    <table class="files-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th>文件名</th>
                                <th>ISO级别</th>
                                <th>部门</th>
                                <th>体系</th>
                                <th>版本</th>
                                <th>上传日期</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="filesTableBody">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                    
                    <!-- 空状态 -->
                    <div id="emptyState" class="empty-state" style="display: none;">
                        <i class="fas fa-folder-open"></i>
                        <h3>暂无文件</h3>
                        <p>请上传文件或选择其他筛选条件</p>
                    </div>
                </div>
                
                <!-- 分页控件 -->
                <div class="pagination" id="pagination" style="display: none;">
                    <button class="page-btn" id="firstPage" onclick="goToPage(1)" disabled>首页</button>
                    <button class="page-btn" id="prevPage" onclick="goToPrevPage()" disabled>上一页</button>
                    <span class="page-info" id="pageInfo">第 1 页 / 共 1 页</span>
                    <button class="page-btn" id="nextPage" onclick="goToNextPage()" disabled>下一页</button>
                    <button class="page-btn" id="lastPage" onclick="goToLastPage()" disabled>尾页</button>
                </div>
                
                <!-- 智能分类结果展示 -->
                <div id="classificationResult" class="classification-result">
                    <h4><i class="fas fa-robot"></i> 智能分类结果</h4>
                    <div id="classificationResultContent">
                        <!-- 动态生成 -->
                    </div>
                    
                    <!-- 手动调整分类 -->
                    <div id="manualAdjustment" class="manual-adjustment" style="display: none;">
                        <h4><i class="fas fa-sliders-h"></i> 手动调整分类</h4>
                        <div class="adjustment-section">
                            <h5><i class="fas fa-layer-group"></i> ISO级别</h5>
                            <div class="adjustment-options" id="levelAdjustment">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                        <div class="adjustment-section">
                            <h5><i class="fas fa-building"></i> 部门</h5>
                            <div class="adjustment-options" id="departmentAdjustment">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                        <div class="adjustment-section">
                            <h5><i class="fas fa-certificate"></i> 体系类型</h5>
                            <div class="adjustment-options" id="systemAdjustment">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="cancelAdjustment()">取消</button>
                            <button class="adjustment-btn" onclick="applyAdjustment()">
                                <i class="fas fa-check-circle"></i> 应用调整
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 部门统计 -->
                <div class="department-stats" id="departmentStats">
                    <!-- 动态生成 -->
                </div>
            </main>
        </div>
    </div>
    
    <!-- 文件预览模态框 -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-header">
            <div class="preview-title" id="previewTitle">
                <i class="fas fa-file"></i> 文件预览
            </div>
            <div class="preview-actions">
                <button class="preview-btn" onclick="downloadCurrentPreview()">
                    <i class="fas fa-download"></i> 下载
                </button>
                <button class="preview-btn" onclick="closePreview()">
                    <i class="fas fa-times"></i> 关闭
                </button>
            </div>
        </div>
        <div class="preview-body">
            <div class="preview-content">
                <!-- 预览工具条 -->
                <div class="preview-toolbar" id="previewToolbar" style="display: none;">
                    <button class="toolbar-btn" onclick="zoomIn()">
                        <i class="fas fa-search-plus"></i> 放大
                    </button>
                    <button class="toolbar-btn" onclick="zoomOut()">
                        <i class="fas fa-search-minus"></i> 缩小
                    </button>
                    <button class="toolbar-btn" onclick="resetZoom()">
                        <i class="fas fa-sync-alt"></i> 重置
                    </button>
                    <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                        <span id="pageInfo" style="font-size: 12px;"></span>
                        <button class="toolbar-btn" onclick="prevPage()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="toolbar-btn" onclick="nextPage()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 预览区域 -->
                <div class="preview-area" id="previewArea">
                    <!-- 预览内容将动态加载到这里 -->
                    <div id="previewLoading" style="display: flex; justify-content: center; align-items: center; height: 100%;">
                        <div style="text-align: center;">
                            <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary-color); margin-bottom: 20px;"></i>
                            <h3>正在加载文件...</h3>
                        </div>
                    </div>
                </div>
                
                <!-- 文件信息面板 -->
                <div class="file-info-panel" id="previewFileInfo" style="display: none;">
                    <h4 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> 文件信息</h4>
                    <div class="info-grid" id="fileInfoContent">
                        <!-- 文件信息将动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 上传文件模态框 -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cloud-upload-alt"></i> 批量文件上传（智能分类）</h3>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="upload-form">
                    <div class="file-drop-area" id="fileDropArea">
                        <div class="file-drop-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h4>点击或拖放文件/文件夹到此处</h4>
                        <p>支持PDF、Word、Excel、图片、文本等格式</p>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> 支持多文件选择和文件夹上传，系统将自动识别ISO级别和部门
                        </p>
                    </div>
                    
                    <!-- 多文件上传控制 -->
                    <div class="multi-file-upload-controls">
                        <button class="multi-file-btn" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-file"></i> 选择多个文件
                        </button>
                        <button class="multi-file-btn" onclick="document.getElementById('folderInput').click()">
                            <i class="fas fa-folder"></i> 选择文件夹
                        </button>
                        <button class="multi-file-btn" onclick="clearUploadList()">
                            <i class="fas fa-trash"></i> 清空列表
                        </button>
                    </div>
                    
                    <input type="file" id="fileInput" style="display: none;" onchange="handleFilesSelect(event)" multiple>
                    <input type="file" id="folderInput" style="display: none;" onchange="handleFolderSelect(event)" webkitdirectory directory multiple>
                    
                    <!-- 批量分类设置 -->
                    <div class="batch-classification">
                        <div class="batch-classification-toggle" onclick="toggleBatchClassification()">
                            <i class="fas fa-chevron-down" id="batchToggleIcon"></i>
                            <h4><i class="fas fa-cogs"></i> 批量分类设置（可选）</h4>
                            <span style="margin-left: auto; font-size: 11px; color: var(--text-secondary);">点击展开</span>
                        </div>
                        <div class="batch-classification-content" id="batchClassificationContent">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;">
                                为所有上传的文件设置统一的分类规则，如果不设置，系统将为每个文件单独智能分类。
                            </p>
                            <div class="batch-options">
                                <div class="form-group">
                                    <label for="batchSystem"><i class="fas fa-certificate"></i> 体系类型</label>
                                    <select id="batchSystem">
                                        <option value="auto">自动识别</option>
                                        <option value="iso">ISO质量管理体系</option>
                                        <option value="iatf">IATF16949汽车行业体系</option>
                                        <option value="ohs">职业健康安全管理体系</option>
                                        <option value="social">社会责任体系 (SA8000等)</option>
                                        <option value="iso14001">ISO14001环境管理体系</option>
                                        <option value="other">其他体系/备用</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="batchDepartment"><i class="fas fa-building"></i> 部门</label>
                                    <select id="batchDepartment">
                                        <option value="auto">自动识别</option>
                                        <option value="quality">质量部</option>
                                        <option value="production">生产部</option>
                                        <option value="tech">技术部</option>
                                        <option value="sales">销售部</option>
                                        <option value="admin">行政部</option>
                                        <option value="hr">人力资源部</option>
                                        <option value="finance">财务部</option>
                                        <option value="environment">环境部</option>
                                        <option value="safety">安全部</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="batchVersion"><i class="fas fa-code-branch"></i> 版本号</label>
                                    <input type="text" id="batchVersion" placeholder="例如：A、A1、B等（应用到所有文件）">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 上传文件列表 -->
                    <div id="selectedFilesInfo" style="display: none;">
                        <h4><i class="fas fa-list"></i> 已选择文件 (<span id="selectedFilesCount">0</span>)</h4>
                        <div class="upload-files-list" id="uploadFilesList">
                            <!-- 文件列表将动态生成 -->
                        </div>
                        
                        <!-- 上传进度 -->
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress-header">
                                <span>上传进度</span>
                                <span id="uploadPercentage">0%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="uploadProgressBar" style="width: 0%"></div>
                            </div>
                            <div class="progress-details">
                                <span id="uploadedCount">已上传: 0</span>
                                <span id="totalFilesCount">总数: 0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="uploadDescription"><i class="fas fa-align-left"></i> 批量文件描述（可选）</label>
                        <textarea id="uploadDescription" placeholder="请输入文件描述（将应用到所有文件）..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">取消</button>
                        <button type="button" class="btn btn-primary" onclick="analyzeAndUploadAll()">
                            <i class="fas fa-brain"></i> 智能分析并批量上传
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 通知消息 -->
    <div id="notification" class="notification"></div>

    <script>
        // 数据库和全局变量
        let db;
        let currentLevel = 'all';
        let currentDepartment = 'all';
        let selectedFiles = []; // 改为数组以支持多文件
        let currentPreviewFile = null;
        let currentZoom = 1.0;
        let currentPage = 1;
        let totalPages = 1;
        let classificationData = null; // 保存智能分类结果
        let filesForUpload = []; // 保存待上传的文件信息
        let uploadQueue = []; // 上传队列
        let isUploading = false; // 是否正在上传
        let uploadedCount = 0; // 已上传数量
        
        // 分页相关变量
        let currentFilePage = 1;
        const filesPerPage = 20; // 每页显示20行
        let allFiles = []; // 所有文件
        let filteredFiles = []; // 过滤后的文件
        
        // ISO分类规则
        const isoClassificationRules = {
            level1: {
                name: '管理手册',
                keywords: ['手册', '质量手册', '管理手册', 'manual', 'handbook', '体系手册', '环境手册', '安全手册', '社会责任手册'],
                patterns: ['手册', '管理手册', '体系手册'],
                description: '描述组织的方针、目标和体系的范围，包括质量、环境、安全等'
            },
            level2: {
                name: '程序文件',
                keywords: ['程序', '程序文件', '控制程序', '管理程序', 'procedure', '流程', '管理办法', '管理流程'],
                patterns: ['程序', '控制程序', '管理程序'],
                description: '描述跨部门的管理活动，规定谁、做什么、何时做'
            },
            level3: {
                name: '作业指导书',
                keywords: ['指导书', '作业指导书', '操作规程', '操作指导', 'instruction', '作业标准', '工艺卡片', '作业规范'],
                patterns: ['指导书', '操作规程', '作业指导'],
                description: '详细描述具体工作任务如何执行，指导具体操作'
            },
            level4: {
                name: '记录表单',
                keywords: ['记录', '表单', '表格', '记录表', '报表', '登记表', '检查表', 'record', 'form', '报告'],
                patterns: ['记录', '表单', '表格', '报告'],
                description: '提供客观证据，证明管理活动已按计划执行'
            }
        };
        
        // 部门信息
        const departments = [
            { id: 'all', name: '全部部门', icon: 'fa-layer-group' },
            { id: 'quality', name: '质量部', icon: 'fa-award' },
            { id: 'production', name: '生产部', icon: 'fa-industry' },
            { id: 'tech', name: '技术部', icon: 'fa-cogs' },
            { id: 'sales', name: '销售部', icon: 'fa-chart-line' },
            { id: 'admin', name: '行政部', icon: 'fa-desktop' },
            { id: 'hr', name: '人力资源部', icon: 'fa-users' },
            { id: 'finance', name: '财务部', icon: 'fa-chart-pie' },
            { id: 'environment', name: '环境部', icon: 'fa-leaf' },
            { id: 'safety', name: '安全部', icon: 'fa-shield-alt' }
        ];
        
        // 体系信息
        const systems = [
            { id: 'iso', name: 'ISO质量管理体系', icon: 'fa-certificate' },
            { id: 'iatf', name: 'IATF16949汽车行业', icon: 'fa-car' },
            { id: 'ohs', name: '职业健康安全体系', icon: 'fa-heartbeat' },
            { id: 'social', name: '社会责任体系', icon: 'fa-handshake' },
            { id: 'iso14001', name: 'ISO14001环境体系', icon: 'fa-leaf' },
            { id: 'other', name: '其他体系/备用', icon: 'fa-archive' }
        ];
        
        // 部门分类规则
        const departmentClassificationRules = {
            quality: {
                keywords: ['质量', '检验', '测试', '标准', 'QC', 'QA', '质量管理', '质量检验', '品管'],
                patterns: ['质量', '检验', '测试']
            },
            production: {
                keywords: ['生产', '制造', '加工', '装配', '生产线', '工序', '生产计划', '生产管理', '车间'],
                patterns: ['生产', '制造', '加工']
            },
            tech: {
                keywords: ['技术', '研发', '设计', '开发', '工艺', '技术文件', '技术规范', '图纸', '工程'],
                patterns: ['技术', '研发', '设计']
            },
            sales: {
                keywords: ['销售', '市场', '客户', '合同', '订单', '营销', '销售管理', '市场分析', '客户服务'],
                patterns: ['销售', '市场', '客户']
            },
            admin: {
                keywords: ['行政', '管理', '办公', '行政事务', '行政管理', '办公管理', '后勤', '综合'],
                patterns: ['行政', '管理', '办公']
            },
            hr: {
                keywords: ['人力资源', '人事', '员工', '培训', '招聘', '薪酬', '绩效', '人力资源部', '人事部'],
                patterns: ['人力资源', '人事', '员工']
            },
            finance: {
                keywords: ['财务', '会计', '预算', '成本', '资金', '财务报表', '财务管理', '会计核算', '审计'],
                patterns: ['财务', '会计', '预算']
            },
            environment: {
                keywords: ['环境', '环保', '排放', '废物', '节能', '能源', '环境管理', '环境保护'],
                patterns: ['环境', '环保', '节能']
            },
            safety: {
                keywords: ['安全', '健康', '防护', '消防', '应急预案', '安全生产', '职业健康', '安全管理'],
                patterns: ['安全', '健康', '防护']
            }
        };
        
        // 体系分类规则
        const systemClassificationRules = {
            iso: {
                keywords: ['质量', 'ISO9001', '质量管理', '品质', '质量体系'],
                patterns: ['质量', 'ISO9001', '质量管理']
            },
            iatf: {
                keywords: ['汽车', 'IATF', '16949', '汽车行业', 'TS16949', '汽车质量'],
                patterns: ['汽车', 'IATF', '16949']
            },
            ohs: {
                keywords: ['安全', '职业健康', 'OHSAS', '安全生产', '职业安全', '健康安全'],
                patterns: ['安全', '职业健康', 'OHS']
            },
            social: {
                keywords: ['社会责任', 'SA8000', '道德', '人权', '劳工', '社会责', 'CSR'],
                patterns: ['社会责任', 'SA8000', '道德']
            },
            iso14001: {
                keywords: ['环境', 'ISO14001', '环保', '排放', '废物', '环境管理', '环境保护'],
                patterns: ['环境', 'ISO14001', '环保']
            }
        };
        
        // 支持预览的文件类型
        const previewableFormats = {
            'pdf': { type: 'pdf', icon: 'fa-file-pdf', name: 'PDF文档', preview: true },
            'jpg': { type: 'image', icon: 'fa-file-image', name: '图片文件', preview: true },
            'jpeg': { type: 'image', icon: 'fa-file-image', name: '图片文件', preview: true },
            'png': { type: 'image', icon: 'fa-file-image', name: '图片文件', preview: true },
            'gif': { type: 'image', icon: 'fa-file-image', name: '图片文件', preview: true },
            'txt': { type: 'text', icon: 'fa-file-alt', name: '文本文件', preview: true },
            'doc': { type: 'office', icon: 'fa-file-word', name: 'Word文档', preview: true },
            'docx': { type: 'office', icon: 'fa-file-word', name: 'Word文档', preview: true },
            'xls': { type: 'office', icon: 'fa-file-excel', name: 'Excel文件', preview: true },
            'xlsx': { type: 'office', icon: 'fa-file-excel', name: 'Excel文件', preview: true }
        };
        
        // 初始化数据库
        function initDatabase() {
            const request = indexedDB.open('ISOFilesPreviewDB', 8);
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                
                // 创建文件存储
                if (!db.objectStoreNames.contains('files')) {
                    const store = db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('level', 'level', { unique: false });
                    store.createIndex('department', 'department', { unique: false });
                    store.createIndex('system', 'system', { unique: false });
                    store.createIndex('name', 'name', { unique: false });
                }
                
                // 创建分类规则存储
                if (!db.objectStoreNames.contains('classificationRules')) {
                    const ruleStore = db.createObjectStore('classificationRules', { keyPath: 'id', autoIncrement: true });
                    ruleStore.createIndex('type', 'type', { unique: false });
                }
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('数据库初始化成功');
                initDepartments();
                loadFiles();
                loadClassificationRules();
                
                // 加载示例数据
                setTimeout(() => {
                    loadSampleData();
                }, 1000);
            };
            
            request.onerror = function(event) {
                console.error('数据库初始化失败:', event.target.error);
            };
        }
        
        // 打开上传模态框
        function openUploadModal() {
            console.log('打开上传模态框');
            document.getElementById('uploadModal').style.display = 'flex';
            
            // 重置上传列表
            clearUploadList();
            
            // 重置批量分类设置
            document.getElementById('batchSystem').value = 'auto';
            document.getElementById('batchDepartment').value = 'auto';
            document.getElementById('batchVersion').value = '';
            document.getElementById('uploadDescription').value = '';
            
            // 隐藏进度条
            document.getElementById('uploadProgress').style.display = 'none';
            
            // 收起批量分类设置
            const batchContent = document.getElementById('batchClassificationContent');
            batchContent.classList.remove('show');
            document.getElementById('batchToggleIcon').className = 'fas fa-chevron-down';
            batchContent.previousElementSibling.querySelector('span').textContent = '点击展开';
            
            // 确保文件输入已重置
            document.getElementById('fileInput').value = '';
            document.getElementById('folderInput').value = '';
        }
        
        // 切换批量分类设置显示/隐藏
        function toggleBatchClassification() {
            const content = document.getElementById('batchClassificationContent');
            const icon = document.getElementById('batchToggleIcon');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.className = 'fas fa-chevron-down';
                content.previousElementSibling.querySelector('span').textContent = '点击展开';
            } else {
                content.classList.add('show');
                icon.className = 'fas fa-chevron-up';
                content.previousElementSibling.querySelector('span').textContent = '点击收起';
            }
        }
        
        // 处理多文件选择
        function handleFilesSelect(event) {
            const files = Array.from(event.target.files);
            addFilesToUploadList(files);
        }
        
        // 处理文件夹选择
        function handleFolderSelect(event) {
            const files = Array.from(event.target.files);
            addFilesToUploadList(files);
        }
        
        // 添加文件到上传列表
        function addFilesToUploadList(files) {
            // 过滤掉不支持的格式（可选）
            const supportedFiles = files.filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return previewableFormats[ext] || true; // 暂时允许所有文件
            });
            
            // 添加到选中的文件列表
            selectedFiles = [...selectedFiles, ...supportedFiles];
            
            // 更新显示
            updateUploadListDisplay();
        }
        
        // 更新上传列表显示
        function updateUploadListDisplay() {
            const selectedFilesInfo = document.getElementById('selectedFilesInfo');
            const uploadFilesList = document.getElementById('uploadFilesList');
            const selectedFilesCount = document.getElementById('selectedFilesCount');
            
            if (selectedFiles.length === 0) {
                selectedFilesInfo.style.display = 'none';
                return;
            }
            
            selectedFilesInfo.style.display = 'block';
            selectedFilesCount.textContent = selectedFiles.length;
            
            // 清空列表
            uploadFilesList.innerHTML = '';
            
            // 添加文件项
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'upload-file-item';
                fileItem.dataset.index = index;
                
                // 获取文件图标
                const ext = file.name.split('.').pop().toLowerCase();
                const format = previewableFormats[ext] || { icon: 'fa-file', name: '文件' };
                
                // 计算文件大小
                const size = formatFileSize(file.size);
                
                fileItem.innerHTML = `
                    <div class="upload-file-info">
                        <div class="upload-file-icon">
                            <i class="fas ${format.icon}"></i>
                        </div>
                        <div style="flex: 1;">
                            <div class="upload-file-name">${file.name}</div>
                            <div class="upload-file-size">${size}</div>
                        </div>
                    </div>
                    <div class="upload-file-status pending">待上传</div>
                    <button class="upload-file-remove" onclick="removeFileFromList(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                uploadFilesList.appendChild(fileItem);
            });
        }
        
        // 从上传列表中移除文件
        function removeFileFromList(index) {
            selectedFiles.splice(index, 1);
            updateUploadListDisplay();
        }
        
        // 清空上传列表
        function clearUploadList() {
            selectedFiles = [];
            updateUploadListDisplay();
            document.getElementById('uploadProgress').style.display = 'none';
        }
        
        // 智能分析并批量上传
        async function analyzeAndUploadAll() {
            if (selectedFiles.length === 0) {
                showNotification('请先选择要上传的文件', 'error');
                return;
            }
            
            // 获取批量设置
            const batchSystem = document.getElementById('batchSystem').value;
            const batchDepartment = document.getElementById('batchDepartment').value;
            const batchVersion = document.getElementById('batchVersion').value;
            const batchDescription = document.getElementById('uploadDescription').value;
            
            // 显示上传进度
            const uploadProgress = document.getElementById('uploadProgress');
            uploadProgress.style.display = 'block';
            
            // 重置上传计数
            uploadedCount = 0;
            isUploading = true;
            
            // 更新进度显示
            updateUploadProgress();
            
            // 创建上传队列
            uploadQueue = [];
            
            // 为每个文件创建上传任务
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const fileInfo = {
                    file: file,
                    index: i,
                    status: 'pending',
                    classification: null
                };
                
                // 如果设置了批量分类，则应用
                if (fileInfo.batchSettings) {
                    const batch = fileInfo.batchSettings;
                    
                    if (batch.system && batch.system !== 'auto') {
                        classificationResult.system = batch.system;
                        classificationResult.systemName = systems.find(s => s.id === batch.system)?.name || batch.system;
                    }
                    
                    if (batch.department && batch.department !== 'auto') {
                        classificationResult.department = batch.department;
                        classificationResult.departmentName = departments.find(d => d.id === batch.department)?.name || batch.department;
                    }
                }
                
                uploadQueue.push(fileInfo);
            }
            
            // 开始处理队列
            processUploadQueue();
        }
        
        // 处理上传队列
        async function processUploadQueue() {
            if (uploadQueue.length === 0) {
                // 所有文件处理完成
                isUploading = false;
                showNotification(`批量上传完成！成功上传 ${uploadedCount} 个文件`, 'success');
                
                // 关闭模态框并重新加载文件列表
                setTimeout(() => {
                    closeModal();
                    loadFiles();
                }, 2000);
                return;
            }
            
            // 获取下一个文件
            const fileInfo = uploadQueue.shift();
            const file = fileInfo.file;
            const index = fileInfo.index;
            
            // 更新文件状态为分析中
            updateFileStatus(index, 'analyzing');
            
            try {
                // 智能分类分析
                let classificationResult = await classifyFile(file);
                
                // 应用批量设置（如果设置了）
                if (fileInfo.batchSettings) {
                    const batch = fileInfo.batchSettings;
                    
                    if (batch.system && batch.system !== 'auto') {
                        classificationResult.system = batch.system;
                        classificationResult.systemName = systems.find(s => s.id === batch.system)?.name || batch.system;
                    }
                    
                    if (batch.department && batch.department !== 'auto') {
                        classificationResult.department = batch.department;
                        classificationResult.departmentName = departments.find(d => d.id === batch.department)?.name || batch.department;
                    }
                }
                
                // 保存分类结果
                fileInfo.classification = classificationResult;
                
                // 保存文件到数据库
                await saveFileToDB(
                    file, 
                    classificationResult, 
                    fileInfo.batchSettings?.system || classificationResult.system,
                    fileInfo.batchSettings?.description || classificationResult.isoLevelName,
                    fileInfo.batchSettings?.version || 'A'
                );
                
                // 更新文件状态为完成
                updateFileStatus(index, 'ready');
                uploadedCount++;
                
                // 更新进度
                updateUploadProgress();
                
                // 继续处理下一个文件
                setTimeout(() => {
                    processUploadQueue();
                }, 100); // 添加小的延迟以避免阻塞UI
                
            } catch (error) {
                console.error('文件处理失败:', error);
                updateFileStatus(index, 'error');
                
                // 继续处理下一个文件（即使这个失败了）
                setTimeout(() => {
                    processUploadQueue();
                }, 100);
            }
        }
        
        // 更新文件状态
        function updateFileStatus(index, status) {
            const fileItems = document.querySelectorAll('.upload-file-item');
            if (fileItems[index]) {
                const statusElement = fileItems[index].querySelector('.upload-file-status');
                statusElement.textContent = getStatusText(status);
                statusElement.className = `upload-file-status ${status}`;
            }
        }
        
        // 获取状态文本
        function getStatusText(status) {
            switch(status) {
                case 'pending': return '待上传';
                case 'analyzing': return '分析中';
                case 'ready': return '已完成';
                case 'error': return '失败';
                default: return status;
            }
        }
        
        // 更新上传进度
        function updateUploadProgress() {
            const total = selectedFiles.length;
            const percentage = total > 0 ? Math.round((uploadedCount / total) * 100) : 0;
            
            document.getElementById('uploadPercentage').textContent = `${percentage}%`;
            document.getElementById('uploadProgressBar').style.width = `${percentage}%`;
            document.getElementById('uploadedCount').textContent = `已上传: ${uploadedCount}`;
            document.getElementById('totalFilesCount').textContent = `总数: ${total}`;
        }
        
        // 智能分类文件
        async function classifyFile(file) {
            const fileName = file.name.toLowerCase();
            
            // 分析ISO级别
            let isoLevel = 0;
            let isoConfidence = 0;
            let isoReason = '';
            let isoKeywords = [];
            
            Object.entries(isoClassificationRules).forEach(([levelKey, rule]) => {
                let score = 0;
                const foundKeywords = [];
                
                // 检查关键词
                rule.keywords.forEach(keyword => {
                    if (fileName.includes(keyword.toLowerCase())) {
                        score += 2;
                        foundKeywords.push(keyword);
                    }
                });
                
                // 检查模式
                rule.patterns.forEach(pattern => {
                    const regex = new RegExp(pattern, 'i');
                    if (regex.test(fileName)) {
                        score += 3;
                        foundKeywords.push(pattern);
                    }
                });
                
                // 文件类型权重
                const ext = file.name.split('.').pop().toLowerCase();
                if (ext === 'pdf' && levelKey === 'level1') {
                    score += 1;
                } else if ((ext === 'doc' || ext === 'docx') && levelKey === 'level2') {
                    score += 1;
                } else if (ext === 'xlsx' && levelKey === 'level4') {
                    score += 1;
                }
                
                if (score > isoConfidence) {
                    isoConfidence = score;
                    isoLevel = parseInt(levelKey.replace('level', ''));
                    isoReason = rule.description;
                    isoKeywords = foundKeywords;
                }
            });
            
            // 分析部门
            let department = 'admin'; // 默认为行政部
            let deptConfidence = 0;
            let deptReason = '';
            let deptKeywords = [];
            
            Object.entries(departmentClassificationRules).forEach(([deptId, rule]) => {
                let score = 0;
                const foundKeywords = [];
                
                // 检查关键词
                rule.keywords.forEach(keyword => {
                    if (fileName.includes(keyword.toLowerCase())) {
                        score += 2;
                        foundKeywords.push(keyword);
                    }
                });
                
                // 检查模式
                rule.patterns.forEach(pattern => {
                    const regex = new RegExp(pattern, 'i');
                    if (regex.test(fileName)) {
                        score += 3;
                        foundKeywords.push(pattern);
                    }
                });
                
                if (score > deptConfidence) {
                    deptConfidence = score;
                    department = deptId;
                    deptReason = `文件名包含部门相关关键词`;
                    deptKeywords = foundKeywords;
                }
            });
            
            // 分析体系类型
            let systemType = 'iso'; // 默认为ISO体系
            let systemConfidence = 0;
            let systemReason = '';
            let systemKeywords = [];
            
            Object.entries(systemClassificationRules).forEach(([sysId, rule]) => {
                let score = 0;
                const foundKeywords = [];
                
                // 检查关键词
                rule.keywords.forEach(keyword => {
                    if (fileName.includes(keyword.toLowerCase())) {
                        score += 2;
                        foundKeywords.push(keyword);
                    }
                });
                
                // 检查模式
                rule.patterns.forEach(pattern => {
                    const regex = new RegExp(pattern, 'i');
                    if (regex.test(fileName)) {
                        score += 3;
                        foundKeywords.push(pattern);
                    }
                });
                
                if (score > systemConfidence) {
                    systemConfidence = score;
                    systemType = sysId;
                    systemReason = `文件名包含体系相关关键词`;
                    systemKeywords = foundKeywords;
                }
            });
            
            // 计算总体置信度
            const totalConfidence = Math.min(0.95, (isoConfidence + deptConfidence + systemConfidence) / 30);
            
            return {
                level: isoLevel,
                department: department,
                system: systemType,
                confidence: totalConfidence,
                isoKeywords: isoKeywords,
                deptKeywords: deptKeywords,
                systemKeywords: systemKeywords,
                isoReason: isoReason,
                deptReason: deptReason,
                systemReason: systemReason,
                isoLevelName: getLevelName(isoLevel),
                departmentName: departments.find(d => d.id === department)?.name || department,
                systemName: getSystemName(systemType)
            };
        }
        
        // 保存文件到数据库
        function saveFileToDB(file, classification, system, description, version) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    let fileData = e.target.result;
                    
                    // 对PDF文件进行特殊处理
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (ext === 'pdf') {
                        // 确保PDF数据是有效的Base64
                        if (!fileData.startsWith('data:application/pdf')) {
                            // 如果不是Data URL格式，重新构建
                            fileData = 'data:application/pdf;base64,' + btoa(e.target.result);
                        }
                    }
                    
                    const fileDataObj = {
                        name: file.name,
                        level: classification.level,
                        department: classification.department,
                        system: system,
                        description: description || `智能分类: ${classification.isoLevelName}`,
                        version: version || 'A',
                        size: file.size,
                        uploadDate: new Date().toLocaleDateString('zh-CN'),
                        classificationConfidence: classification.confidence,
                        classificationReason: `ISO级别: ${classification.isoLevelName}, 部门: ${classification.departmentName}, 体系: ${classification.systemName}`,
                        isLatest: true,
                        lastModified: new Date().toISOString(),
                        data: fileData,
                        previewable: checkPreviewable(file.name)
                    };
                    
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    store.add(fileDataObj);
                    
                    transaction.oncomplete = function() {
                        resolve();
                    };
                    
                    transaction.onerror = function() {
                        reject();
                    };
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        // 检查文件是否可预览
        function checkPreviewable(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const format = previewableFormats[ext];
            return format ? format.preview : false;
        }
        
        // 预览文件 - 修复：支持Word和Excel在线预览
        function previewFile(id) {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const file = request.result;
                if (!file) {
                    showNotification('文件不存在', 'error');
                    return;
                }
                
                currentPreviewFile = file;
                openPreview(file);
            };
        }
        
        // 打开预览
        function openPreview(file) {
            document.getElementById('previewModal').style.display = 'flex';
            document.getElementById('previewLoading').style.display = 'flex';
            document.getElementById('previewToolbar').style.display = 'none';
            document.getElementById('previewFileInfo').style.display = 'none';
            
            // 设置预览标题
            document.getElementById('previewTitle').innerHTML = `<i class="fas fa-file"></i> ${file.name}`;
            
            // 清空预览区域
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            previewArea.appendChild(document.getElementById('previewLoading'));
            
            // 获取文件扩展名
            const ext = file.name.split('.').pop().toLowerCase();
            const format = previewableFormats[ext];
            
            // 显示文件信息
            displayFileInfo(file);
            
            // 根据文件类型显示预览
            if (file.data) {
                if (format && format.preview) {
                    if (format.type === 'pdf') {
                        previewPDF(file);
                    } else if (format.type === 'image') {
                        previewImage(file);
                    } else if (format.type === 'text') {
                        previewText(file);
                    } else if (format.type === 'office') {
                        // Word和Excel文件使用Google Docs Viewer预览
                        previewOfficeFile(file, ext);
                    } else {
                        showUnsupportedPreview();
                    }
                } else {
                    showUnsupportedPreview();
                }
            } else {
                showUnsupportedPreview();
            }
        }
        
        // 预览Office文件（Word和Excel）
        function previewOfficeFile(file, ext) {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            
            // 清除加载状态
            document.getElementById('previewLoading').style.display = 'none';
            
            try {
                // 从Base64数据创建Blob
                const base64Data = file.data;
                let officeData;
                
                // 检查是否是完整的Data URL
                if (base64Data.startsWith('data:')) {
                    // 提取Base64部分
                    officeData = base64Data.split(',')[1];
                } else {
                    // 假设是纯Base64
                    officeData = base64Data;
                }
                
                // 解码Base64
                const byteString = atob(officeData);
                const arrayBuffer = new ArrayBuffer(byteString.length);
                const uint8Array = new Uint8Array(arrayBuffer);
                
                for (let i = 0; i < byteString.length; i++) {
                    uint8Array[i] = byteString.charCodeAt(i);
                }
                
                // 创建Blob
                let mimeType;
                if (ext === 'doc' || ext === 'docx') {
                    mimeType = 'application/msword';
                } else if (ext === 'xls' || ext === 'xlsx') {
                    mimeType = 'application/vnd.ms-excel';
                }
                
                const blob = new Blob([uint8Array], { type: mimeType });
                const blobUrl = URL.createObjectURL(blob);
                
                // 使用Google Docs Viewer预览Office文件
                const iframe = document.createElement('iframe');
                iframe.className = 'office-iframe';
                
                // Google Docs Viewer URL
                let viewerUrl;
                if (ext === 'doc' || ext === 'docx') {
                    viewerUrl = `https://docs.google.com/gview?url=${encodeURIComponent(blobUrl)}&embedded=true`;
                } else if (ext === 'xls' || ext === 'xlsx') {
                    viewerUrl = `https://docs.google.com/spreadsheets/d/1?url=${encodeURIComponent(blobUrl)}&embedded=true`;
                }
                
                iframe.src = viewerUrl;
                iframe.title = file.name;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                
                // 添加到预览区域
                previewArea.appendChild(iframe);
                
                // 确保工具条和信息面板显示
                document.getElementById('previewToolbar').style.display = 'flex';
                document.getElementById('previewFileInfo').style.display = 'block';
                
                // 添加错误处理
                iframe.onerror = function() {
                    // 如果Google Docs Viewer失败，显示备用预览方法
                    showFallbackOfficePreview(file, blobUrl);
                };
                
            } catch (error) {
                console.error('Office文件预览失败:', error);
                showUnsupportedPreview();
            }
        }
        
        // 备用Office预览方法
        function showFallbackOfficePreview(file, blobUrl) {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            
            const fallbackDiv = document.createElement('div');
            fallbackDiv.className = 'unsupported-preview';
            fallbackDiv.style.textAlign = 'center';
            fallbackDiv.style.padding = '40px';
            
            const ext = file.name.split('.').pop().toLowerCase();
            let fileType = 'Office文件';
            let icon = 'fa-file';
            
            if (ext === 'doc' || ext === 'docx') {
                fileType = 'Word文档';
                icon = 'fa-file-word';
            } else if (ext === 'xls' || ext === 'xlsx') {
                fileType = 'Excel文件';
                icon = 'fa-file-excel';
            }
            
            fallbackDiv.innerHTML = `
                <i class="fas ${icon}" style="font-size: 64px; color: var(--primary-color); margin-bottom: 20px;"></i>
                <h3>${fileType}预览</h3>
                <p>在线预览器无法直接预览此文件，但您可以：</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="downloadCurrentPreview()" style="margin-right: 10px;">
                        <i class="fas fa-download"></i> 下载文件
                    </button>
                    <button class="btn btn-secondary" onclick="openOfficeInNewWindow('${blobUrl}')">
                        <i class="fas fa-external-link-alt"></i> 在新窗口打开
                    </button>
                </div>
            `;
            
            previewArea.appendChild(fallbackDiv);
            
            document.getElementById('previewToolbar').style.display = 'flex';
            document.getElementById('previewFileInfo').style.display = 'block';
        }
        
        // 在新窗口打开Office文件
        function openOfficeInNewWindow(blobUrl) {
            const newWindow = window.open(blobUrl, '_blank');
            if (!newWindow) {
                showNotification('请允许弹出窗口以查看文件', 'info');
                // 如果弹出窗口被阻止，提供下载
                downloadFromBlobUrl(blobUrl, currentPreviewFile.name);
            }
        }
        
        // 从Blob URL下载
        function downloadFromBlobUrl(blobUrl, filename) {
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => {
                URL.revokeObjectURL(blobUrl);
            }, 100);
        }
        
        // 关闭预览
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
            currentPreviewFile = null;
            currentZoom = 1.0;
            currentPage = 1;
        }
        
        // 下载当前预览的文件
        function downloadCurrentPreview() {
            if (currentPreviewFile) {
                downloadFileById(currentPreviewFile.id);
            }
        }
        
        // 关闭模态框
        function closeModal() {
            document.getElementById('uploadModal').style.display = 'none';
            document.getElementById('classificationResult').classList.remove('show');
            document.getElementById('manualAdjustment').style.display = 'none';
            classificationData = null;
            filesForUpload = null;
        }
        
        // 显示通知
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            
            // 设置图标
            let icon = '';
            if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';
            else if (type === 'error') icon = '<i class="fas fa-exclamation-circle"></i>';
            else icon = '<i class="fas fa-info-circle"></i>';
            
            notification.innerHTML = `${icon} ${message}`;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 分页功能
        
        // 转到指定页
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            
            currentFilePage = page;
            displayFilesForPage();
            updatePaginationControls();
        }
        
        // 转到上一页
        function goToPrevPage() {
            goToPage(currentFilePage - 1);
        }
        
        // 转到下一页
        function goToNextPage() {
            goToPage(currentFilePage + 1);
        }
        
        // 转到最后一页
        function goToLastPage() {
            goToPage(totalPages);
        }
        
        // 更新分页控件
        function updatePaginationControls() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const firstPageBtn = document.getElementById('firstPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const lastPageBtn = document.getElementById('lastPage');
            
            // 更新页面信息
            pageInfo.textContent = `第 ${currentFilePage} 页 / 共 ${totalPages} 页`;
            
            // 更新按钮状态
            firstPageBtn.disabled = currentFilePage === 1;
            prevPageBtn.disabled = currentFilePage === 1;
            nextPageBtn.disabled = currentFilePage === totalPages;
            lastPageBtn.disabled = currentFilePage === totalPages;
            
            // 如果有多个页面，显示分页控件
            if (totalPages > 1) {
                pagination.style.display = 'flex';
            } else {
                pagination.style.display = 'none';
            }
        }
        
        // 显示当前页的文件
        function displayFilesForPage() {
            const container = document.getElementById('filesTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredFiles.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('fileCount').textContent = '0';
                document.getElementById('currentPage').textContent = '1';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            // 计算当前页的文件
            const startIndex = (currentFilePage - 1) * filesPerPage;
            const endIndex = Math.min(startIndex + filesPerPage, filteredFiles.length);
            const currentPageFiles = filteredFiles.slice(startIndex, endIndex);
            
            // 按上传日期排序（最新的在前）
            currentPageFiles.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
            
            currentPageFiles.forEach(file => {
                const row = createFileRow(file);
                container.appendChild(row);
            });
            
            // 更新文件计数和当前页码
            document.getElementById('fileCount').textContent = filteredFiles.length;
            document.getElementById('currentPage').textContent = currentFilePage;
        }
        
        // 创建文件行
        function createFileRow(file) {
            const row = document.createElement('tr');
            
            // 获取文件图标
            const icon = getFileIcon(file.name);
            
            // 获取部门信息
            const dept = departments.find(d => d.id === file.department) || { name: file.department };
            const systemName = getSystemName(file.system);
            
            // 检查是否可预览
            const previewable = file.previewable || checkPreviewable(file.name);
            
            row.innerHTML = `
                <td>
                    <div class="file-icon ${icon.class}">
                        <i class="${icon.icon}"></i>
                    </div>
                </td>
                <td>
                    <div class="file-info-cell">
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-description">${file.description || '无描述'}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="classification-badge level-${file.level}-badge">
                        ${getLevelName(file.level)}
                    </span>
                </td>
                <td>
                    <span class="department-badge dept-${file.department}">${dept.name}</span>
                </td>
                <td>
                    <span class="system-badge system-${file.system}">${systemName}</span>
                </td>
                <td>
                    <span class="version-info">${file.version || '无'}</span>
                </td>
                <td>${file.uploadDate}</td>
                <td>
                    <div class="file-actions">
                        ${previewable ? `
                        <button class="action-btn action-preview" onclick="previewFile(${file.id})">
                            <i class="fas fa-eye"></i> 预览
                        </button>
                        ` : ''}
                        <button class="action-btn action-download" onclick="downloadFile(${file.id})">
                            <i class="fas fa-download"></i> 下载
                        </button>
                        <button class="action-btn action-delete" onclick="deleteFile(${file.id})">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </div>
                </td>
            `;
            
            return row;
        }
        
        // 获取文件图标
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const format = previewableFormats[ext];
            
            if (format) {
                return { icon: `fas ${format.icon}`, class: format.type };
            }
            
            return { icon: 'fas fa-file', class: 'default' };
        }
        
        // 获取级别名称
        function getLevelName(level) {
            switch(level) {
                case 1: return '管理手册';
                case 2: return '程序文件';
                case 3: return '作业指导书';
                case 4: return '记录表单';
                default: return '未知';
            }
        }
        
        // 获取体系名称
        function getSystemName(system) {
            switch(system) {
                case 'iso': return 'ISO体系';
                case 'iatf': return 'IATF16949';
                case 'ohs': return '职业健康';
                case 'social': return '社会责任';
                case 'iso14001': return 'ISO14001';
                case 'other': return '其他';
                default: return system;
            }
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // 下载文件
        function downloadFile(id) {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const file = request.result;
                if (!file || !file.data) {
                    showNotification('文件数据不存在', 'error');
                    return;
                }
                
                downloadFileById(id);
            };
        }
        
        // 通过ID下载文件
        function downloadFileById(id) {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const file = request.result;
                if (!file || !file.data) {
                    showNotification('文件数据不存在', 'error');
                    return;
                }
                
                try {
                    // 从Base64数据创建Blob
                    let fileData;
                    
                    if (file.data.startsWith('data:')) {
                        // 如果是Data URL，提取Base64部分
                        const base64Data = file.data.split(',')[1];
                        const byteString = atob(base64Data);
                        const mimeString = file.data.split(',')[0].split(':')[1].split(';')[0];
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        
                        const blob = new Blob([ab], { type: mimeString });
                        const url = URL.createObjectURL(blob);
                        
                        // 创建下载链接
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = file.name;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } else {
                        // 如果是纯Base64
                        const byteString = atob(file.data);
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        
                        // 尝试根据扩展名确定MIME类型
                        const ext = file.name.split('.').pop().toLowerCase();
                        let mimeType = 'application/octet-stream';
                        if (ext === 'pdf') mimeType = 'application/pdf';
                        else if (ext === 'jpg' || ext === 'jpeg') mimeType = 'image/jpeg';
                        else if (ext === 'png') mimeType = 'image/png';
                        else if (ext === 'txt') mimeType = 'text/plain';
                        else if (ext === 'doc') mimeType = 'application/msword';
                        else if (ext === 'docx') mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                        else if (ext === 'xls') mimeType = 'application/vnd.ms-excel';
                        else if (ext === 'xlsx') mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                        
                        const blob = new Blob([ab], { type: mimeType });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = file.name;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }
                    
                    showNotification(`正在下载: ${file.name}`, 'info');
                } catch (error) {
                    console.error('下载失败:', error);
                    showNotification('文件下载失败', 'error');
                }
            };
        }
        
        // 删除文件
        function deleteFile(id) {
            if (!confirm('确定要删除这个文件吗？删除后无法恢复。')) return;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            store.delete(id);
            
            transaction.oncomplete = function() {
                showNotification('文件删除成功', 'success');
                loadFiles();
            };
        }
        
        // 切换ISO级别
        function switchLevel(level) {
            currentLevel = level;
            
            // 更新按钮状态
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.level === level) {
                    btn.classList.add('active');
                }
            });
            
            // 更新标题
            const levelNames = {
                'all': '全部文件',
                '1': '一级：管理手册',
                '2': '二级：程序文件',
                '3': '三级：作业指导书',
                '4': '四级：记录表单'
            };
            
            document.getElementById('currentTitle').textContent = levelNames[level];
            
            // 重新加载文件
            loadFiles();
        }
        
        // 切换部门
        function switchDepartment(departmentId) {
            currentDepartment = departmentId;
            
            // 更新部门按钮状态
            document.querySelectorAll('.department-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.department-item[data-department="${departmentId}"]`).classList.add('active');
            
            // 重新加载文件
            loadFiles();
        }
        
        // 初始化部门列表
        function initDepartments() {
            const departmentList = document.getElementById('departmentList');
            departmentList.innerHTML = '';
            
            departments.forEach(dept => {
                const li = document.createElement('li');
                li.className = `department-item ${dept.id === 'all' ? 'active' : ''}`;
                li.dataset.department = dept.id;
                li.innerHTML = `
                    <span class="department-icon"><i class="fas ${dept.icon}"></i></span>
                    <span>${dept.name}</span>
                `;
                li.onclick = () => switchDepartment(dept.id);
                departmentList.appendChild(li);
            });
        }
        
        // 加载文件
        function loadFiles() {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.getAll();
            
            request.onsuccess = function() {
                allFiles = request.result;
                filterAndDisplayFiles(allFiles);
            };
        }
        
        // 过滤和显示文件
        function filterAndDisplayFiles(files) {
            let filtered = files;
            
            // 按ISO级别过滤
            if (currentLevel !== 'all') {
                filtered = filtered.filter(file => file.level == currentLevel);
            }
            
            // 按部门过滤
            if (currentDepartment !== 'all') {
                filtered = filtered.filter(file => file.department === currentDepartment);
            }
            
            // 按体系过滤
            const showISO = document.getElementById('isoFilter').checked;
            const showIATF = document.getElementById('iatfFilter').checked;
            const showOHS = document.getElementById('ohsFilter').checked;
            const showSocial = document.getElementById('socialFilter').checked;
            const showISO14001 = document.getElementById('iso14001Filter').checked;
            const showOther = document.getElementById('otherFilter').checked;
            
            filtered = filtered.filter(file => {
                if (file.system === 'iso' && !showISO) return false;
                if (file.system === 'iatf' && !showIATF) return false;
                if (file.system === 'ohs' && !showOHS) return false;
                if (file.system === 'social' && !showSocial) return false;
                if (file.system === 'iso14001' && !showISO14001) return false;
                if (file.system === 'other' && !showOther) return false;
                return true;
            });
            
            // 搜索过滤
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(file => 
                    file.name.toLowerCase().includes(searchTerm) ||
                    (file.description && file.description.toLowerCase().includes(searchTerm))
                );
            }
            
            filteredFiles = filtered;
            
            // 重置到第一页
            currentFilePage = 1;
            
            // 计算总页数
            totalPages = Math.max(1, Math.ceil(filteredFiles.length / filesPerPage));
            
            // 显示当前页的文件
            displayFilesForPage();
            
            // 更新分页控件
            updatePaginationControls();
            
            // 更新统计信息
            updateStats(filteredFiles);
            updateDepartmentStats(filteredFiles);
            updateSystemStats(filteredFiles);
        }
        
        // 更新统计信息
        function updateStats(files) {
            const level1Count = files.filter(f => f.level == 1).length;
            const level2Count = files.filter(f => f.level == 2).length;
            const level3Count = files.filter(f => f.level == 3).length;
            const level4Count = files.filter(f => f.level == 4).length;
            
            // 更新计数
            document.getElementById('level1Count').textContent = level1Count;
            document.getElementById('level2Count').textContent = level2Count;
            document.getElementById('level3Count').textContent = level3Count;
            document.getElementById('level4Count').textContent = level4Count;
            
            // 更新进度条
            const maxCount = Math.max(level1Count, level2Count, level3Count, level4Count, 1);
            document.getElementById('level1Bar').style.width = `${(level1Count / maxCount) * 100}%`;
            document.getElementById('level2Bar').style.width = `${(level2Count / maxCount) * 100}%`;
            document.getElementById('level3Bar').style.width = `${(level3Count / maxCount) * 100}%`;
            document.getElementById('level4Bar').style.width = `${(level4Count / maxCount) * 100}%`;
        }
        
        // 更新部门统计
        function updateDepartmentStats(files) {
            const departmentStats = document.getElementById('departmentStats');
            departmentStats.innerHTML = '';
            
            // 统计各部门文件数
            const departmentCounts = {};
            departments.forEach(dept => {
                if (dept.id !== 'all') {
                    departmentCounts[dept.id] = files.filter(f => f.department === dept.id).length;
                }
            });
            
            // 创建统计卡片
            Object.entries(departmentCounts).forEach(([deptId, count]) => {
                const dept = departments.find(d => d.id === deptId);
                if (dept && count > 0) {
                    const statCard = document.createElement('div');
                    statCard.className = 'stat-card';
                    statCard.innerHTML = `
                        <h4>${dept.name}</h4>
                        <div class="count">${count}</div>
                    `;
                    departmentStats.appendChild(statCard);
                }
            });
        }
        
        // 更新体系统计
        function updateSystemStats(files) {
            const systemStats = document.getElementById('systemStats');
            systemStats.innerHTML = '';
            
            // 定义所有体系
            const systemsList = [
                { id: 'iso', name: 'ISO', color: 'var(--info-color)' },
                { id: 'iatf', name: 'IATF', color: 'var(--success-color)' },
                { id: 'ohs', name: '职业健康', color: 'var(--warning-color)' },
                { id: 'social', name: '社会责任', color: 'var(--social-color)' },
                { id: 'iso14001', name: 'ISO14001', color: 'var(--environment-color)' },
                { id: 'other', name: '其他', color: 'var(--other-color)' }
            ];
            
            // 统计各体系文件数
            systemsList.forEach(system => {
                const count = files.filter(f => f.system === system.id).length;
                if (count > 0) {
                    const statCard = document.createElement('div');
                    statCard.className = `system-stat-card ${system.id}`;
                    statCard.innerHTML = `
                        <h4>${system.name}</h4>
                        <div class="count" style="color: ${system.color}">${count}</div>
                    `;
                    systemStats.appendChild(statCard);
                }
            });
        }
        
        // 以下是简化的示例数据加载函数
        function loadSampleData() {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.count();
            
            request.onsuccess = function() {
                if (request.result === 0) {
                    // 添加示例文件
                    addSampleFile('质量管理手册.pdf', 1, 'quality', 'iso', '公司质量管理体系手册');
                    addSampleFile('文件控制程序.docx', 2, 'quality', 'iso', '文件控制程序文件');
                    addSampleFile('生产过程控制程序.docx', 2, 'production', 'iso', '生产过程控制程序');
                    addSampleFile('设备操作规程.pdf', 3, 'tech', 'iso', '设备操作作业指导书');
                    addSampleFile('检验作业指导书.pdf', 3, 'quality', 'iso', '产品检验作业指导');
                    addSampleFile('质量检验记录表.xlsx', 4, 'quality', 'iso', '质量检验记录表单');
                    addSampleFile('安全生产检查记录.xlsx', 4, 'quality', 'ohs', '安全生产检查记录');
                    addSampleFile('IATF16949质量手册.pdf', 1, 'quality', 'iatf', 'IATF16949质量手册');
                    addSampleFile('FMEA控制程序.docx', 2, 'tech', 'iatf', 'FMEA控制程序文件');
                    addSampleFile('职业健康安全手册.pdf', 1, 'hr', 'ohs', '职业健康安全管理手册');
                    addSampleFile('环境管理手册.pdf', 1, 'environment', 'iso14001', 'ISO14001环境管理体系手册');
                    addSampleFile('环境因素识别与评价程序.docx', 2, 'environment', 'iso14001', '环境因素识别与评价程序');
                    addSampleFile('社会责任管理手册.pdf', 1, 'hr', 'social', '社会责任管理体系手册');
                    addSampleFile('员工权益保护程序.docx', 2, 'hr', 'social', '员工权益保护程序文件');
                    addSampleFile('废弃物管理作业指导书.pdf', 3, 'environment', 'iso14001', '废弃物管理作业指导书');
                    addSampleFile('应急准备与响应程序.docx', 2, 'safety', 'ohs', '应急准备与响应程序');
                    addSampleFile('员工满意度调查表.xlsx', 4, 'hr', 'social', '员工满意度调查记录');
                    addSampleFile('环境监测记录表.xlsx', 4, 'environment', 'iso14001', '环境监测记录表单');
                    addSampleFile('能源消耗统计表.xlsx', 4, 'environment', 'iso14001', '能源消耗统计记录');
                    addSampleFile('供应商社会责任评估表.xlsx', 4, 'quality', 'social', '供应商社会责任评估记录');
                    addSampleFile('年度质量目标统计表.xlsx', 4, 'quality', 'iso', '年度质量目标统计记录');
                    addSampleFile('内部审核计划.docx', 2, 'quality', 'iso', '内部审核计划文件');
                    addSampleFile('管理评审会议纪要.docx', 4, 'admin', 'iso', '管理评审会议记录');
                    addSampleFile('产品检验标准.pdf', 3, 'quality', 'iso', '产品检验标准作业指导书');
                    addSampleFile('设备保养记录表.xlsx', 4, 'production', 'iso', '设备保养记录表单');
                    
                    // 重新加载文件
                    setTimeout(() => {
                        loadFiles();
                    }, 500);
                }
            };
        }
        
        function addSampleFile(name, level, department, system, description) {
            const fileData = {
                name: name,
                level: level,
                department: department,
                system: system,
                description: description,
                size: Math.floor(Math.random() * 5000) + 1000,
                uploadDate: new Date().toLocaleDateString('zh-CN'),
                version: 'A',
                isLatest: true,
                classificationConfidence: 0.95,
                classificationReason: '系统示例文件',
                isSample: true,
                previewable: checkPreviewable(name)
            };
            
            const transaction = db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            store.add(fileData);
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化数据库
            initDatabase();
            
            // ISO级别按钮点击事件
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const level = this.dataset.level;
                    switchLevel(level);
                });
            });
            
            // 体系筛选变化事件
            document.getElementById('isoFilter').addEventListener('change', loadFiles);
            document.getElementById('iatfFilter').addEventListener('change', loadFiles);
            document.getElementById('ohsFilter').addEventListener('change', loadFiles);
            document.getElementById('socialFilter').addEventListener('change', loadFiles);
            document.getElementById('iso14001Filter').addEventListener('change', loadFiles);
            document.getElementById('otherFilter').addEventListener('change', loadFiles);
            
            // 搜索框输入事件
            document.getElementById('searchInput').addEventListener('input', loadFiles);
            
            // 文件拖放功能
            const dropArea = document.getElementById('fileDropArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                dropArea.style.borderColor = '#7E57C2';
                dropArea.style.backgroundColor = 'rgba(93, 63, 211, 0.1)';
                dropArea.style.transform = 'translateY(-5px)';
            }
            
            function unhighlight() {
                dropArea.style.borderColor = 'var(--primary-color)';
                dropArea.style.backgroundColor = 'rgba(93, 63, 211, 0.03)';
                dropArea.style.transform = 'translateY(0)';
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const items = dt.items;
                const files = [];
                
                // 处理拖放的文件和文件夹
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    
                    if (item.kind === 'file') {
                        const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                        
                        if (entry && entry.isDirectory) {
                            // 处理文件夹
                            readDirectoryEntry(entry, files);
                        } else {
                            // 处理文件
                            const file = item.getAsFile();
                            if (file) files.push(file);
                        }
                    }
                }
                
                // 如果从拖放中直接获取到了文件
                if (files.length === 0 && dt.files.length > 0) {
                    files.push(...dt.files);
                }
                
                if (files.length > 0) {
                    addFilesToUploadList(files);
                }
                
                unhighlight();
            }
            
            // 读取文件夹内容
            function readDirectoryEntry(entry, fileList) {
                const reader = entry.createReader();
                
                reader.readEntries(function(entries) {
                    entries.forEach(function(entry) {
                        if (entry.isFile) {
                            entry.file(function(file) {
                                fileList.push(file);
                            });
                        } else if (entry.isDirectory) {
                            readDirectoryEntry(entry, fileList);
                        }
                    });
                });
            }
            
            // 点击预览模态框外部关闭
            window.addEventListener('click', function(e) {
                const modal = document.getElementById('previewModal');
                if (e.target === modal) {
                    closePreview();
                }
                
                const uploadModal = document.getElementById('uploadModal');
                if (e.target === uploadModal) {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>