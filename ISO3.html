<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO智能文件管理系统 - 支持多文件上传和在线预览</title>
    <style>
        :root {
            --primary-color: #5D3FD3; /* 紫色 */
            --secondary-color: #FF6B6B; /* 红色 */
            --success-color: #1DD1A1; /* 绿色 */
            --warning-color: #FF9F43; /* 橙色 */
            --info-color: #54A0FF; /* 蓝色 */
            --danger-color: #FF4757; /* 深红 */
            --light-bg: #F8F9FA;
            --border-color: #E9ECEF;
            --text-primary: #2C3E50;
            --text-secondary: #6C757D;
            --social-color: #9B59B6; /* 社会责任体系颜色 */
            --environment-color: #1ABC9C; /* 环境体系颜色 */
            --other-color: #95A5A6; /* 其他体系颜色 */
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 13px;
        }
        
        .container {
            max-width: 1700px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 头部 */
        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBwYXR0ZXJuVHJhbnNmb3JtPSJyb3RhdGUoNDUpIj48cmVjdCB3aWR0aD0iMSIgaGVpZ2h0PSIxMCIgZmlsbD0icmdiYSgyNTUsIDI1NSwgMjU1LCAwLjA1KSI+PC9yZWN0PjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNwYXR0ZXJuKSI+PC9yZWN0Pjwvc3ZnPg==');
            opacity: 0.3;
        }
        
        .header h1 {
            margin-bottom: 8px;
            font-size: 26px;
            font-weight: 700;
            position: relative;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .header-subtitle {
            display: flex;
            gap: 15px;
            margin-top: 12px;
            font-size: 13px;
        }
        
        /* 语言切换按钮 */
        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }
        
        .language-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .language-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* ISO架构说明 - 修复为一行显示 */
        .iso-architecture {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .iso-architecture:hover {
            box-shadow: var(--hover-shadow);
        }
        
        /* 修复：确保4个卡片在一行显示 */
        .architecture-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .level-card {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid;
            transition: transform 0.3s, box-shadow 0.3s;
            background: white;
            height: 100%;
        }
        
        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }
        
        .level-1 { border-left-color: var(--danger-color); }
        .level-2 { border-left-color: var(--warning-color); }
        .level-3 { border-left-color: var(--info-color); }
        .level-4 { border-left-color: var(--success-color); }
        
        .level-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .level-badge {
            background: var(--primary-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        /* 主布局 */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 25px;
        }
        
        /* 侧边栏 */
        .sidebar {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--card-shadow);
            height: fit-content;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .sidebar:hover {
            box-shadow: var(--hover-shadow);
        }
        
        .sidebar-section {
            margin-bottom: 30px;
        }
        
        .sidebar-section h3 {
            color: var(--primary-color);
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--light-bg);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
        }
        
        /* ISO分类选择 */
        .level-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .level-btn {
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 10px;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 13px;
        }
        
        .level-btn:hover {
            background-color: var(--light-bg);
            border-color: var(--secondary-color);
            transform: translateX(5px);
        }
        
        .level-btn.active {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #FF8E8E 100%);
            color: white;
            border-color: var(--secondary-color);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.2);
        }
        
        /* 部门分类 */
        .department-list {
            list-style: none;
            padding: 0;
        }
        
        .department-item {
            padding: 10px 15px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            border-left: 4px solid transparent;
            font-size: 13px;
        }
        
        .department-item:hover {
            background-color: var(--light-bg);
            transform: translateX(5px);
        }
        
        .department-item.active {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.1) 0%, rgba(126, 87, 194, 0.1) 100%);
            border-left-color: var(--primary-color);
            font-weight: 600;
        }
        
        .department-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
            color: var(--primary-color);
        }
        
        /* 体系筛选 */
        .system-filter {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .system-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 13px;
        }
        
        .system-checkbox:hover {
            background-color: var(--light-bg);
        }
        
        /* 智能分类统计 */
        .classification-stats {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
            border-radius: 12px;
            padding: 20px;
        }
        
        .stat-item {
            margin-bottom: 15px;
        }
        
        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
        }
        
        /* 主内容区 */
        .main-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .main-content:hover {
            box-shadow: var(--hover-shadow);
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--light-bg);
        }
        
        .header-left h2 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 22px;
            font-weight: 700;
        }
        
        .header-left p {
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .search-box {
            position: relative;
            width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 13px;
            transition: all 0.3s;
            background: var(--light-bg);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 63, 211, 0.1);
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
        }
        
        /* 控制栏 */
        .control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
            border-radius: 14px;
        }
        
        .upload-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--success-color) 0%, #1abc9c 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(29, 209, 161, 0.2);
        }
        
        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(29, 209, 161, 0.3);
        }
        
        /* 新增：批量操作按钮 */
        .batch-controls {
            display: flex;
            gap: 10px;
        }
        
        .batch-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .batch-delete {
            background: linear-gradient(135deg, var(--danger-color) 0%, #ff6b81 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.2);
        }
        
        .batch-delete:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 71, 87, 0.3);
        }
        
        .batch-move {
            background: linear-gradient(135deg, var(--info-color) 0%, #2e86de 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(84, 160, 255, 0.2);
        }
        
        .batch-move:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(84, 160, 255, 0.3);
        }
        
        /* 新增：批量选择模式样式 */
        .batch-selection-mode .files-table td:first-child {
            width: 60px;
            text-align: center;
        }
        
        .batch-selection-mode .file-icon {
            width: auto;
        }
        
        .batch-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* 文件列表表格 */
        .files-table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .files-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .files-table thead {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.1) 0%, rgba(126, 87, 194, 0.1) 100%);
        }
        
        .files-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
            font-size: 13px;
        }
        
        .files-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }
        
        .files-table tbody tr:hover {
            background-color: rgba(93, 63, 211, 0.03);
        }
        
        .files-table td {
            padding: 16px;
            vertical-align: middle;
        }
        
        /* 文件信息单元格 */
        .file-info-cell {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .file-icon {
            font-size: 24px;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            flex-shrink: 0;
        }
        
        .file-icon.pdf { background-color: rgba(255, 107, 107, 0.1); color: var(--secondary-color); }
        .file-icon.word { background-color: rgba(84, 160, 255, 0.1); color: var(--info-color); }
        .file-icon.excel { background-color: rgba(29, 209, 161, 0.1); color: var(--success-color); }
        .file-icon.image { background-color: rgba(255, 159, 67, 0.1); color: var(--warning-color); }
        .file-icon.text { background-color: rgba(149, 165, 166, 0.1); color: var(--other-color); }
        .file-icon.default { background-color: rgba(93, 63, 211, 0.1); color: var(--primary-color); }
        
        .file-details {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
            word-break: break-word;
            font-size: 14px;
        }
        
        .file-description {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        
        /* 分类徽章 */
        .classification-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            letter-spacing: 0.3px;
        }
        
        .level-1-badge { background-color: rgba(255, 71, 87, 0.1); color: var(--danger-color); }
        .level-2-badge { background-color: rgba(255, 159, 67, 0.1); color: var(--warning-color); }
        .level-3-badge { background-color: rgba(84, 160, 255, 0.1); color: var(--info-color); }
        .level-4-badge { background-color: rgba(29, 209, 161, 0.1); color: var(--success-color); }
        
        .department-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }
        
        .dept-quality { background-color: rgba(84, 160, 255, 0.1); color: var(--info-color); }
        .dept-production { background-color: rgba(29, 209, 161, 0.1); color: var(--success-color); }
        .dept-tech { background-color: rgba(255, 159, 67, 0.1); color: var(--warning-color); }
        .dept-sales { background-color: rgba(155, 89, 182, 0.1); color: var(--social-color); }
        .dept-admin { background-color: rgba(93, 63, 211, 0.1); color: var(--primary-color); }
        .dept-hr { background-color: rgba(26, 188, 156, 0.1); color: var(--environment-color); }
        .dept-finance { background-color: rgba(255, 107, 107, 0.1); color: var(--secondary-color); }
        .dept-environment { background-color: rgba(26, 188, 156, 0.1); color: var(--environment-color); }
        .dept-safety { background-color: rgba(255, 159, 67, 0.1); color: var(--warning-color); }
        .dept-purchase { background-color: rgba(155, 89, 182, 0.2); color: #8E44AD; } /* 新增采购部颜色 */
        
        /* 体系徽章 */
        .system-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .system-iso { background-color: rgba(84, 160, 255, 0.1); color: var(--info-color); }
        .system-iatf { background-color: rgba(29, 209, 161, 0.1); color: var(--success-color); }
        .system-ohs { background-color: rgba(255, 159, 67, 0.1); color: var(--warning-color); }
        .system-social { background-color: rgba(155, 89, 182, 0.1); color: var(--social-color); }
        .system-iso14001 { background-color: rgba(26, 188, 156, 0.1); color: var(--environment-color); }
        .system-other { background-color: rgba(149, 165, 166, 0.1); color: var(--other-color); }
        .system-custom { background-color: rgba(93, 63, 211, 0.1); color: var(--primary-color); }
        
        /* 体系统计卡片样式 */
        .system-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .system-stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid;
            transition: transform 0.3s;
        }
        
        .system-stat-card:hover {
            transform: translateY(-5px);
        }
        
        .system-stat-card.iso { border-top-color: var(--info-color); }
        .system-stat-card.iatf { border-top-color: var(--success-color); }
        .system-stat-card.ohs { border-top-color: var(--warning-color); }
        .system-stat-card.social { border-top-color: var(--social-color); }
        .system-stat-card.iso14001 { border-top-color: var(--environment-color); }
        .system-stat-card.other { border-top-color: var(--other-color); }
        .system-stat-card.custom { border-top-color: var(--primary-color); }
        
        .system-stat-card h4 {
            color: var(--text-secondary);
            font-size: 11px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .system-stat-card .count {
            font-size: 20px;
            font-weight: 700;
        }
        
        /* 文件操作 */
        .file-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 7px 14px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .action-preview {
            background-color: rgba(84, 160, 255, 0.1);
            color: var(--info-color);
        }
        
        .action-preview:hover {
            background-color: var(--info-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .action-download {
            background-color: rgba(29, 209, 161, 0.1);
            color: var(--success-color);
        }
        
        .action-download:hover {
            background-color: var(--success-color);
            color: white;
            transform: translateY(-2px);
        }
        
        .action-delete {
            background-color: rgba(255, 107, 107, 0.1);
            color: var(--secondary-color);
        }
        
        .action-delete:hover {
            background-color: var(--secondary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        /* 新增：移动按钮 */
        .action-move {
            background-color: rgba(93, 63, 211, 0.1);
            color: var(--primary-color);
        }
        
        .action-move:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
            color: var(--primary-color);
        }
        
        /* 预览模态框 */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            flex-direction: column;
        }
        
        .preview-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);
            color: white;
            padding: 18px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-title {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-actions {
            display: flex;
            gap: 10px;
        }
        
        .preview-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-size: 13px;
            font-weight: 500;
        }
        
        .preview-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        
        .preview-body {
            flex: 1;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .preview-content {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
        }
        
        .preview-area {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }
        
        /* 预览内容样式 */
        .pdf-preview {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 100%;
            display: block;
            margin: 0 auto;
        }
        
        .text-preview {
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.6;
            padding: 25px;
            background: var(--light-bg);
            border-radius: 10px;
            max-height: 80vh;
            overflow: auto;
        }
        
        /* Word和Excel预览样式 */
        .office-preview {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .unsupported-preview {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .unsupported-preview i {
            font-size: 64px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        /* 文件信息面板 */
        .file-info-panel {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            margin-bottom: 10px;
        }
        
        .info-item label {
            font-weight: 600;
            color: var(--primary-color);
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .info-item div {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        /* 新增：文件移动模态框 */
        .move-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .move-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .move-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .move-form-group {
            margin-bottom: 15px;
        }
        
        .move-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 13px;
        }
        
        .move-form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 13px;
            transition: all 0.3s;
            background: var(--light-bg);
        }
        
        .move-form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 63, 211, 0.1);
        }
        
        .move-selected-files {
            background: rgba(93, 63, 211, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .move-file-item {
            padding: 8px 12px;
            margin-bottom: 5px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 13px;
        }
        
        /* 新增：添加体系类型模态框 */
        .add-system-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .add-system-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .add-system-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .add-system-form-group {
            margin-bottom: 15px;
        }
        
        .add-system-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 13px;
        }
        
        .add-system-form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 13px;
            transition: all 0.3s;
            background: var(--light-bg);
        }
        
        .add-system-form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 63, 211, 0.1);
        }
        
        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
            border: 1px solid var(--border-color);
        }
        
        /* 上传模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-header h3 {
            color: var(--primary-color);
            font-size: 20px;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: var(--primary-color);
        }
        
        /* 上传表单 */
        .upload-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 13px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 13px;
            transition: all 0.3s;
            background: var(--light-bg);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 63, 211, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(93, 63, 211, 0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(93, 63, 211, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--text-secondary) 0%, #868e96 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.2);
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }
        
        /* 智能分类结果 */
        .classification-result {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .classification-result.show {
            display: block;
        }
        
        .result-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px dashed rgba(93, 63, 211, 0.2);
        }
        
        .result-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .confidence-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--secondary-color) 0%, #FF8E8E 100%);
            border-radius: 10px;
            transition: width 1s ease;
        }
        
        /* 手动调整分类 */
        .manual-adjustment {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .adjustment-section {
            margin-bottom: 20px;
        }
        
        .adjustment-section h4 {
            color: var(--primary-color);
            margin-bottom: 12px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .adjustment-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .adjustment-option {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 500;
            background: white;
        }
        
        .adjustment-option:hover {
            background: var(--light-bg);
            border-color: var(--primary-color);
        }
        
        .adjustment-option.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .adjustment-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--success-color) 0%, #1abc9c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(29, 209, 161, 0.2);
        }
        
        .adjustment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(29, 209, 161, 0.3);
        }
        
        /* 通知消息 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 300px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--success-color) 0%, #1abc9c 100%);
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--danger-color) 0%, #ff6b81 100%);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--info-color) 0%, #2e86de 100%);
        }
        
        /* 部门统计 */
        .department-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card h4 {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .stat-card .count {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        /* 文件拖放区 */
        .file-drop-area {
            border: 3px dashed var(--primary-color);
            border-radius: 16px;
            padding: 40px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 25px;
            background: rgba(93, 63, 211, 0.03);
        }
        
        .file-drop-area:hover {
            background: rgba(93, 63, 211, 0.08);
            border-color: var(--secondary-color);
            transform: translateY(-5px);
        }
        
        .file-drop-icon {
            font-size: 56px;
            color: var(--primary-color);
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        /* 版本信息 */
        .version-info {
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--light-bg);
            padding: 5px 12px;
            border-radius: 20px;
            display: inline-block;
            font-weight: 500;
        }
        
        /* 智能分类规则展示 */
        .classification-rules {
            background: linear-gradient(135deg, rgba(93, 63, 211, 0.05) 0%, rgba(126, 87, 194, 0.05) 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .rule-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px dashed rgba(93, 63, 211, 0.2);
        }
        
        .rule-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .rule-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .keyword-tag {
            background: white;
            border: 1px solid rgba(93, 63, 211, 0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            color: var(--primary-color);
        }
        
        /* 预览工具条 */
        .preview-toolbar {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);
            color: white;
            border-bottom: none;
        }
        
        .toolbar-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            font-size: 12px;
            font-weight: 500;
        }
        
        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 多文件上传样式 */
        .multi-file-upload-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .multi-file-btn {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-primary);
        }
        
        .multi-file-btn:hover {
            background: var(--light-bg);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        /* 上传文件列表 */
        .upload-files-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            background: var(--light-bg);
        }
        
        .upload-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .upload-file-item:last-child {
            margin-bottom: 0;
        }
        
        .upload-file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .upload-file-icon {
            font-size: 20px;
            color: var(--primary-color);
            width: 30px;
            text-align: center;
        }
        
        .upload-file-name {
            font-weight: 500;
            font-size: 13px;
            word-break: break-all;
        }
        
        .upload-file-size {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .upload-file-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        .upload-file-status.pending {
            background: rgba(var(--warning-color-rgb, 255, 159, 67), 0.1);
            color: var(--warning-color);
        }
        
        .upload-file-status.analyzing {
            background: rgba(var(--info-color-rgb, 84, 160, 255), 0.1);
            color: var(--info-color);
        }
        
        .upload-file-status.ready {
            background: rgba(var(--success-color-rgb, 29, 209, 161), 0.1);
            color: var(--success-color);
        }
        
        .upload-file-status.error {
            background: rgba(var(--danger-color-rgb, 255, 71, 87), 0.1);
            color: var(--danger-color);
        }
        
        .upload-file-remove {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            font-size: 16px;
            transition: color 0.3s;
        }
        
        .upload-file-remove:hover {
            color: var(--danger-color);
        }
        
        /* 上传进度 */
        .upload-progress {
            margin-top: 20px;
            padding: 15px;
            background: rgba(93, 63, 211, 0.05);
            border-radius: 10px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .progress-bar-container {
            height: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        /* 批量分类设置 */
        .batch-classification {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
        }
        
        .batch-classification-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        
        .batch-classification-content {
            display: none;
        }
        
        .batch-classification-content.show {
            display: block;
        }
        
        .batch-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            gap: 10px;
        }
        
        .page-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .page-btn:hover:not(:disabled) {
            background: var(--light-bg);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .page-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin: 0 10px;
        }
        
        /* Office文件预览使用Google Docs Viewer */
        .office-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* 新增：侧边栏添加体系按钮 */
        .add-system-btn {
            padding: 10px 15px;
            border: 1px dashed var(--primary-color);
            background: rgba(93, 63, 211, 0.05);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            margin-top: 10px;
            font-size: 12px;
            color: var(--primary-color);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .add-system-btn:hover {
            background: rgba(93, 63, 211, 0.1);
            border-color: var(--secondary-color);
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                margin-bottom: 25px;
            }
            
            /* 响应式调整：在小屏幕上改为2列 */
            .architecture-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 22px;
            }
            
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .search-box {
                width: 100%;
            }
            
            .control-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .batch-controls {
                width: 100%;
                justify-content: flex-start;
            }
            
            .files-table-container {
                font-size: 12px;
            }
            
            .files-table th,
            .files-table td {
                padding: 12px;
            }
            
            .file-actions {
                flex-direction: column;
            }
            
            .preview-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .preview-actions {
                width: 100%;
                justify-content: flex-start;
            }
            
            .multi-file-upload-controls {
                flex-direction: column;
            }
            
            .batch-options {
                grid-template-columns: 1fr;
            }
            
            /* 响应式调整：在更小的屏幕上改为1列 */
            .architecture-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <div class="language-switcher">
                <button class="language-btn" onclick="toggleLanguage()">
                    <i class="fas fa-globe"></i>
                    <span id="languageText">Tiếng Việt</span>
                </button>
            </div>
            <h1><i class="fas fa-brain"></i> <span data-i18n="systemName">ISO智能文件管理系统</span></h1>
            <p data-i18n="systemDescription">严格遵守ISO标准四级架构，支持多文件上传和智能分类</p>
            <div class="header-subtitle">
                <span><i class="fas fa-check-circle"></i> <span data-i18n="support1">支持ISO、IATF16949、职业健康、社会责任、ISO14001环境管理体系</span></span>
                <span><i class="fas fa-bolt"></i> <span data-i18n="support2">支持批量上传和智能分类</span></span>
            </div>
        </header>
        
        <!-- 主布局 -->
        <div class="main-layout">
            <!-- 侧边栏 -->
            <aside class="sidebar">
                <!-- ISO分类选择 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-filter"></i> <span data-i18n="fileClassification">文件分类</span></h3>
                    <div class="level-buttons">
                        <button class="level-btn active" data-level="all">
                            <i class="fas fa-layer-group"></i> <span data-i18n="allFiles">全部文件</span>
                        </button>
                        <button class="level-btn" data-level="1">
                            <i class="fas fa-book"></i> <span data-i18n="level1">一级：管理手册</span>
                        </button>
                        <button class="level-btn" data-level="2">
                            <i class="fas fa-file-alt"></i> <span data-i18n="level2">二级：程序文件</span>
                        </button>
                        <button class="level-btn" data-level="3">
                            <i class="fas fa-tasks"></i> <span data-i18n="level3">三级：作业指导书</span>
                        </button>
                        <button class="level-btn" data-level="4">
                            <i class="fas fa-clipboard-list"></i> <span data-i18n="level4">四级：记录表单</span>
                        </button>
                    </div>
                </div>
                
                <!-- 部门选择 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-building"></i> <span data-i18n="departmentClassification">部门分类</span></h3>
                    <ul class="department-list" id="departmentList">
                        <!-- 动态生成 -->
                    </ul>
                </div>
                
                <!-- 体系筛选 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-certificate"></i> <span data-i18n="systemFilter">体系筛选</span></h3>
                    <div class="system-filter" id="systemFilter">
                        <!-- 动态生成 -->
                    </div>
                    <!-- 新增：添加体系按钮 -->
                    <div class="add-system-btn" onclick="openAddSystemModal()">
                        <i class="fas fa-plus-circle"></i> <span data-i18n="addSystemType">添加体系类型</span>
                    </div>
                </div>
                
                <!-- 智能分类统计 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-chart-bar"></i> <span data-i18n="classificationStats">分类统计</span></h3>
                    <div class="classification-stats">
                        <div class="stat-item">
                            <div class="stat-label">
                                <span data-i18n="level1Files">一级文件</span>
                                <span id="level1Count">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="level1Bar" style="width: 0%; background: linear-gradient(135deg, var(--danger-color) 0%, #ff6b81 100%);"></div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span data-i18n="level2Files">二级文件</span>
                                <span id="level2Count">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="level2Bar" style="width: 0%; background: linear-gradient(135deg, var(--warning-color) 0%, #ffbe76 100%);"></div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span data-i18n="level3Files">三级文件</span>
                                <span id="level3Count">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="level3Bar" style="width: 0%; background: linear-gradient(135deg, var(--info-color) 0%, #2e86de 100%);"></div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">
                                <span data-i18n="level4Files">四级文件</span>
                                <span id="level4Count">0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="level4Bar" style="width: 0%; background: linear-gradient(135deg, var(--success-color) 0%, #1abc9c 100%);"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 体系分布统计 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-chart-pie"></i> <span data-i18n="systemDistribution">体系分布</span></h3>
                    <div class="system-stats" id="systemStats">
                        <!-- 动态生成 -->
                    </div>
                </div>
                
                <!-- 智能分类规则 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-cogs"></i> <span data-i18n="classificationRules">分类规则</span></h3>
                    <div class="classification-rules">
                        <div class="rule-item">
                            <strong data-i18n="smartClassificationEnabled">智能分类已启用</strong>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;" data-i18n="classificationRuleDesc">
                                系统根据文件名和内容自动识别ISO级别、部门和体系类型
                            </div>
                        </div>
                        <div class="rule-item">
                            <strong data-i18n="batchUploadSupport">支持批量上传</strong>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;" data-i18n="batchUploadDesc">
                                可一次上传多个文件或整个文件夹，系统会智能分类每个文件
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 预览支持格式 -->
                <div class="sidebar-section">
                    <h3><i class="fas fa-eye"></i> <span data-i18n="previewSupportedFormats">预览支持格式</span></h3>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        <div style="margin-bottom: 5px;"><i class="fas fa-file-pdf"></i> <span data-i18n="pdfFiles">PDF文件</span></div>
                        <div style="margin-bottom: 5px;"><i class="fas fa-file-image"></i> <span data-i18n="imageFiles">图片文件 (JPG, PNG)</span></div>
                        <div style="margin-bottom: 5px;"><i class="fas fa-file-alt"></i> <span data-i18n="textFiles">文本文件 (TXT)</span></div>
                        <div style="margin-bottom: 5px;"><i class="fas fa-file-word"></i> <span data-i18n="wordFiles">Word文件 (DOC, DOCX)</span></div>
                        <div><i class="fas fa-file-excel"></i> <span data-i18n="excelFiles">Excel文件 (XLS, XLSX)</span></div>
                    </div>
                </div>
            </aside>
            
            <!-- 主内容区 -->
            <main class="main-content">
                <!-- ISO架构说明 - 修复为一行显示 -->
                <section class="iso-architecture">
                    <h3><i class="fas fa-sitemap"></i> <span data-i18n="managementSystemArchitecture">管理体系文件架构</span></h3>
                    <div class="architecture-grid">
                        <div class="level-card level-1">
                            <div class="level-header">
                                <span class="level-badge" data-i18n="level1Short">一级</span>
                                <span data-i18n="managementManual">管理手册</span>
                            </div>
                            <p data-i18n="level1Desc">描述组织的方针、目标和体系的范围，包括质量、环境、安全等</p>
                        </div>
                        <div class="level-card level-2">
                            <div class="level-header">
                                <span class="level-badge" data-i18n="level2Short">二级</span>
                                <span data-i18n="procedureFiles">程序文件</span>
                            </div>
                            <p data-i18n="level2Desc">描述跨部门的管理活动，规定谁、做什么、何时做</p>
                        </div>
                        <div class="level-card level-3">
                            <div class="level-header">
                                <span class="level-badge" data-i18n="level3Short">三级</span>
                                <span data-i18n="workInstructions">作业指导书</span>
                            </div>
                            <p data-i18n="level3Desc">详细描述具体工作任务如何执行，指导具体操作</p>
                        </div>
                        <div class="level-card level-4">
                            <div class="level-header">
                                <span class="level-badge" data-i18n="level4Short">四级</span>
                                <span data-i18n="recordForms">记录表单</span>
                            </div>
                            <p data-i18n="level4Desc">提供客观证据，证明管理活动已按计划执行</p>
                        </div>
                    </div>
                </section>
                
                <!-- 内容头部 -->
                <div class="content-header">
                    <div class="header-left">
                        <h2 id="currentTitle" data-i18n="allFiles">全部文件</h2>
                        <p id="fileSummary"><span data-i18n="totalFiles">共</span> <span id="fileCount">0</span> <span data-i18n="files">个文件，第</span> <span id="currentPage">1</span> <span data-i18n="page">页</span></p>
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" data-i18n-placeholder="searchPlaceholder" placeholder="搜索文件名或描述...">
                    </div>
                </div>
                
                <!-- 控制栏 -->
                <div class="control-bar">
                    <div>
                        <button class="upload-btn" onclick="openUploadModal()">
                            <i class="fas fa-upload"></i> <span data-i18n="batchUpload">批量上传文件（智能分类）</span>
                        </button>
                        <button class="upload-btn" onclick="toggleBatchMode()" style="margin-left: 10px; background: linear-gradient(135deg, var(--primary-color) 0%, #7E57C2 100%);">
                            <i class="fas fa-check-square"></i> <span data-i18n="batchOperation">批量操作</span>
                        </button>
                    </div>
                    <div class="batch-controls" id="batchControls" style="display: none;">
                        <button class="batch-btn batch-delete" onclick="batchDeleteSelected()">
                            <i class="fas fa-trash"></i> <span data-i18n="deleteSelected">删除选中文件</span>
                        </button>
                        <button class="batch-btn batch-move" onclick="batchMoveSelected()">
                            <i class="fas fa-exchange-alt"></i> <span data-i18n="moveSelected">移动选中文件</span>
                        </button>
                        <button class="batch-btn" onclick="exitBatchMode()" style="background: var(--light-bg); color: var(--text-primary);">
                            <i class="fas fa-times"></i> <span data-i18n="exitBatchMode">退出批量模式</span>
                        </button>
                    </div>
                    <div id="currentFilters" style="font-size: 12px; color: var(--text-secondary);">
                        <!-- 动态显示当前筛选条件 -->
                    </div>
                </div>
                
                <!-- 批量操作提示 -->
                <div id="batchModeInfo" class="notification info" style="position: relative; margin-bottom: 20px; display: none;">
                    <i class="fas fa-check-circle"></i> <span data-i18n="batchModeEnabled">批量选择模式已启用，请勾选要操作的文件</span>
                    <span id="selectedCount" style="margin-left: 10px; font-weight: bold;"><span data-i18n="selected">已选择:</span> <span>0</span> <span data-i18n="files">个文件</span></span>
                </div>
                
                <!-- 文件列表表格 -->
                <div class="files-table-container">
                    <table class="files-table" id="filesTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;"></th>
                                <th data-i18n="fileName">文件名</th>
                                <th data-i18n="isoLevel">ISO级别</th>
                                <th data-i18n="department">部门</th>
                                <th data-i18n="system">体系</th>
                                <th data-i18n="version">版本</th>
                                <th data-i18n="uploadDate">上传日期</th>
                                <th data-i18n="operations">操作</th>
                            </tr>
                        </thead>
                        <tbody id="filesTableBody">
                            <!-- 动态生成 -->
                        </tbody>
                    </table>
                    
                    <!-- 空状态 -->
                    <div id="emptyState" class="empty-state" style="display: none;">
                        <i class="fas fa-folder-open"></i>
                        <h3 data-i18n="noFiles">暂无文件</h3>
                        <p data-i18n="noFilesDesc">请上传文件或选择其他筛选条件</p>
                    </div>
                </div>
                
                <!-- 分页控件 -->
                <div class="pagination" id="pagination" style="display: none;">
                    <button class="page-btn" id="firstPage" onclick="goToPage(1)" disabled data-i18n="firstPage">首页</button>
                    <button class="page-btn" id="prevPage" onclick="goToPrevPage()" disabled data-i18n="prevPage">上一页</button>
                    <span class="page-info" id="pageInfo" data-i18n="pageInfo">第 1 页 / 共 1 页</span>
                    <button class="page-btn" id="nextPage" onclick="goToNextPage()" disabled data-i18n="nextPage">下一页</button>
                    <button class="page-btn" id="lastPage" onclick="goToLastPage()" disabled data-i18n="lastPage">尾页</button>
                </div>
                
                <!-- 智能分类结果展示 -->
                <div id="classificationResult" class="classification-result">
                    <h4><i class="fas fa-robot"></i> <span data-i18n="smartClassificationResult">智能分类结果</span></h4>
                    <div id="classificationResultContent">
                        <!-- 动态生成 -->
                    </div>
                    
                    <!-- 手动调整分类 -->
                    <div id="manualAdjustment" class="manual-adjustment" style="display: none;">
                        <h4><i class="fas fa-sliders-h"></i> <span data-i18n="manualAdjustment">手动调整分类</span></h4>
                        <div class="adjustment-section">
                            <h5><i class="fas fa-layer-group"></i> <span data-i18n="isoLevel">ISO级别</span></h5>
                            <div class="adjustment-options" id="levelAdjustment">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                        <div class="adjustment-section">
                            <h5><i class="fas fa-building"></i> <span data-i18n="department">部门</span></h5>
                            <div class="adjustment-options" id="departmentAdjustment">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                        <div class="adjustment-section">
                            <h5><i class="fas fa-certificate"></i> <span data-i18n="systemType">体系类型</span></h5>
                            <div class="adjustment-options" id="systemAdjustment">
                                <!-- 动态生成 -->
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-secondary" onclick="cancelAdjustment()" data-i18n="cancel">取消</button>
                            <button class="adjustment-btn" onclick="applyAdjustment()">
                                <i class="fas fa-check-circle"></i> <span data-i18n="applyAdjustment">应用调整</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 部门统计 -->
                <div class="department-stats" id="departmentStats">
                    <!-- 动态生成 -->
                </div>
            </main>
        </div>
    </div>
    
    <!-- 文件预览模态框 -->
    <div id="previewModal" class="preview-modal">
        <div class="preview-header">
            <div class="preview-title" id="previewTitle">
                <i class="fas fa-file"></i> <span data-i18n="filePreview">文件预览</span>
            </div>
            <div class="preview-actions">
                <button class="preview-btn" onclick="downloadCurrentPreview()">
                    <i class="fas fa-download"></i> <span data-i18n="download">下载</span>
                </button>
                <button class="preview-btn" onclick="closePreview()">
                    <i class="fas fa-times"></i> <span data-i18n="close">关闭</span>
                </button>
            </div>
        </div>
        <div class="preview-body">
            <div class="preview-content">
                <!-- 预览工具条 -->
                <div class="preview-toolbar" id="previewToolbar" style="display: none;">
                    <button class="toolbar-btn" onclick="zoomIn()">
                        <i class="fas fa-search-plus"></i> <span data-i18n="zoomIn">放大</span>
                    </button>
                    <button class="toolbar-btn" onclick="zoomOut()">
                        <i class="fas fa-search-minus"></i> <span data-i18n="zoomOut">缩小</span>
                    </button>
                    <button class="toolbar-btn" onclick="resetZoom()">
                        <i class="fas fa-sync-alt"></i> <span data-i18n="reset">重置</span>
                    </button>
                    <div style="margin-left: auto; display: flex; align-items: center; gap: 10px;">
                        <span id="pageInfo" style="font-size: 12px;"></span>
                        <button class="toolbar-btn" onclick="prevPage()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="toolbar-btn" onclick="nextPage()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 预览区域 -->
                <div class="preview-area" id="previewArea">
                    <!-- 预览内容将动态加载到这里 -->
                    <div id="previewLoading" style="display: flex; justify-content: center; align-items: center; height: 100%;">
                        <div style="text-align: center;">
                            <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary-color); margin-bottom: 20px;"></i>
                            <h3 data-i18n="loadingFile">正在加载文件...</h3>
                        </div>
                    </div>
                </div>
                
                <!-- 文件信息面板 -->
                <div class="file-info-panel" id="previewFileInfo" style="display: none;">
                    <h4 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> <span data-i18n="fileInfo">文件信息</span></h4>
                    <div class="info-grid" id="fileInfoContent">
                        <!-- 文件信息将动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新增：文件移动模态框 -->
    <div id="moveModal" class="move-modal">
        <div class="move-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exchange-alt"></i> <span data-i18n="moveFileClassification">移动文件分类</span></h3>
                <button class="close-modal" onclick="closeMoveModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="move-form">
                    <div class="move-selected-files" id="moveSelectedFiles">
                        <!-- 动态显示选中的文件 -->
                    </div>
                    
                    <div class="move-form-group">
                        <label for="moveLevel"><i class="fas fa-layer-group"></i> <span data-i18n="isoLevel">ISO级别</span></label>
                        <select id="moveLevel">
                            <option value="" data-i18n="keepOriginal">保持原分类</option>
                            <option value="1" data-i18n="level1Full">一级：管理手册</option>
                            <option value="2" data-i18n="level2Full">二级：程序文件</option>
                            <option value="3" data-i18n="level3Full">三级：作业指导书</option>
                            <option value="4" data-i18n="level4Full">四级：记录表单</option>
                        </select>
                    </div>
                    
                    <div class="move-form-group">
                        <label for="moveDepartment"><i class="fas fa-building"></i> <span data-i18n="department">部门</span></label>
                        <select id="moveDepartment">
                            <option value="" data-i18n="keepOriginal">保持原分类</option>
                            <!-- 动态生成 -->
                        </select>
                    </div>
                    
                    <div class="move-form-group">
                        <label for="moveSystem"><i class="fas fa-certificate"></i> <span data-i18n="systemType">体系类型</span></label>
                        <select id="moveSystem">
                            <option value="" data-i18n="keepOriginal">保持原分类</option>
                            <!-- 动态生成，包括自定义体系 -->
                        </select>
                    </div>
                    
                    <div class="move-form-group">
                        <label for="moveReason"><i class="fas fa-sticky-note"></i> <span data-i18n="moveReason">移动原因（可选）</span></label>
                        <input type="text" id="moveReason" data-i18n-placeholder="moveReasonPlaceholder" placeholder="例如：智能分类纠错，避免放错位置">
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeMoveModal()" data-i18n="cancel">取消</button>
                        <button type="button" class="btn btn-primary" onclick="applyMove()">
                            <i class="fas fa-check"></i> <span data-i18n="applyMove">应用移动</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新增：添加体系类型模态框 -->
    <div id="addSystemModal" class="add-system-modal">
        <div class="add-system-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> <span data-i18n="addSystemType">添加体系类型</span></h3>
                <button class="close-modal" onclick="closeAddSystemModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="add-system-form">
                    <div class="add-system-form-group">
                        <label for="newSystemName"><i class="fas fa-tag"></i> <span data-i18n="systemName">体系名称</span></label>
                        <input type="text" id="newSystemName" data-i18n-placeholder="systemNamePlaceholder" placeholder="例如：ISO45001、食品安全体系等">
                    </div>
                    
                    <div class="add-system-form-group">
                        <label for="newSystemColor"><i class="fas fa-palette"></i> <span data-i18n="systemColor">体系颜色</span></label>
                        <input type="color" id="newSystemColor" value="#3498db" style="width: 100%; height: 40px;">
                        <span class="color-preview" id="colorPreview" style="background-color: #3498db;"></span>
                    </div>
                    
                    <div class="add-system-form-group">
                        <label for="newSystemIcon"><i class="fas fa-icons"></i> <span data-i18n="iconSelection">图标选择</span></label>
                        <select id="newSystemIcon">
                            <option value="fa-certificate" data-i18n="certificate">证书</option>
                            <option value="fa-award" data-i18n="award">奖项</option>
                            <option value="fa-shield-alt" data-i18n="shield">盾牌</option>
                            <option value="fa-leaf" data-i18n="leaf">叶子</option>
                            <option value="fa-heart" data-i18n="heart">心脏</option>
                            <option value="fa-star" data-i18n="star">星星</option>
                            <option value="fa-flag" data-i18n="flag">旗帜</option>
                            <option value="fa-gem" data-i18n="gem">宝石</option>
                            <option value="fa-crown" data-i18n="crown">皇冠</option>
                            <option value="fa-trophy" data-i18n="trophy">奖杯</option>
                        </select>
                    </div>
                    
                    <div class="add-system-form-group">
                        <label for="newSystemKeywords"><i class="fas fa-key"></i> <span data-i18n="keywords">关键词（用逗号分隔）</span></label>
                        <input type="text" id="newSystemKeywords" data-i18n-placeholder="keywordsPlaceholder" placeholder="例如：安全,健康,职业安全,ISO45001">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;" data-i18n="keywordsDesc">
                            系统将根据这些关键词自动识别该体系类型的文件
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAddSystemModal()" data-i18n="cancel">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveNewSystem()">
                            <i class="fas fa-save"></i> <span data-i18n="saveSystemType">保存体系类型</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 上传文件模态框 -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cloud-upload-alt"></i> <span data-i18n="batchFileUpload">批量文件上传（智能分类）</span></h3>
                <button class="close-modal" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="upload-form">
                    <div class="file-drop-area" id="fileDropArea">
                        <div class="file-drop-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h4 data-i18n="clickOrDrag">点击或拖放文件/文件夹到此处</h4>
                        <p data-i18n="supportedFormats">支持PDF、Word、Excel、图片、文本等格式</p>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> <span data-i18n="multiFileSupport">支持多文件选择和文件夹上传，系统将自动识别ISO级别和部门</span>
                        </p>
                    </div>
                    
                    <!-- 多文件上传控制 -->
                    <div class="multi-file-upload-controls">
                        <button class="multi-file-btn" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-file"></i> <span data-i18n="selectMultipleFiles">选择多个文件</span>
                        </button>
                        <button class="multi-file-btn" onclick="document.getElementById('folderInput').click()">
                            <i class="fas fa-folder"></i> <span data-i18n="selectFolder">选择文件夹</span>
                        </button>
                        <button class="multi-file-btn" onclick="clearUploadList()">
                            <i class="fas fa-trash"></i> <span data-i18n="clearList">清空列表</span>
                        </button>
                    </div>
                    
                    <input type="file" id="fileInput" style="display: none;" onchange="handleFilesSelect(event)" multiple>
                    <input type="file" id="folderInput" style="display: none;" onchange="handleFolderSelect(event)" webkitdirectory directory multiple>
                    
                    <!-- 批量分类设置 -->
                    <div class="batch-classification">
                        <div class="batch-classification-toggle" onclick="toggleBatchClassification()">
                            <i class="fas fa-chevron-down" id="batchToggleIcon"></i>
                            <h4><i class="fas fa-cogs"></i> <span data-i18n="batchClassificationSettings">批量分类设置（可选）</span></h4>
                            <span style="margin-left: auto; font-size: 11px; color: var(--text-secondary);" data-i18n="clickToExpand">点击展开</span>
                        </div>
                        <div class="batch-classification-content" id="batchClassificationContent">
                            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;" data-i18n="batchSettingsDesc">
                                为所有上传的文件设置统一的分类规则，如果不设置，系统将为每个文件单独智能分类。
                            </p>
                            <div class="batch-options">
                                <div class="form-group">
                                    <label for="batchSystem"><i class="fas fa-certificate"></i> <span data-i18n="systemType">体系类型</span></label>
                                    <select id="batchSystem">
                                        <option value="auto" data-i18n="autoRecognition">自动识别</option>
                                        <!-- 动态生成，包括自定义体系 -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="batchDepartment"><i class="fas fa-building"></i> <span data-i18n="department">部门</span></label>
                                    <select id="batchDepartment">
                                        <option value="auto" data-i18n="autoRecognition">自动识别</option>
                                        <!-- 动态生成 -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="batchVersion"><i class="fas fa-code-branch"></i> <span data-i18n="versionNumber">版本号</span></label>
                                    <input type="text" id="batchVersion" data-i18n-placeholder="versionPlaceholder" placeholder="例如：A、A1、B等（应用到所有文件）">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 上传文件列表 -->
                    <div id="selectedFilesInfo" style="display: none;">
                        <h4><i class="fas fa-list"></i> <span data-i18n="selectedFiles">已选择文件</span> (<span id="selectedFilesCount">0</span>)</h4>
                        <div class="upload-files-list" id="uploadFilesList">
                            <!-- 文件列表将动态生成 -->
                        </div>
                        
                        <!-- 上传进度 -->
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress-header">
                                <span data-i18n="uploadProgress">上传进度</span>
                                <span id="uploadPercentage">0%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" id="uploadProgressBar" style="width: 0%"></div>
                            </div>
                            <div class="progress-details">
                                <span id="uploadedCount" data-i18n="uploaded">已上传: 0</span>
                                <span id="totalFilesCount" data-i18n="total">总数: 0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="uploadDescription"><i class="fas fa-align-left"></i> <span data-i18n="batchFileDescription">批量文件描述（可选）</span></label>
                        <textarea id="uploadDescription" data-i18n-placeholder="descriptionPlaceholder" placeholder="请输入文件描述（将应用到所有文件）..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()" data-i18n="cancel">取消</button>
                        <button type="button" class="btn btn-primary" onclick="analyzeAndUploadAll()">
                            <i class="fas fa-brain"></i> <span data-i18n="analyzeAndUpload">智能分析并批量上传</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 通知消息 -->
    <div id="notification" class="notification"></div>

    <script>
        // 数据库和全局变量
        let db;
        let currentLevel = 'all';
        let currentDepartment = 'all';
        let selectedFiles = []; // 改为数组以支持多文件
        let currentPreviewFile = null;
        let currentZoom = 1.0;
        let currentPage = 1;
        let totalPages = 1;
        let classificationData = null; // 保存智能分类结果
        let filesForUpload = []; // 保存待上传的文件信息
        let uploadQueue = []; // 上传队列
        let isUploading = false; // 是否正在上传
        let uploadedCount = 0; // 已上传数量
        
        // 分页相关变量
        let currentFilePage = 1;
        const filesPerPage = 20; // 每页显示20行
        let allFiles = []; // 所有文件
        let filteredFiles = []; // 过滤后的文件
        
        // 新增：批量选择相关变量
        let batchSelectionMode = false;
        let selectedFileIds = new Set(); // 存储选中的文件ID
        let customSystems = []; // 存储自定义体系
        
        // 语言相关变量
        let currentLanguage = 'zh'; // 默认中文
        const translations = {
            zh: {
                // 头部
                systemName: "ISO智能文件管理系统",
                systemDescription: "严格遵守ISO标准四级架构，支持多文件上传和智能分类",
                support1: "支持ISO、IATF16949、职业健康、社会责任、ISO14001环境管理体系",
                support2: "支持批量上传和智能分类",
                switchToVietnamese: "Tiếng Việt",
                
                // ISO架构
                managementSystemArchitecture: "管理体系文件架构",
                level1: "一级：管理手册",
                level2: "二级：程序文件",
                level3: "三级：作业指导书",
                level4: "四级：记录表单",
                level1Short: "一级",
                level2Short: "二级",
                level3Short: "三级",
                level4Short: "四级",
                managementManual: "管理手册",
                procedureFiles: "程序文件",
                workInstructions: "作业指导书",
                recordForms: "记录表单",
                level1Desc: "描述组织的方针、目标和体系的范围，包括质量、环境、安全等",
                level2Desc: "描述跨部门的管理活动，规定谁、做什么、何时做",
                level3Desc: "详细描述具体工作任务如何执行，指导具体操作",
                level4Desc: "提供客观证据，证明管理活动已按计划执行",
                
                // 侧边栏
                fileClassification: "文件分类",
                allFiles: "全部文件",
                level1Files: "一级文件",
                level2Files: "二级文件",
                level3Files: "三级文件",
                level4Files: "四级文件",
                departmentClassification: "部门分类",
                systemFilter: "体系筛选",
                addSystemType: "添加体系类型",
                classificationStats: "分类统计",
                systemDistribution: "体系分布",
                classificationRules: "分类规则",
                smartClassificationEnabled: "智能分类已启用",
                classificationRuleDesc: "系统根据文件名和内容自动识别ISO级别、部门和体系类型",
                batchUploadSupport: "支持批量上传",
                batchUploadDesc: "可一次上传多个文件或整个文件夹，系统会智能分类每个文件",
                previewSupportedFormats: "预览支持格式",
                pdfFiles: "PDF文件",
                imageFiles: "图片文件 (JPG, PNG)",
                textFiles: "文本文件 (TXT)",
                wordFiles: "Word文件 (DOC, DOCX)",
                excelFiles: "Excel文件 (XLS, XLSX)",
                
                // 主内容区
                totalFiles: "共",
                files: "个文件",
                page: "页",
                searchPlaceholder: "搜索文件名或描述...",
                batchUpload: "批量上传文件（智能分类）",
                batchOperation: "批量操作",
                deleteSelected: "删除选中文件",
                moveSelected: "移动选中文件",
                exitBatchMode: "退出批量模式",
                batchModeEnabled: "批量选择模式已启用，请勾选要操作的文件",
                selected: "已选择:",
                fileName: "文件名",
                isoLevel: "ISO级别",
                department: "部门",
                system: "体系",
                version: "版本",
                uploadDate: "上传日期",
                operations: "操作",
                noFiles: "暂无文件",
                noFilesDesc: "请上传文件或选择其他筛选条件",
                firstPage: "首页",
                prevPage: "上一页",
                pageInfo: "第 {0} 页 / 共 {1} 页",
                nextPage: "下一页",
                lastPage: "尾页",
                smartClassificationResult: "智能分类结果",
                manualAdjustment: "手动调整分类",
                systemType: "体系类型",
                cancel: "取消",
                applyAdjustment: "应用调整",
                
                // 预览模态框
                filePreview: "文件预览",
                download: "下载",
                close: "关闭",
                zoomIn: "放大",
                zoomOut: "缩小",
                reset: "重置",
                loadingFile: "正在加载文件...",
                fileInfo: "文件信息",
                
                // 移动模态框
                moveFileClassification: "移动文件分类",
                keepOriginal: "保持原分类",
                level1Full: "一级：管理手册",
                level2Full: "二级：程序文件",
                level3Full: "三级：作业指导书",
                level4Full: "四级：记录表单",
                moveReason: "移动原因（可选）",
                moveReasonPlaceholder: "例如：智能分类纠错，避免放错位置",
                applyMove: "应用移动",
                
                // 添加体系模态框
                systemName: "体系名称",
                systemNamePlaceholder: "例如：ISO45001、食品安全体系等",
                systemColor: "体系颜色",
                iconSelection: "图标选择",
                certificate: "证书",
                award: "奖项",
                shield: "盾牌",
                leaf: "叶子",
                heart: "心脏",
                star: "星星",
                flag: "旗帜",
                gem: "宝石",
                crown: "皇冠",
                trophy: "奖杯",
                keywords: "关键词（用逗号分隔）",
                keywordsPlaceholder: "例如：安全,健康,职业安全,ISO45001",
                keywordsDesc: "系统将根据这些关键词自动识别该体系类型的文件",
                saveSystemType: "保存体系类型",
                
                // 上传模态框
                batchFileUpload: "批量文件上传（智能分类）",
                clickOrDrag: "点击或拖放文件/文件夹到此处",
                supportedFormats: "支持PDF、Word、Excel、图片、文本等格式",
                multiFileSupport: "支持多文件选择和文件夹上传，系统将自动识别ISO级别和部门",
                selectMultipleFiles: "选择多个文件",
                selectFolder: "选择文件夹",
                clearList: "清空列表",
                batchClassificationSettings: "批量分类设置（可选）",
                clickToExpand: "点击展开",
                batchSettingsDesc: "为所有上传的文件设置统一的分类规则，如果不设置，系统将为每个文件单独智能分类。",
                autoRecognition: "自动识别",
                versionNumber: "版本号",
                versionPlaceholder: "例如：A、A1、B等（应用到所有文件）",
                selectedFiles: "已选择文件",
                uploadProgress: "上传进度",
                uploaded: "已上传:",
                total: "总数:",
                batchFileDescription: "批量文件描述（可选）",
                descriptionPlaceholder: "请输入文件描述（将应用到所有文件）...",
                analyzeAndUpload: "智能分析并批量上传",
                
                // 部门名称
                allDepartments: "全部部门",
                quality: "质量部",
                production: "生产部",
                tech: "技术部",
                sales: "销售部",
                admin: "行政部",
                hr: "人力资源部",
                finance: "财务部",
                environment: "环境部",
                safety: "安全部",
                purchase: "采购部",
                
                // 体系名称
                iso: "ISO质量管理体系",
                iatf: "IATF16949汽车行业",
                ohs: "职业健康安全体系",
                social: "社会责任体系",
                iso14001: "ISO14001环境体系",
                other: "其他体系/备用",
                
                // 通知消息
                uploadSuccess: "批量上传完成！成功上传 {0} 个文件",
                uploadFailed: "上传失败，请重试",
                deleteSuccess: "文件删除成功",
                moveSuccess: "成功移动 {0} 个文件",
                systemAdded: "体系类型添加成功",
                operationCancelled: "操作已取消",
                noFilesSelected: "请先选择要操作的文件",
                confirmDelete: "确定要删除这个文件吗？删除后无法恢复。",
                confirmBatchDelete: "确定要删除 {0} 个文件吗？此操作不可恢复。"
            },
            vi: {
                // 头部
                systemName: "Hệ thống quản lý tài liệu ISO thông minh",
                systemDescription: "Tuân thủ nghiêm ngặt cấu trúc 4 cấp tiêu chuẩn ISO, hỗ trợ tải lên nhiều tệp và phân loại thông minh",
                support1: "Hỗ trợ hệ thống quản lý ISO, IATF16949, sức khỏe nghề nghiệp, trách nhiệm xã hội, ISO14001 môi trường",
                support2: "Hỗ trợ tải lên hàng loạt và phân loại thông minh",
                switchToVietnamese: "Tiếng Việt",
                
                // ISO架构
                managementSystemArchitecture: "Cấu trúc tài liệu hệ thống quản lý",
                level1: "Cấp 1: Sổ tay quản lý",
                level2: "Cấp 2: Tài liệu chương trình",
                level3: "Cấp 3: Sách hướng dẫn công việc",
                level4: "Cấp 4: Biểu mẫu ghi chép",
                level1Short: "Cấp 1",
                level2Short: "Cấp 2",
                level3Short: "Cấp 3",
                level4Short: "Cấp 4",
                managementManual: "Sổ tay quản lý",
                procedureFiles: "Tài liệu chương trình",
                workInstructions: "Sách hướng dẫn công việc",
                recordForms: "Biểu mẫu ghi chép",
                level1Desc: "Mô tả phương châm, mục tiêu và phạm vi của hệ thống, bao gồm chất lượng, môi trường, an toàn, v.v.",
                level2Desc: "Mô tả các hoạt động quản lý liên phòng ban, quy định ai, làm gì, khi nào làm",
                level3Desc: "Mô tả chi tiết cách thực hiện nhiệm vụ công việc cụ thể, hướng dẫn thao tác cụ thể",
                level4Desc: "Cung cấp bằng chứng khách quan chứng minh hoạt động quản lý đã được thực hiện theo kế hoạch",
                
                // 侧边栏
                fileClassification: "Phân loại tài liệu",
                allFiles: "Tất cả tệp",
                level1Files: "Tệp cấp 1",
                level2Files: "Tệp cấp 2",
                level3Files: "ệp cấp 3",
                level4Files: "Tệp cấp 4",
                departmentClassification: "Phân loại phòng ban",
                systemFilter: "Lọc hệ thống",
                addSystemType: "Thêm loại hệ thống",
                classificationStats: "Thống kê phân loại",
                systemDistribution: "Phân bố hệ thống",
                classificationRules: "Quy tắc phân loại",
                smartClassificationEnabled: "Phân loại thông minh đã kích hoạt",
                classificationRuleDesc: "Hệ thống tự động nhận diện cấp ISO, phòng ban và loại hệ thống dựa trên tên và nội dung tệp",
                batchUploadSupport: "Hỗ trợ tải lên hàng loạt",
                batchUploadDesc: "Có thể tải lên nhiều tệp hoặc toàn bộ thư mục một lần, hệ thống sẽ phân loại thông minh từng tệp",
                previewSupportedFormats: "Định dạng hỗ trợ xem trước",
                pdfFiles: "Tệp PDF",
                imageFiles: "Tệp hình ảnh (JPG, PNG)",
                textFiles: "Tệp văn bản (TXT)",
                wordFiles: "Tệp Word (DOC, DOCX)",
                excelFiles: "Tệp Excel (XLS, XLSX)",
                
                // 主内容区
                totalFiles: "Tổng",
                files: "tệp",
                page: "trang",
                searchPlaceholder: "Tìm kiếm tên tệp hoặc mô tả...",
                batchUpload: "Tải lên tệp hàng loạt (phân loại thông minh)",
                batchOperation: "Thao tác hàng loạt",
                deleteSelected: "Xóa tệp đã chọn",
                moveSelected: "Di chuyển tệp đã chọn",
                exitBatchMode: "Thoát chế độ hàng loạt",
                batchModeEnabled: "Chế độ chọn hàng loạt đã kích hoạt, vui lòng đánh dấu các tệp cần thao tác",
                selected: "Đã chọn:",
                fileName: "Tên tệp",
                isoLevel: "Cấp ISO",
                department: "Phòng ban",
                system: "Hệ thống",
                version: "Phiên bản",
                uploadDate: "Ngày tải lên",
                operations: "Thao tác",
                noFiles: "Chưa có tệp",
                noFilesDesc: "Vui lòng tải lên tệp hoặc chọn điều kiện lọc khác",
                firstPage: "Trang đầu",
                prevPage: "Trang trước",
                pageInfo: "Trang {0} / Tổng {1} trang",
                nextPage: "Trang sau",
                lastPage: "Trang cuối",
                smartClassificationResult: "Kết quả phân loại thông minh",
                manualAdjustment: "Điều chỉnh phân loại thủ công",
                systemType: "Loại hệ thống",
                cancel: "Hủy",
                applyAdjustment: "Áp dụng điều chỉnh",
                
                // 预览模态框
                filePreview: "Xem trước tệp",
                download: "Tải xuống",
                close: "Đóng",
                zoomIn: "Phóng to",
                zoomOut: "Thu nhỏ",
                reset: "Đặt lại",
                loadingFile: "Đang tải tệp...",
                fileInfo: "Thông tin tệp",
                
                // 移动模态框
                moveFileClassification: "Di chuyển phân loại tệp",
                keepOriginal: "Giữ nguyên phân loại",
                level1Full: "Cấp 1: Sổ tay quản lý",
                level2Full: "Cấp 2: Tài liệu chương trình",
                level3Full: "Cấp 3: Sách hướng dẫn công việc",
                level4Full: "Cấp 4: Biểu mẫu ghi chép",
                moveReason: "Lý do di chuyển (tùy chọn)",
                moveReasonPlaceholder: "Ví dụ: Sửa lỗi phân loại thông minh, tránh đặt sai vị trí",
                applyMove: "Áp dụng di chuyển",
                
                // 添加体系模态框
                systemName: "Tên hệ thống",
                systemNamePlaceholder: "Ví dụ: ISO45001, hệ thống an toàn thực phẩm, v.v.",
                systemColor: "Màu hệ thống",
                iconSelection: "Chọn biểu tượng",
                certificate: "Chứng chỉ",
                award: "Giải thưởng",
                shield: "Khiên",
                leaf: "Lá",
                heart: "Trái tim",
                star: "Ngôi sao",
                flag: "Cờ",
                gem: "Đá quý",
                crown: "Vương miện",
                trophy: "Cúp",
                keywords: "Từ khóa (phân cách bằng dấu phẩy)",
                keywordsPlaceholder: "Ví dụ: an toàn, sức khỏe, an toàn nghề nghiệp, ISO45001",
                keywordsDesc: "Hệ thống sẽ tự động nhận diện tệp thuộc loại hệ thống này dựa trên các từ khóa",
                saveSystemType: "Lưu loại hệ thống",
                
                // 上传模态框
                batchFileUpload: "Tải lên tệp hàng loạt (phân loại thông minh)",
                clickOrDrag: "Nhấp hoặc kéo thả tệp/thư mục vào đây",
                supportedFormats: "Hỗ trợ định dạng PDF, Word, Excel, hình ảnh, văn bản, v.v.",
                multiFileSupport: "Hỗ trợ chọn nhiều tệp và tải lên thư mục, hệ thống tự động nhận diện cấp ISO và phòng ban",
                selectMultipleFiles: "Chọn nhiều tệp",
                selectFolder: "Chọn thư mục",
                clearList: "Xóa danh sách",
                batchClassificationSettings: "Cài đặt phân loại hàng loạt (tùy chọn)",
                clickToExpand: "Nhấp để mở rộng",
                batchSettingsDesc: "Thiết lập quy tắc phân loại thống nhất cho tất cả tệp tải lên, nếu không thiết lập, hệ thống sẽ phân loại thông minh riêng cho từng tệp.",
                autoRecognition: "Tự động nhận diện",
                versionNumber: "Số phiên bản",
                versionPlaceholder: "Ví dụ: A, A1, B, v.v. (áp dụng cho tất cả tệp)",
                selectedFiles: "Tệp đã chọn",
                uploadProgress: "Tiến trình tải lên",
                uploaded: "Đã tải lên:",
                total: "Tổng số:",
                batchFileDescription: "Mô tả tệp hàng loạt (tùy chọn)",
                descriptionPlaceholder: "Vui lòng nhập mô tả tệp (sẽ áp dụng cho tất cả tệp)...",
                analyzeAndUpload: "Phân tích thông minh và tải lên hàng loạt",
                
                // 部门名称
                allDepartments: "Tất cả phòng ban",
                quality: "Phòng chất lượng",
                production: "Phòng sản xuất",
                tech: "Phòng kỹ thuật",
                sales: "Phòng kinh doanh",
                admin: "Phòng hành chính",
                hr: "Phòng nhân sự",
                finance: "Phòng tài chính",
                environment: "Phòng môi trường",
                safety: "Phòng an toàn",
                purchase: "Phòng mua sắm",
                
                // 体系名称
                iso: "Hệ thống quản lý chất lượng ISO",
                iatf: "Ngành ô tô IATF16949",
                ohs: "Hệ thống an toàn sức khỏe nghề nghiệp",
                social: "Hệ thống trách nhiệm xã hội",
                iso14001: "Hệ thống môi trường ISO14001",
                other: "Hệ thống khác/Dự phòng",
                
                // 通知消息
                uploadSuccess: "Tải lên hàng loạt hoàn tất! Đã tải lên thành công {0} tệp",
                uploadFailed: "Tải lên thất bại, vui lòng thử lại",
                deleteSuccess: "Xóa tệp thành công",
                moveSuccess: "Di chuyển thành công {0} tệp",
                systemAdded: "Thêm loại hệ thống thành công",
                operationCancelled: "Thao tác đã hủy",
                noFilesSelected: "Vui lòng chọn tệp cần thao tác trước",
                confirmDelete: "Bạn có chắc chắn muốn xóa tệp này không? Không thể khôi phục sau khi xóa.",
                confirmBatchDelete: "Bạn có chắc chắn muốn xóa {0} tệp không? Thao tác này không thể khôi phục."
            }
        };
        
        // ISO分类规则
        const isoClassificationRules = {
            level1: {
                name: '管理手册',
                keywords: ['手册', '质量手册', '管理手册', 'manual', 'handbook', '体系手册', '环境手册', '安全手册', '社会责任手册'],
                patterns: ['手册', '管理手册', '体系手册'],
                description: '描述组织的方针、目标和体系的范围，包括质量、环境、安全等'
            },
            level2: {
                name: '程序文件',
                keywords: ['程序', '程序文件', '控制程序', '管理程序', 'procedure', '流程', '管理办法', '管理流程'],
                patterns: ['程序', '控制程序', '管理程序'],
                description: '描述跨部门的管理活动，规定谁、做什么、何时做'
            },
            level3: {
                name: '作业指导书',
                keywords: ['指导书', '作业指导书', '操作规程', '操作指导', 'instruction', '作业标准', '工艺卡片', '作业规范'],
                patterns: ['指导书', '操作规程', '作业指导'],
                description: '详细描述具体工作任务如何执行，指导具体操作'
            },
            level4: {
                name: '记录表单',
                keywords: ['记录', '表单', '表格', '记录表', '报表', '登记表', '检查表', 'record', 'form', '报告'],
                patterns: ['记录', '表单', '表格', '报告'],
                description: '提供客观证据，证明管理活动已按计划执行'
            }
        };
        
        // 部门信息 - 添加采购部
        const departments = [
            { id: 'all', name: '全部部门', icon: 'fa-layer-group' },
            { id: 'quality', name: '质量部', icon: 'fa-award' },
            { id: 'production', name: '生产部', icon: 'fa-industry' },
            { id: 'tech', name: '技术部', icon: 'fa-cogs' },
            { id: 'sales', name: '销售部', icon: 'fa-chart-line' },
            { id: 'admin', name: '行政部', icon: 'fa-desktop' },
            { id: 'hr', name: '人力资源部', icon: 'fa-users' },
            { id: 'finance', name: '财务部', icon: 'fa-chart-pie' },
            { id: 'environment', name: '环境部', icon: 'fa-leaf' },
            { id: 'safety', name: '安全部', icon: 'fa-shield-alt' },
            { id: 'purchase', name: '采购部', icon: 'fa-shopping-cart' }
        ];
        
        // 默认体系信息
        const defaultSystems = [
            { id: 'iso', name: 'ISO质量管理体系', icon: 'fa-certificate', color: '#54A0FF', keywords: ['质量', 'ISO9001', '质量管理', '品质', '质量体系'] },
            { id: 'iatf', name: 'IATF16949汽车行业', icon: 'fa-car', color: '#1DD1A1', keywords: ['汽车', 'IATF', '16949', '汽车行业', 'TS16949', '汽车质量'] },
            { id: 'ohs', name: '职业健康安全体系', icon: 'fa-heartbeat', color: '#FF9F43', keywords: ['安全', '职业健康', 'OHSAS', '安全生产', '职业安全', '健康安全'] },
            { id: 'social', name: '社会责任体系', icon: 'fa-handshake', color: '#9B59B6', keywords: ['社会责任', 'SA8000', '道德', '人权', '劳工', '社会责', 'CSR'] },
            { id: 'iso14001', name: 'ISO14001环境体系', icon: 'fa-leaf', color: '#1ABC9C', keywords: ['环境', 'ISO14001', '环保', '排放', '废物', '环境管理', '环境保护'] },
            { id: 'other', name: '其他体系/备用', icon: 'fa-archive', color: '#95A5A6', keywords: ['其他', '备用', '通用'] }
        ];
        
        // 部门分类规则 - 添加采购部规则
        const departmentClassificationRules = {
            quality: {
                keywords: ['质量', '检验', '测试', '标准', 'QC', 'QA', '质量管理', '质量检验', '品管'],
                patterns: ['质量', '检验', '测试']
            },
            production: {
                keywords: ['生产', '制造', '加工', '装配', '生产线', '工序', '生产计划', '生产管理', '车间'],
                patterns: ['生产', '制造', '加工']
            },
            tech: {
                keywords: ['技术', '研发', '设计', '开发', '工艺', '技术文件', '技术规范', '图纸', '工程'],
                patterns: ['技术', '研发', '设计']
            },
            sales: {
                keywords: ['销售', '市场', '客户', '合同', '订单', '营销', '销售管理', '市场分析', '客户服务'],
                patterns: ['销售', '市场', '客户']
            },
            admin: {
                keywords: ['行政', '管理', '办公', '行政事务', '行政管理', '办公管理', '后勤', '综合'],
                patterns: ['行政', '管理', '办公']
            },
            hr: {
                keywords: ['人力资源', '人事', '员工', '培训', '招聘', '薪酬', '绩效', '人力资源部', '人事部'],
                patterns: ['人力资源', '人事', '员工']
            },
            finance: {
                keywords: ['财务', '会计', '预算', '成本', '资金', '财务报表', '财务管理', '会计核算', '审计'],
                patterns: ['财务', '会计', '预算']
            },
            environment: {
                keywords: ['环境', '环保', '排放', '废物', '节能', '能源', '环境管理', '环境保护'],
                patterns: ['环境', '环保', '节能']
            },
            safety: {
                keywords: ['安全', '健康', '防护', '消防', '应急预案', '安全生产', '职业健康', '安全管理'],
                patterns: ['安全', '健康', '防护']
            },
            purchase: {
                keywords: ['采购', '购买', '供应商', '采购订单', '采购计划', '供应商管理', '采购管理', '供应商评估'],
                patterns: ['采购', '购买', '供应商']
            }
        };
        
        // 支持预览的文件类型
        const previewableFormats = {
            'pdf': { type: 'pdf', icon: 'fa-file-pdf', name: 'PDF文档', preview: true },
            'jpg': { type: 'image', icon: 'fa-file-image', name: '图片文件', preview: true },
            'jpeg': { type: 'image', icon: 'fa-file-image', name: '图片文件', preview: true },
            'png': { type: 'image', icon: 'fa-file-image', name: '图片文件', preview: true },
            'gif': { type: 'image', icon: 'fa-file-image', name: '图片文件', preview: true },
            'txt': { type: 'text', icon: 'fa-file-alt', name: '文本文件', preview: true },
            'doc': { type: 'office', icon: 'fa-file-word', name: 'Word文档', preview: true },
            'docx': { type: 'office', icon: 'fa-file-word', name: 'Word文档', preview: true },
            'xls': { type: 'office', icon: 'fa-file-excel', name: 'Excel文件', preview: true },
            'xlsx': { type: 'office', icon: 'fa-file-excel', name: 'Excel文件', preview: true }
        };
        
        // 初始化数据库
        function initDatabase() {
            const request = indexedDB.open('ISOFilesPreviewDB', 10); // 版本号增加到10
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                
                // 创建文件存储
                if (!db.objectStoreNames.contains('files')) {
                    const store = db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('level', 'level', { unique: false });
                    store.createIndex('department', 'department', { unique: false });
                    store.createIndex('system', 'system', { unique: false });
                    store.createIndex('name', 'name', { unique: false });
                }
                
                // 创建自定义体系存储
                if (!db.objectStoreNames.contains('customSystems')) {
                    const systemStore = db.createObjectStore('customSystems', { keyPath: 'id', autoIncrement: true });
                    systemStore.createIndex('name', 'name', { unique: true });
                }
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('数据库初始化成功');
                loadCustomSystems(); // 加载自定义体系
                initDepartments();
                loadFiles();
                
                // 加载示例数据
                setTimeout(() => {
                    loadSampleData();
                }, 1000);
            };
            
            request.onerror = function(event) {
                console.error('数据库初始化失败:', event.target.error);
            };
        }
        
        // 语言切换功能
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'zh' ? 'vi' : 'zh';
            document.getElementById('languageText').textContent = currentLanguage === 'zh' ? 'Tiếng Việt' : '中文';
            updateLanguage();
        }
        
        // 更新语言
        function updateLanguage() {
            const lang = translations[currentLanguage];
            
            // 更新所有带有data-i18n属性的元素
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (lang[key]) {
                    // 处理占位符
                    let text = lang[key];
                    if (text.includes('{0}') || text.includes('{1}')) {
                        // 如果有占位符，暂时不处理（由具体函数处理）
                        return;
                    }
                    element.textContent = text;
                }
            });
            
            // 更新占位符
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (lang[key]) {
                    element.placeholder = lang[key];
                }
            });
            
            // 更新选项文本
            document.querySelectorAll('option[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (lang[key]) {
                    element.textContent = lang[key];
                }
            });
            
            // 更新部门列表
            updateDepartmentList();
            
            // 更新体系筛选
            updateSystemFilter();
            
            // 更新下拉选择框
            updateSelectOptions();
            
            // 重新加载文件列表以更新翻译
            if (filteredFiles.length > 0) {
                displayFilesForPage();
            }
        }
        
        // 更新部门列表
        function updateDepartmentList() {
            const departmentList = document.getElementById('departmentList');
            if (!departmentList) return;
            
            departmentList.innerHTML = '';
            const lang = translations[currentLanguage];
            
            departments.forEach(dept => {
                const li = document.createElement('li');
                li.className = `department-item ${dept.id === 'all' ? 'active' : ''}`;
                li.dataset.department = dept.id;
                
                const deptName = lang[dept.id] || dept.name;
                li.innerHTML = `
                    <span class="department-icon"><i class="fas ${dept.icon}"></i></span>
                    <span>${deptName}</span>
                `;
                li.onclick = () => switchDepartment(dept.id);
                departmentList.appendChild(li);
            });
        }
        
        // 更新体系筛选
        function updateSystemFilter() {
            const systemFilter = document.getElementById('systemFilter');
            if (!systemFilter) return;
            
            systemFilter.innerHTML = '';
            const lang = translations[currentLanguage];
            
            // 添加默认体系
            defaultSystems.forEach(system => {
                const checkbox = document.createElement('label');
                checkbox.className = 'system-checkbox';
                
                const systemName = lang[system.id] || system.name;
                checkbox.innerHTML = `
                    <input type="checkbox" id="${system.id}Filter" checked>
                    <span>${systemName}</span>
                `;
                systemFilter.appendChild(checkbox);
                
                // 添加事件监听
                document.getElementById(`${system.id}Filter`).addEventListener('change', loadFiles);
            });
            
            // 添加自定义体系
            customSystems.forEach(system => {
                const checkbox = document.createElement('label');
                checkbox.className = 'system-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="${system.id}Filter" checked>
                    <span>${system.name}</span>
                `;
                systemFilter.appendChild(checkbox);
                
                // 添加事件监听
                document.getElementById(`${system.id}Filter`).addEventListener('change', loadFiles);
            });
        }
        
        // 更新下拉选择框
        function updateSelectOptions() {
            const lang = translations[currentLanguage];
            
            // 更新部门选择框
            const moveDeptSelect = document.getElementById('moveDepartment');
            const batchDeptSelect = document.getElementById('batchDepartment');
            
            if (moveDeptSelect) {
                // 保存当前值
                const moveDeptValue = moveDeptSelect.value;
                moveDeptSelect.innerHTML = `<option value="" data-i18n="keepOriginal">${lang.keepOriginal}</option>`;
                
                departments.forEach(dept => {
                    if (dept.id !== 'all') {
                        const deptName = lang[dept.id] || dept.name;
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = deptName;
                        moveDeptSelect.appendChild(option);
                    }
                });
                
                // 恢复之前的值
                moveDeptSelect.value = moveDeptValue;
            }
            
            if (batchDeptSelect) {
                // 保存当前值
                const batchDeptValue = batchDeptSelect.value;
                batchDeptSelect.innerHTML = `<option value="auto" data-i18n="autoRecognition">${lang.autoRecognition}</option>`;
                
                departments.forEach(dept => {
                    if (dept.id !== 'all') {
                        const deptName = lang[dept.id] || dept.name;
                        const option = document.createElement('option');
                        option.value = dept.id;
                        option.textContent = deptName;
                        batchDeptSelect.appendChild(option);
                    }
                });
                
                // 恢复之前的值
                batchDeptSelect.value = batchDeptValue;
            }
            
            // 更新体系选择框
            updateSystemSelects();
        }
        
        // 加载自定义体系
        function loadCustomSystems() {
            return new Promise((resolve) => {
                const transaction = db.transaction(['customSystems'], 'readonly');
                const store = transaction.objectStore('customSystems');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    customSystems = request.result || [];
                    console.log('加载自定义体系:', customSystems.length);
                    // 初始化体系筛选和统计
                    updateSystemFilter();
                    updateSystemSelects();
                    resolve();
                };
                
                request.onerror = function() {
                    console.error('加载自定义体系失败');
                    customSystems = [];
                    updateSystemFilter();
                    updateSystemSelects();
                    resolve();
                };
            });
        }
        
        // 更新体系选择下拉框
        function updateSystemSelects() {
            const moveSystemSelect = document.getElementById('moveSystem');
            const batchSystemSelect = document.getElementById('batchSystem');
            const lang = translations[currentLanguage];
            
            if (moveSystemSelect) {
                // 保存当前值
                const moveSystemValue = moveSystemSelect.value;
                moveSystemSelect.innerHTML = `<option value="" data-i18n="keepOriginal">${lang.keepOriginal}</option>`;
                
                // 添加默认体系
                defaultSystems.forEach(system => {
                    const systemName = lang[system.id] || system.name;
                    const option = document.createElement('option');
                    option.value = system.id;
                    option.textContent = systemName;
                    moveSystemSelect.appendChild(option);
                });
                
                // 添加自定义体系
                customSystems.forEach(system => {
                    const option = document.createElement('option');
                    option.value = system.id;
                    option.textContent = system.name;
                    moveSystemSelect.appendChild(option);
                });
                
                // 恢复之前的值
                moveSystemSelect.value = moveSystemValue;
            }
            
            if (batchSystemSelect) {
                // 保存当前值
                const batchSystemValue = batchSystemSelect.value;
                batchSystemSelect.innerHTML = `<option value="auto" data-i18n="autoRecognition">${lang.autoRecognition}</option>`;
                
                // 添加默认体系
                defaultSystems.forEach(system => {
                    const systemName = lang[system.id] || system.name;
                    const option = document.createElement('option');
                    option.value = system.id;
                    option.textContent = systemName;
                    batchSystemSelect.appendChild(option);
                });
                
                // 添加自定义体系
                customSystems.forEach(system => {
                    const option = document.createElement('option');
                    option.value = system.id;
                    option.textContent = system.name;
                    batchSystemSelect.appendChild(option);
                });
                
                // 恢复之前的值
                batchSystemSelect.value = batchSystemValue;
            }
        }
        
        // 获取所有体系（默认+自定义）
        function getAllSystems() {
            return [...defaultSystems, ...customSystems];
        }
        
        // 获取体系名称（带语言支持）
        function getSystemName(systemId) {
            const allSystems = getAllSystems();
            const system = allSystems.find(s => s.id === systemId);
            if (system) {
                const lang = translations[currentLanguage];
                return lang[system.id] || system.name;
            }
            return systemId;
        }
        
        // 获取部门名称（带语言支持）
        function getDepartmentName(deptId) {
            const dept = departments.find(d => d.id === deptId);
            if (dept) {
                const lang = translations[currentLanguage];
                return lang[dept.id] || dept.name;
            }
            return deptId;
        }
        
        // 获取体系颜色
        function getSystemColor(systemId) {
            const allSystems = getAllSystems();
            const system = allSystems.find(s => s.id === systemId);
            return system ? system.color : '#95A5A6';
        }
        
        // 打开上传模态框
        function openUploadModal() {
            console.log('打开上传模态框');
            document.getElementById('uploadModal').style.display = 'flex';
            
            // 重置上传列表
            clearUploadList();
            
            // 重置批量分类设置
            document.getElementById('batchSystem').value = 'auto';
            document.getElementById('batchDepartment').value = 'auto';
            document.getElementById('batchVersion').value = '';
            document.getElementById('uploadDescription').value = '';
            
            // 隐藏进度条
            document.getElementById('uploadProgress').style.display = 'none';
            
            // 收起批量分类设置
            const batchContent = document.getElementById('batchClassificationContent');
            batchContent.classList.remove('show');
            document.getElementById('batchToggleIcon').className = 'fas fa-chevron-down';
            batchContent.previousElementSibling.querySelector('span').textContent = translations[currentLanguage].clickToExpand;
            
            // 确保文件输入已重置
            document.getElementById('fileInput').value = '';
            document.getElementById('folderInput').value = '';
        }
        
        // 打开添加体系类型模态框
        function openAddSystemModal() {
            document.getElementById('addSystemModal').style.display = 'flex';
            
            // 重置表单
            document.getElementById('newSystemName').value = '';
            document.getElementById('newSystemColor').value = '#3498db';
            document.getElementById('colorPreview').style.backgroundColor = '#3498db';
            document.getElementById('newSystemIcon').value = 'fa-certificate';
            document.getElementById('newSystemKeywords').value = '';
            
            // 监听颜色变化
            document.getElementById('newSystemColor').addEventListener('input', function() {
                document.getElementById('colorPreview').style.backgroundColor = this.value;
            });
        }
        
        // 关闭添加体系类型模态框
        function closeAddSystemModal() {
            document.getElementById('addSystemModal').style.display = 'none';
        }
        
        // 保存新体系类型
        function saveNewSystem() {
            const name = document.getElementById('newSystemName').value.trim();
            const color = document.getElementById('newSystemColor').value;
            const icon = document.getElementById('newSystemIcon').value;
            const keywords = document.getElementById('newSystemKeywords').value.trim();
            
            if (!name) {
                showNotification(translations[currentLanguage].systemNamePlaceholder, 'error');
                return;
            }
            
            // 生成ID（基于名称的简化版）
            const id = 'custom_' + name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            
            // 检查是否已存在相同名称的体系
            const allSystems = getAllSystems();
            if (allSystems.some(s => s.name === name)) {
                showNotification('体系名称已存在，请使用不同的名称', 'error');
                return;
            }
            
            const newSystem = {
                id: id,
                name: name,
                color: color,
                icon: icon,
                keywords: keywords ? keywords.split(',').map(k => k.trim()) : [],
                isCustom: true,
                created: new Date().toISOString()
            };
            
            // 保存到数据库
            const transaction = db.transaction(['customSystems'], 'readwrite');
            const store = transaction.objectStore('customSystems');
            store.add(newSystem);
            
            transaction.oncomplete = function() {
                showNotification(translations[currentLanguage].systemAdded, 'success');
                closeAddSystemModal();
                
                // 重新加载体系并更新界面
                loadCustomSystems().then(() => {
                    // 重新加载文件以更新体系统计
                    loadFiles();
                });
            };
            
            transaction.onerror = function() {
                showNotification('保存失败，请重试', 'error');
            };
        }
        
        // 切换批量分类设置显示/隐藏
        function toggleBatchClassification() {
            const content = document.getElementById('batchClassificationContent');
            const icon = document.getElementById('batchToggleIcon');
            const lang = translations[currentLanguage];
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.className = 'fas fa-chevron-down';
                content.previousElementSibling.querySelector('span').textContent = lang.clickToExpand;
            } else {
                content.classList.add('show');
                icon.className = 'fas fa-chevron-up';
                content.previousElementSibling.querySelector('span').textContent = lang.clickToExpand.replace('展开', '收起');
            }
        }
        
        // 处理多文件选择
        function handleFilesSelect(event) {
            const files = Array.from(event.target.files);
            addFilesToUploadList(files);
        }
        
        // 处理文件夹选择
        function handleFolderSelect(event) {
            const files = Array.from(event.target.files);
            addFilesToUploadList(files);
        }
        
        // 添加文件到上传列表
        function addFilesToUploadList(files) {
            // 过滤掉不支持的格式（可选）
            const supportedFiles = files.filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return previewableFormats[ext] || true; // 暂时允许所有文件
            });
            
            // 添加到选中的文件列表
            selectedFiles = [...selectedFiles, ...supportedFiles];
            
            // 更新显示
            updateUploadListDisplay();
        }
        
        // 更新上传列表显示
        function updateUploadListDisplay() {
            const selectedFilesInfo = document.getElementById('selectedFilesInfo');
            const uploadFilesList = document.getElementById('uploadFilesList');
            const selectedFilesCount = document.getElementById('selectedFilesCount');
            
            if (selectedFiles.length === 0) {
                selectedFilesInfo.style.display = 'none';
                return;
            }
            
            selectedFilesInfo.style.display = 'block';
            selectedFilesCount.textContent = selectedFiles.length;
            
            // 清空列表
            uploadFilesList.innerHTML = '';
            
            // 添加文件项
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'upload-file-item';
                fileItem.dataset.index = index;
                
                // 获取文件图标
                const ext = file.name.split('.').pop().toLowerCase();
                const format = previewableFormats[ext] || { icon: 'fa-file', name: '文件' };
                
                // 计算文件大小
                const size = formatFileSize(file.size);
                
                fileItem.innerHTML = `
                    <div class="upload-file-info">
                        <div class="upload-file-icon">
                            <i class="fas ${format.icon}"></i>
                        </div>
                        <div style="flex: 1;">
                            <div class="upload-file-name">${file.name}</div>
                            <div class="upload-file-size">${size}</div>
                        </div>
                    </div>
                    <div class="upload-file-status pending">${currentLanguage === 'zh' ? '待上传' : 'Chờ tải lên'}</div>
                    <button class="upload-file-remove" onclick="removeFileFromList(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                uploadFilesList.appendChild(fileItem);
            });
        }
        
        // 从上传列表中移除文件
        function removeFileFromList(index) {
            selectedFiles.splice(index, 1);
            updateUploadListDisplay();
        }
        
        // 清空上传列表
        function clearUploadList() {
            selectedFiles = [];
            updateUploadListDisplay();
            document.getElementById('uploadProgress').style.display = 'none';
        }
        
        // 智能分析并批量上传
        async function analyzeAndUploadAll() {
            if (selectedFiles.length === 0) {
                showNotification(translations[currentLanguage].noFilesSelected, 'error');
                return;
            }
            
            // 获取批量设置
            const batchSystem = document.getElementById('batchSystem').value;
            const batchDepartment = document.getElementById('batchDepartment').value;
            const batchVersion = document.getElementById('batchVersion').value;
            const batchDescription = document.getElementById('uploadDescription').value;
            
            // 显示上传进度
            const uploadProgress = document.getElementById('uploadProgress');
            uploadProgress.style.display = 'block';
            
            // 重置上传计数
            uploadedCount = 0;
            isUploading = true;
            
            // 更新进度显示
            updateUploadProgress();
            
            // 创建上传队列
            uploadQueue = [];
            
            // 为每个文件创建上传任务
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const fileInfo = {
                    file: file,
                    index: i,
                    status: 'pending',
                    classification: null,
                    batchSettings: {
                        system: batchSystem,
                        department: batchDepartment,
                        version: batchVersion,
                        description: batchDescription
                    }
                };
                
                uploadQueue.push(fileInfo);
            }
            
            // 开始处理队列
            processUploadQueue();
        }
        
        // 处理上传队列
        async function processUploadQueue() {
            if (uploadQueue.length === 0) {
                // 所有文件处理完成
                isUploading = false;
                const message = translations[currentLanguage].uploadSuccess.replace('{0}', uploadedCount);
                showNotification(message, 'success');
                
                // 关闭模态框并重新加载文件列表
                setTimeout(() => {
                    closeModal();
                    loadFiles();
                }, 2000);
                return;
            }
            
            // 获取下一个文件
            const fileInfo = uploadQueue.shift();
            const file = fileInfo.file;
            const index = fileInfo.index;
            
            // 更新文件状态为分析中
            updateFileStatus(index, 'analyzing');
            
            try {
                // 智能分类分析
                let classificationResult = await classifyFile(file);
                
                // 应用批量设置（如果设置了）
                if (fileInfo.batchSettings) {
                    const batch = fileInfo.batchSettings;
                    
                    if (batch.system && batch.system !== 'auto') {
                        classificationResult.system = batch.system;
                        classificationResult.systemName = getSystemName(batch.system);
                    }
                    
                    if (batch.department && batch.department !== 'auto') {
                        classificationResult.department = batch.department;
                        classificationResult.departmentName = getDepartmentName(batch.department);
                    }
                    
                    // 应用版本和描述
                    if (batch.version) {
                        classificationResult.version = batch.version;
                    }
                    
                    if (batch.description) {
                        classificationResult.description = batch.description;
                    }
                }
                
                // 保存分类结果
                fileInfo.classification = classificationResult;
                
                // 保存文件到数据库
                await saveFileToDB(
                    file, 
                    classificationResult, 
                    fileInfo.batchSettings?.system || classificationResult.system,
                    fileInfo.batchSettings?.description || classificationResult.isoLevelName,
                    fileInfo.batchSettings?.version || 'A'
                );
                
                // 更新文件状态为完成
                updateFileStatus(index, 'ready');
                uploadedCount++;
                
                // 更新进度
                updateUploadProgress();
                
                // 继续处理下一个文件
                setTimeout(() => {
                    processUploadQueue();
                }, 100); // 添加小的延迟以避免阻塞UI
                
            } catch (error) {
                console.error('文件处理失败:', error);
                updateFileStatus(index, 'error');
                
                // 继续处理下一个文件（即使这个失败了）
                setTimeout(() => {
                    processUploadQueue();
                }, 100);
            }
        }
        
        // 更新文件状态
        function updateFileStatus(index, status) {
            const fileItems = document.querySelectorAll('.upload-file-item');
            if (fileItems[index]) {
                const statusElement = fileItems[index].querySelector('.upload-file-status');
                const statusText = {
                    'pending': currentLanguage === 'zh' ? '待上传' : 'Chờ tải lên',
                    'analyzing': currentLanguage === 'zh' ? '分析中' : 'Đang phân tích',
                    'ready': currentLanguage === 'zh' ? '已完成' : 'Đã hoàn thành',
                    'error': currentLanguage === 'zh' ? '失败' : 'Thất bại'
                };
                statusElement.textContent = statusText[status] || status;
                statusElement.className = `upload-file-status ${status}`;
            }
        }
        
        // 更新上传进度
        function updateUploadProgress() {
            const total = selectedFiles.length;
            const percentage = total > 0 ? Math.round((uploadedCount / total) * 100) : 0;
            
            document.getElementById('uploadPercentage').textContent = `${percentage}%`;
            document.getElementById('uploadProgressBar').style.width = `${percentage}%`;
            
            const lang = translations[currentLanguage];
            document.getElementById('uploadedCount').textContent = `${lang.uploaded} ${uploadedCount}`;
            document.getElementById('totalFilesCount').textContent = `${lang.total} ${total}`;
        }
        
        // 智能分类文件
        async function classifyFile(file) {
            const fileName = file.name.toLowerCase();
            
            // 分析ISO级别
            let isoLevel = 0;
            let isoConfidence = 0;
            let isoReason = '';
            let isoKeywords = [];
            
            Object.entries(isoClassificationRules).forEach(([levelKey, rule]) => {
                let score = 0;
                const foundKeywords = [];
                
                // 检查关键词
                rule.keywords.forEach(keyword => {
                    if (fileName.includes(keyword.toLowerCase())) {
                        score += 2;
                        foundKeywords.push(keyword);
                    }
                });
                
                // 检查模式
                rule.patterns.forEach(pattern => {
                    const regex = new RegExp(pattern, 'i');
                    if (regex.test(fileName)) {
                        score += 3;
                        foundKeywords.push(pattern);
                    }
                });
                
                // 文件类型权重
                const ext = file.name.split('.').pop().toLowerCase();
                if (ext === 'pdf' && levelKey === 'level1') {
                    score += 1;
                } else if ((ext === 'doc' || ext === 'docx') && levelKey === 'level2') {
                    score += 1;
                } else if (ext === 'xlsx' && levelKey === 'level4') {
                    score += 1;
                }
                
                if (score > isoConfidence) {
                    isoConfidence = score;
                    isoLevel = parseInt(levelKey.replace('level', ''));
                    isoReason = rule.description;
                    isoKeywords = foundKeywords;
                }
            });
            
            // 分析部门
            let department = 'admin'; // 默认为行政部
            let deptConfidence = 0;
            let deptReason = '';
            let deptKeywords = [];
            
            Object.entries(departmentClassificationRules).forEach(([deptId, rule]) => {
                let score = 0;
                const foundKeywords = [];
                
                // 检查关键词
                rule.keywords.forEach(keyword => {
                    if (fileName.includes(keyword.toLowerCase())) {
                        score += 2;
                        foundKeywords.push(keyword);
                    }
                });
                
                // 检查模式
                rule.patterns.forEach(pattern => {
                    const regex = new RegExp(pattern, 'i');
                    if (regex.test(fileName)) {
                        score += 3;
                        foundKeywords.push(pattern);
                    }
                });
                
                if (score > deptConfidence) {
                    deptConfidence = score;
                    department = deptId;
                    deptReason = `文件名包含部门相关关键词`;
                    deptKeywords = foundKeywords;
                }
            });
            
            // 分析体系类型
            let systemType = 'iso'; // 默认为ISO体系
            let systemConfidence = 0;
            let systemReason = '';
            let systemKeywords = [];
            
            // 检查默认体系
            defaultSystems.forEach(system => {
                let score = 0;
                const foundKeywords = [];
                
                // 检查关键词
                system.keywords.forEach(keyword => {
                    if (fileName.includes(keyword.toLowerCase())) {
                        score += 2;
                        foundKeywords.push(keyword);
                    }
                });
                
                if (score > systemConfidence) {
                    systemConfidence = score;
                    systemType = system.id;
                    systemReason = `文件名包含体系相关关键词`;
                    systemKeywords = foundKeywords;
                }
            });
            
            // 检查自定义体系
            customSystems.forEach(system => {
                let score = 0;
                const foundKeywords = [];
                
                // 检查关键词
                if (system.keywords && system.keywords.length > 0) {
                    system.keywords.forEach(keyword => {
                        if (fileName.includes(keyword.toLowerCase())) {
                            score += 2;
                            foundKeywords.push(keyword);
                        }
                    });
                }
                
                if (score > systemConfidence) {
                    systemConfidence = score;
                    systemType = system.id;
                    systemReason = `文件名包含自定义体系相关关键词`;
                    systemKeywords = foundKeywords;
                }
            });
            
            // 计算总体置信度
            const totalConfidence = Math.min(0.95, (isoConfidence + deptConfidence + systemConfidence) / 30);
            
            return {
                level: isoLevel,
                department: department,
                system: systemType,
                confidence: totalConfidence,
                isoKeywords: isoKeywords,
                deptKeywords: deptKeywords,
                systemKeywords: systemKeywords,
                isoReason: isoReason,
                deptReason: deptReason,
                systemReason: systemReason,
                isoLevelName: getLevelName(isoLevel),
                departmentName: getDepartmentName(department),
                systemName: getSystemName(systemType)
            };
        }
        
        // 保存文件到数据库
        function saveFileToDB(file, classification, system, description, version) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    let fileData = e.target.result;
                    
                    // 对PDF文件进行特殊处理
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (ext === 'pdf') {
                        // 确保PDF数据是有效的Base64
                        if (!fileData.startsWith('data:application/pdf')) {
                            // 如果不是Data URL格式，重新构建
                            fileData = 'data:application/pdf;base64,' + btoa(e.target.result);
                        }
                    }
                    
                    const fileDataObj = {
                        name: file.name,
                        level: classification.level,
                        department: classification.department,
                        system: system,
                        description: description || `智能分类: ${classification.isoLevelName}`,
                        version: version || 'A',
                        size: file.size,
                        uploadDate: new Date().toLocaleDateString('zh-CN'),
                        classificationConfidence: classification.confidence,
                        classificationReason: `ISO级别: ${classification.isoLevelName}, 部门: ${classification.departmentName}, 体系: ${classification.systemName}`,
                        isLatest: true,
                        lastModified: new Date().toISOString(),
                        data: fileData,
                        previewable: checkPreviewable(file.name)
                    };
                    
                    const transaction = db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    store.add(fileDataObj);
                    
                    transaction.oncomplete = function() {
                        resolve();
                    };
                    
                    transaction.onerror = function() {
                        reject();
                    };
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        // 检查文件是否可预览
        function checkPreviewable(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const format = previewableFormats[ext];
            return format ? format.preview : false;
        }
        
        // 预览文件
        function previewFile(id) {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const file = request.result;
                if (!file) {
                    showNotification('文件不存在', 'error');
                    return;
                }
                
                currentPreviewFile = file;
                openPreview(file);
            };
        }
        
        // 打开预览
        function openPreview(file) {
            document.getElementById('previewModal').style.display = 'flex';
            document.getElementById('previewLoading').style.display = 'flex';
            document.getElementById('previewToolbar').style.display = 'none';
            document.getElementById('previewFileInfo').style.display = 'none';
            
            // 设置预览标题
            document.getElementById('previewTitle').innerHTML = `<i class="fas fa-file"></i> ${file.name}`;
            
            // 清空预览区域
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            previewArea.appendChild(document.getElementById('previewLoading'));
            
            // 获取文件扩展名
            const ext = file.name.split('.').pop().toLowerCase();
            const format = previewableFormats[ext];
            
            // 显示文件信息
            displayFileInfo(file);
            
            // 根据文件类型显示预览
            if (file.data) {
                if (format && format.preview) {
                    if (format.type === 'pdf') {
                        previewPDF(file);
                    } else if (format.type === 'image') {
                        previewImage(file);
                    } else if (format.type === 'text') {
                        previewText(file);
                    } else if (format.type === 'office') {
                        // Word和Excel文件使用Google Docs Viewer预览
                        previewOfficeFile(file, ext);
                    } else {
                        showUnsupportedPreview();
                    }
                } else {
                    showUnsupportedPreview();
                }
            } else {
                showUnsupportedPreview();
            }
        }
        
        // 关闭预览
        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
            currentPreviewFile = null;
            currentZoom = 1.0;
            currentPage = 1;
        }
        
        // 下载当前预览的文件
        function downloadCurrentPreview() {
            if (currentPreviewFile) {
                downloadFileById(currentPreviewFile.id);
            }
        }
        
        // 关闭模态框
        function closeModal() {
            document.getElementById('uploadModal').style.display = 'none';
            document.getElementById('classificationResult').classList.remove('show');
            document.getElementById('manualAdjustment').style.display = 'none';
            classificationData = null;
            filesForUpload = null;
        }
        
        // 显示通知
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            
            // 设置图标
            let icon = '';
            if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';
            else if (type === 'error') icon = '<i class="fas fa-exclamation-circle"></i>';
            else icon = '<i class="fas fa-info-circle"></i>';
            
            notification.innerHTML = `${icon} ${message}`;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // ==================== 新增功能 ====================
        
        // 1. 文件移动功能
        function moveFile(id) {
            // 进入批量选择模式，只选择当前文件
            selectedFileIds.clear();
            selectedFileIds.add(id);
            openMoveModal();
        }
        
        // 打开文件移动模态框
        function openMoveModal() {
            // 更新选中文件列表
            updateMoveSelectedFiles();
            
            // 显示模态框
            document.getElementById('moveModal').style.display = 'flex';
        }
        
        // 关闭文件移动模态框
        function closeMoveModal() {
            document.getElementById('moveModal').style.display = 'none';
            selectedFileIds.clear();
            updateSelectedCount();
        }
        
        // 更新移动模态框中的选中文件列表
        function updateMoveSelectedFiles() {
            const container = document.getElementById('moveSelectedFiles');
            container.innerHTML = '';
            
            if (selectedFileIds.size === 0) {
                const lang = translations[currentLanguage];
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">' + (currentLanguage === 'zh' ? '未选择任何文件' : 'Chưa chọn tệp nào') + '</p>';
                return;
            }
            
            // 获取选中的文件信息
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            
            selectedFileIds.forEach(id => {
                const request = store.get(id);
                request.onsuccess = function() {
                    const file = request.result;
                    if (file) {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'move-file-item';
                        fileItem.innerHTML = `
                            <strong>${file.name}</strong>
                            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 3px;">
                                ${getLevelName(file.level)} | ${getDepartmentName(file.department)} | ${getSystemName(file.system)}
                            </div>
                        `;
                        container.appendChild(fileItem);
                    }
                };
            });
        }
        
        // 应用移动操作
        function applyMove() {
            const newLevel = document.getElementById('moveLevel').value;
            const newDepartment = document.getElementById('moveDepartment').value;
            const newSystem = document.getElementById('moveSystem').value;
            const reason = document.getElementById('moveReason').value || translations[currentLanguage].moveReasonPlaceholder;
            
            if (selectedFileIds.size === 0) {
                showNotification(translations[currentLanguage].noFilesSelected, 'error');
                return;
            }
            
            // 确认操作
            const confirmMessage = translations[currentLanguage].confirmBatchDelete.replace('{0}', selectedFileIds.size);
            if (!confirm(confirmMessage)) {
                return;
            }
            
            let movedCount = 0;
            
            // 更新每个选中的文件
            selectedFileIds.forEach(id => {
                const transaction = db.transaction(['files'], 'readwrite');
                const store = transaction.objectStore('files');
                const request = store.get(id);
                
                request.onsuccess = function() {
                    const file = request.result;
                    if (file) {
                        // 更新文件信息
                        if (newLevel) file.level = parseInt(newLevel);
                        if (newDepartment) file.department = newDepartment;
                        if (newSystem) file.system = newSystem;
                        
                        // 记录移动历史
                        file.moveHistory = file.moveHistory || [];
                        file.moveHistory.push({
                            date: new Date().toISOString(),
                            oldLevel: file.level,
                            oldDepartment: file.department,
                            oldSystem: file.system,
                            reason: reason
                        });
                        
                        // 保存更新
                        const updateRequest = store.put(file);
                        
                        updateRequest.onsuccess = function() {
                            movedCount++;
                            
                            // 如果所有文件都更新完成
                            if (movedCount === selectedFileIds.size) {
                                const message = translations[currentLanguage].moveSuccess.replace('{0}', movedCount);
                                showNotification(message, 'success');
                                closeMoveModal();
                                loadFiles(); // 重新加载文件列表
                            }
                        };
                    }
                };
            });
        }
        
        // 2. 批量删除功能
        function batchDeleteSelected() {
            if (selectedFileIds.size === 0) {
                showNotification(translations[currentLanguage].noFilesSelected, 'error');
                return;
            }
            
            const confirmMessage = translations[currentLanguage].confirmBatchDelete.replace('{0}', selectedFileIds.size);
            if (!confirm(confirmMessage)) {
                return;
            }
            
            let deletedCount = 0;
            
            selectedFileIds.forEach(id => {
                const transaction = db.transaction(['files'], 'readwrite');
                const store = transaction.objectStore('files');
                store.delete(id);
                
                transaction.oncomplete = function() {
                    deletedCount++;
                    
                    // 如果所有文件都删除完成
                    if (deletedCount === selectedFileIds.size) {
                        showNotification(translations[currentLanguage].deleteSuccess, 'success');
                        exitBatchMode();
                        loadFiles(); // 重新加载文件列表
                    }
                };
            });
        }
        
        // 3. 批量移动功能
        function batchMoveSelected() {
            if (selectedFileIds.size === 0) {
                showNotification(translations[currentLanguage].noFilesSelected, 'error');
                return;
            }
            
            openMoveModal();
        }
        
        // 4. 批量选择模式
        function toggleBatchMode() {
            batchSelectionMode = !batchSelectionMode;
            
            if (batchSelectionMode) {
                // 进入批量选择模式
                document.getElementById('filesTable').classList.add('batch-selection-mode');
                document.getElementById('batchControls').style.display = 'flex';
                document.getElementById('batchModeInfo').style.display = 'flex';
                
                // 清空之前的选中
                selectedFileIds.clear();
                updateSelectedCount();
                
                // 更新表格，添加复选框
                updateFilesTableForBatchMode();
                
                showNotification(translations[currentLanguage].batchModeEnabled, 'info');
            } else {
                // 退出批量选择模式
                exitBatchMode();
            }
        }
        
        // 退出批量选择模式
        function exitBatchMode() {
            batchSelectionMode = false;
            selectedFileIds.clear();
            
            document.getElementById('filesTable').classList.remove('batch-selection-mode');
            document.getElementById('batchControls').style.display = 'none';
            document.getElementById('batchModeInfo').style.display = 'none';
            
            // 重新加载文件列表，移除复选框
            displayFilesForPage();
        }
        
        // 更新表格以支持批量选择模式
        function updateFilesTableForBatchMode() {
            const container = document.getElementById('filesTableBody');
            const rows = container.querySelectorAll('tr');
            
            rows.forEach((row, index) => {
                // 获取文件ID
                const fileId = row.dataset.fileId;
                if (!fileId) return;
                
                // 在第一列添加复选框
                const firstCell = row.querySelector('td:first-child');
                if (firstCell && !firstCell.querySelector('.batch-checkbox')) {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'batch-checkbox';
                    checkbox.checked = selectedFileIds.has(parseInt(fileId));
                    checkbox.onchange = function() {
                        if (this.checked) {
                            selectedFileIds.add(parseInt(fileId));
                        } else {
                            selectedFileIds.delete(parseInt(fileId));
                        }
                        updateSelectedCount();
                    };
                    
                    firstCell.innerHTML = '';
                    firstCell.appendChild(checkbox);
                }
            });
        }
        
        // 更新选中文件计数
        function updateSelectedCount() {
            const lang = translations[currentLanguage];
            document.getElementById('selectedCount').innerHTML = `<span data-i18n="selected">${lang.selected}</span>: <span>${selectedFileIds.size}</span> <span data-i18n="files">${lang.files}</span>`;
        }
        
        // 分页功能
        
        // 转到指定页
        function goToPage(page) {
            if (page < 1 || page > totalPages) return;
            
            currentFilePage = page;
            displayFilesForPage();
            updatePaginationControls();
        }
        
        // 转到上一页
        function goToPrevPage() {
            goToPage(currentFilePage - 1);
        }
        
        // 转到下一页
        function goToNextPage() {
            goToPage(currentFilePage + 1);
        }
        
        // 转到最后一页
        function goToLastPage() {
            goToPage(totalPages);
        }
        
        // 更新分页控件
        function updatePaginationControls() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const firstPageBtn = document.getElementById('firstPage');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const lastPageBtn = document.getElementById('lastPage');
            
            // 更新页面信息
            const lang = translations[currentLanguage];
            const pageText = lang.pageInfo.replace('{0}', currentFilePage).replace('{1}', totalPages);
            pageInfo.textContent = pageText;
            
            // 更新按钮状态
            firstPageBtn.disabled = currentFilePage === 1;
            prevPageBtn.disabled = currentFilePage === 1;
            nextPageBtn.disabled = currentFilePage === totalPages;
            lastPageBtn.disabled = currentFilePage === totalPages;
            
            // 如果有多个页面，显示分页控件
            if (totalPages > 1) {
                pagination.style.display = 'flex';
            } else {
                pagination.style.display = 'none';
            }
        }
        
        // 显示当前页的文件
        function displayFilesForPage() {
            const container = document.getElementById('filesTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredFiles.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('fileCount').textContent = '0';
                document.getElementById('currentPage').textContent = '1';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            // 计算当前页的文件
            const startIndex = (currentFilePage - 1) * filesPerPage;
            const endIndex = Math.min(startIndex + filesPerPage, filteredFiles.length);
            const currentPageFiles = filteredFiles.slice(startIndex, endIndex);
            
            // 按上传日期排序（最新的在前）
            currentPageFiles.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
            
            currentPageFiles.forEach(file => {
                const row = createFileRow(file);
                container.appendChild(row);
            });
            
            // 更新文件计数和当前页码
            document.getElementById('fileCount').textContent = filteredFiles.length;
            document.getElementById('currentPage').textContent = currentFilePage;
            
            // 如果在批量选择模式下，更新表格
            if (batchSelectionMode) {
                updateFilesTableForBatchMode();
            }
        }
        
        // 创建文件行（修改版，添加移动按钮）
        function createFileRow(file) {
            const row = document.createElement('tr');
            row.dataset.fileId = file.id;
            
            // 获取文件图标
            const icon = getFileIcon(file.name);
            
            // 获取部门信息
            const deptName = getDepartmentName(file.department);
            const systemName = getSystemName(file.system);
            
            // 检查是否可预览
            const previewable = file.previewable || checkPreviewable(file.name);
            
            // 构建操作按钮
            let actionButtons = '';
            
            if (previewable) {
                const previewText = currentLanguage === 'zh' ? '预览' : 'Xem trước';
                actionButtons += `
                    <button class="action-btn action-preview" onclick="previewFile(${file.id})">
                        <i class="fas fa-eye"></i> ${previewText}
                    </button>
                `;
            }
            
            const downloadText = currentLanguage === 'zh' ? '下载' : 'Tải xuống';
            const moveText = currentLanguage === 'zh' ? '移动' : 'Di chuyển';
            const deleteText = currentLanguage === 'zh' ? '删除' : 'Xóa';
            
            actionButtons += `
                <button class="action-btn action-download" onclick="downloadFile(${file.id})">
                    <i class="fas fa-download"></i> ${downloadText}
                </button>
                <button class="action-btn action-move" onclick="moveFile(${file.id})">
                    <i class="fas fa-exchange-alt"></i> ${moveText}
                </button>
                <button class="action-btn action-delete" onclick="deleteFile(${file.id})">
                    <i class="fas fa-trash"></i> ${deleteText}
                </button>
            `;
            
            // 如果是批量选择模式，第一列显示复选框
            const firstColumn = batchSelectionMode ? 
                '<td><input type="checkbox" class="batch-checkbox" onchange="toggleFileSelection(this, ' + file.id + ')"></td>' : 
                '<td><div class="file-icon ' + icon.class + '"><i class="' + icon.icon + '"></i></div></td>';
            
            row.innerHTML = `
                ${firstColumn}
                <td>
                    <div class="file-info-cell">
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-description">${file.description || (currentLanguage === 'zh' ? '无描述' : 'Không có mô tả')}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="classification-badge level-${file.level}-badge">
                        ${getLevelName(file.level)}
                    </span>
                </td>
                <td>
                    <span class="department-badge dept-${file.department}">${deptName}</span>
                </td>
                <td>
                    <span class="system-badge system-${file.system}" style="background-color: rgba(${hexToRgb(getSystemColor(file.system))}, 0.1); color: ${getSystemColor(file.system)};">
                        ${systemName}
                    </span>
                </td>
                <td>
                    <span class="version-info">${file.version || (currentLanguage === 'zh' ? '无' : 'Không có')}</span>
                </td>
                <td>${file.uploadDate}</td>
                <td>
                    <div class="file-actions">
                        ${actionButtons}
                    </div>
                </td>
            `;
            
            return row;
        }
        
        // 切换文件选择状态（用于批量模式）
        function toggleFileSelection(checkbox, fileId) {
            if (checkbox.checked) {
                selectedFileIds.add(fileId);
            } else {
                selectedFileIds.delete(fileId);
            }
            updateSelectedCount();
        }
        
        // 获取文件图标
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const format = previewableFormats[ext];
            
            if (format) {
                return { icon: `fas ${format.icon}`, class: format.type };
            }
            
            return { icon: 'fas fa-file', class: 'default' };
        }
        
        // 获取级别名称（带语言支持）
        function getLevelName(level) {
            const lang = translations[currentLanguage];
            switch(level) {
                case 1: return lang.level1Short;
                case 2: return lang.level2Short;
                case 3: return lang.level3Short;
                case 4: return lang.level4Short;
                default: return currentLanguage === 'zh' ? '未知' : 'Không xác định';
            }
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // 下载文件
        function downloadFile(id) {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const file = request.result;
                if (!file || !file.data) {
                    showNotification('文件数据不存在', 'error');
                    return;
                }
                
                downloadFileById(id);
            };
        }
        
        // 通过ID下载文件
        function downloadFileById(id) {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const file = request.result;
                if (!file || !file.data) {
                    showNotification('文件数据不存在', 'error');
                    return;
                }
                
                try {
                    // 从Base64数据创建Blob
                    let fileData;
                    
                    if (file.data.startsWith('data:')) {
                        // 如果是Data URL，提取Base64部分
                        const base64Data = file.data.split(',')[1];
                        const byteString = atob(base64Data);
                        const mimeString = file.data.split(',')[0].split(':')[1].split(';')[0];
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        
                        const blob = new Blob([ab], { type: mimeString });
                        const url = URL.createObjectURL(blob);
                        
                        // 创建下载链接
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = file.name;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } else {
                        // 如果是纯Base64
                        const byteString = atob(file.data);
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        
                        // 尝试根据扩展名确定MIME类型
                        const ext = file.name.split('.').pop().toLowerCase();
                        let mimeType = 'application/octet-stream';
                        if (ext === 'pdf') mimeType = 'application/pdf';
                        else if (ext === 'jpg' || ext === 'jpeg') mimeType = 'image/jpeg';
                        else if (ext === 'png') mimeType = 'image/png';
                        else if (ext === 'txt') mimeType = 'text/plain';
                        else if (ext === 'doc') mimeType = 'application/msword';
                        else if (ext === 'docx') mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                        else if (ext === 'xls') mimeType = 'application/vnd.ms-excel';
                        else if (ext === 'xlsx') mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                        
                        const blob = new Blob([ab], { type: mimeType });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = file.name;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }
                    
                    showNotification(`${currentLanguage === 'zh' ? '正在下载: ' : 'Đang tải xuống: '}${file.name}`, 'info');
                } catch (error) {
                    console.error('下载失败:', error);
                    showNotification(currentLanguage === 'zh' ? '文件下载失败' : 'Tải xuống tệp thất bại', 'error');
                }
            };
        }
        
        // 删除文件
        function deleteFile(id) {
            const confirmMessage = translations[currentLanguage].confirmDelete;
            if (!confirm(confirmMessage)) return;
            
            const transaction = db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            store.delete(id);
            
            transaction.oncomplete = function() {
                showNotification(translations[currentLanguage].deleteSuccess, 'success');
                loadFiles();
            };
        }
        
        // 切换ISO级别
        function switchLevel(level) {
            currentLevel = level;
            
            // 更新按钮状态
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.level === level) {
                    btn.classList.add('active');
                }
            });
            
            // 更新标题
            const levelNames = {
                'all': translations[currentLanguage].allFiles,
                '1': translations[currentLanguage].level1,
                '2': translations[currentLanguage].level2,
                '3': translations[currentLanguage].level3,
                '4': translations[currentLanguage].level4
            };
            
            document.getElementById('currentTitle').textContent = levelNames[level];
            
            // 重新加载文件
            loadFiles();
        }
        
        // 切换部门
        function switchDepartment(departmentId) {
            currentDepartment = departmentId;
            
            // 更新部门按钮状态
            document.querySelectorAll('.department-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.department-item[data-department="${departmentId}"]`).classList.add('active');
            
            // 重新加载文件
            loadFiles();
        }
        
        // 初始化部门列表
        function initDepartments() {
            updateDepartmentList();
        }
        
        // 加载文件
        function loadFiles() {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.getAll();
            
            request.onsuccess = function() {
                allFiles = request.result;
                filterAndDisplayFiles(allFiles);
            };
        }
        
        // 过滤和显示文件
        function filterAndDisplayFiles(files) {
            let filtered = files;
            
            // 按ISO级别过滤
            if (currentLevel !== 'all') {
                filtered = filtered.filter(file => file.level == currentLevel);
            }
            
            // 按部门过滤
            if (currentDepartment !== 'all') {
                filtered = filtered.filter(file => file.department === currentDepartment);
            }
            
            // 按体系过滤
            const allSystems = getAllSystems();
            
            filtered = filtered.filter(file => {
                // 找到文件对应的体系
                const system = allSystems.find(s => s.id === file.system);
                if (!system) return true; // 如果没有找到对应的体系，保留文件
                
                // 检查该体系是否被选中
                const checkbox = document.getElementById(`${system.id}Filter`);
                return checkbox ? checkbox.checked : true;
            });
            
            // 搜索过滤
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(file => 
                    file.name.toLowerCase().includes(searchTerm) ||
                    (file.description && file.description.toLowerCase().includes(searchTerm))
                );
            }
            
            filteredFiles = filtered;
            
            // 重置到第一页
            currentFilePage = 1;
            
            // 计算总页数
            totalPages = Math.max(1, Math.ceil(filteredFiles.length / filesPerPage));
            
            // 显示当前页的文件
            displayFilesForPage();
            
            // 更新分页控件
            updatePaginationControls();
            
            // 更新统计信息
            updateStats(filteredFiles);
            updateDepartmentStats(filteredFiles);
            updateSystemStats(filteredFiles);
        }
        
        // 更新统计信息
        function updateStats(files) {
            const level1Count = files.filter(f => f.level == 1).length;
            const level2Count = files.filter(f => f.level == 2).length;
            const level3Count = files.filter(f => f.level == 3).length;
            const level4Count = files.filter(f => f.level == 4).length;
            
            // 更新计数
            document.getElementById('level1Count').textContent = level1Count;
            document.getElementById('level2Count').textContent = level2Count;
            document.getElementById('level3Count').textContent = level3Count;
            document.getElementById('level4Count').textContent = level4Count;
            
            // 更新进度条
            const maxCount = Math.max(level1Count, level2Count, level3Count, level4Count, 1);
            document.getElementById('level1Bar').style.width = `${(level1Count / maxCount) * 100}%`;
            document.getElementById('level2Bar').style.width = `${(level2Count / maxCount) * 100}%`;
            document.getElementById('level3Bar').style.width = `${(level3Count / maxCount) * 100}%`;
            document.getElementById('level4Bar').style.width = `${(level4Count / maxCount) * 100}%`;
        }
        
        // 更新部门统计
        function updateDepartmentStats(files) {
            const departmentStats = document.getElementById('departmentStats');
            departmentStats.innerHTML = '';
            
            // 统计各部门文件数
            const departmentCounts = {};
            departments.forEach(dept => {
                if (dept.id !== 'all') {
                    departmentCounts[dept.id] = files.filter(f => f.department === dept.id).length;
                }
            });
            
            // 创建统计卡片
            Object.entries(departmentCounts).forEach(([deptId, count]) => {
                const dept = departments.find(d => d.id === deptId);
                if (dept && count > 0) {
                    const statCard = document.createElement('div');
                    statCard.className = 'stat-card';
                    const deptName = getDepartmentName(deptId);
                    statCard.innerHTML = `
                        <h4>${deptName}</h4>
                        <div class="count">${count}</div>
                    `;
                    departmentStats.appendChild(statCard);
                }
            });
        }
        
        // 更新体系统计
        function updateSystemStats(files) {
            const systemStats = document.getElementById('systemStats');
            systemStats.innerHTML = '';
            
            // 获取所有体系
            const allSystems = getAllSystems();
            
            // 统计各体系文件数
            allSystems.forEach(system => {
                const count = files.filter(f => f.system === system.id).length;
                if (count > 0) {
                    const statCard = document.createElement('div');
                    statCard.className = `system-stat-card ${system.id}`;
                    const systemName = getSystemName(system.id);
                    statCard.innerHTML = `
                        <h4>${systemName}</h4>
                        <div class="count" style="color: ${system.color}">${count}</div>
                    `;
                    systemStats.appendChild(statCard);
                }
            });
        }
        
        // 以下是简化的示例数据加载函数
        function loadSampleData() {
            const transaction = db.transaction(['files'], 'readonly');
            const store = transaction.objectStore('files');
            const request = store.count();
            
            request.onsuccess = function() {
                if (request.result === 0) {
                    // 添加示例文件
                    addSampleFile('质量管理手册.pdf', 1, 'quality', 'iso', '公司质量管理体系手册');
                    addSampleFile('文件控制程序.docx', 2, 'quality', 'iso', '文件控制程序文件');
                    addSampleFile('生产过程控制程序.docx', 2, 'production', 'iso', '生产过程控制程序');
                    addSampleFile('设备操作规程.pdf', 3, 'tech', 'iso', '设备操作作业指导书');
                    addSampleFile('检验作业指导书.pdf', 3, 'quality', 'iso', '产品检验作业指导');
                    addSampleFile('质量检验记录表.xlsx', 4, 'quality', 'iso', '质量检验记录表单');
                    addSampleFile('安全生产检查记录.xlsx', 4, 'quality', 'ohs', '安全生产检查记录');
                    addSampleFile('IATF16949质量手册.pdf', 1, 'quality', 'iatf', 'IATF16949质量手册');
                    addSampleFile('FMEA控制程序.docx', 2, 'tech', 'iatf', 'FMEA控制程序文件');
                    addSampleFile('职业健康安全手册.pdf', 1, 'hr', 'ohs', '职业健康安全管理手册');
                    addSampleFile('环境管理手册.pdf', 1, 'environment', 'iso14001', 'ISO14001环境管理体系手册');
                    addSampleFile('环境因素识别与评价程序.docx', 2, 'environment', 'iso14001', '环境因素识别与评价程序');
                    addSampleFile('社会责任管理手册.pdf', 1, 'hr', 'social', '社会责任管理体系手册');
                    addSampleFile('员工权益保护程序.docx', 2, 'hr', 'social', '员工权益保护程序文件');
                    addSampleFile('废弃物管理作业指导书.pdf', 3, 'environment', 'iso14001', '废弃物管理作业指导书');
                    addSampleFile('应急准备与响应程序.docx', 2, 'safety', 'ohs', '应急准备与响应程序');
                    addSampleFile('员工满意度调查表.xlsx', 4, 'hr', 'social', '员工满意度调查记录');
                    addSampleFile('环境监测记录表.xlsx', 4, 'environment', 'iso14001', '环境监测记录表单');
                    addSampleFile('能源消耗统计表.xlsx', 4, 'environment', 'iso14001', '能源消耗统计记录');
                    addSampleFile('供应商社会责任评估表.xlsx', 4, 'quality', 'social', '供应商社会责任评估记录');
                    addSampleFile('年度质量目标统计表.xlsx', 4, 'quality', 'iso', '年度质量目标统计记录');
                    addSampleFile('内部审核计划.docx', 2, 'quality', 'iso', '内部审核计划文件');
                    addSampleFile('管理评审会议纪要.docx', 4, 'admin', 'iso', '管理评审会议记录');
                    addSampleFile('产品检验标准.pdf', 3, 'quality', 'iso', '产品检验标准作业指导书');
                    addSampleFile('设备保养记录表.xlsx', 4, 'production', 'iso', '设备保养记录表单');
                    addSampleFile('采购管理程序.docx', 2, 'purchase', 'iso', '采购管理程序文件');
                    addSampleFile('供应商评估表.xlsx', 4, 'purchase', 'iso', '供应商评估记录表单');
                    addSampleFile('采购订单记录.xlsx', 4, 'purchase', 'iso', '采购订单记录');
                    
                    // 重新加载文件
                    setTimeout(() => {
                        loadFiles();
                    }, 500);
                }
            };
        }
        
        function addSampleFile(name, level, department, system, description) {
            const fileData = {
                name: name,
                level: level,
                department: department,
                system: system,
                description: description,
                size: Math.floor(Math.random() * 5000) + 1000,
                uploadDate: new Date().toLocaleDateString('zh-CN'),
                version: 'A',
                isLatest: true,
                classificationConfidence: 0.95,
                classificationReason: '系统示例文件',
                isSample: true,
                previewable: checkPreviewable(name)
            };
            
            const transaction = db.transaction(['files'], 'readwrite');
            const store = transaction.objectStore('files');
            store.add(fileData);
        }
        
        // 辅助函数：将十六进制颜色转换为RGB格式
        function hexToRgb(hex) {
            // 移除#号
            hex = hex.replace('#', '');
            
            // 解析RGB值
            let r, g, b;
            if (hex.length === 3) {
                r = parseInt(hex[0] + hex[0], 16);
                g = parseInt(hex[1] + hex[1], 16);
                b = parseInt(hex[2] + hex[2], 16);
            } else if (hex.length === 6) {
                r = parseInt(hex.substring(0, 2), 16);
                g = parseInt(hex.substring(2, 4), 16);
                b = parseInt(hex.substring(4, 6), 16);
            } else {
                return '93, 63, 211'; // 默认主色
            }
            
            return `${r}, ${g}, ${b}`;
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化数据库
            initDatabase();
            
            // 初始化语言
            updateLanguage();
            
            // ISO级别按钮点击事件
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const level = this.dataset.level;
                    switchLevel(level);
                });
            });
            
            // 搜索框输入事件
            document.getElementById('searchInput').addEventListener('input', loadFiles);
            
            // 文件拖放功能
            const dropArea = document.getElementById('fileDropArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                dropArea.style.borderColor = '#7E57C2';
                dropArea.style.backgroundColor = 'rgba(93, 63, 211, 0.1)';
                dropArea.style.transform = 'translateY(-5px)';
            }
            
            function unhighlight() {
                dropArea.style.borderColor = 'var(--primary-color)';
                dropArea.style.backgroundColor = 'rgba(93, 63, 211, 0.03)';
                dropArea.style.transform = 'translateY(0)';
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const items = dt.items;
                const files = [];
                
                // 处理拖放的文件和文件夹
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    
                    if (item.kind === 'file') {
                        const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                        
                        if (entry && entry.isDirectory) {
                            // 处理文件夹
                            readDirectoryEntry(entry, files);
                        } else {
                            // 处理文件
                            const file = item.getAsFile();
                            if (file) files.push(file);
                        }
                    }
                }
                
                // 如果从拖放中直接获取到了文件
                if (files.length === 0 && dt.files.length > 0) {
                    files.push(...dt.files);
                }
                
                if (files.length > 0) {
                    addFilesToUploadList(files);
                }
                
                unhighlight();
            }
            
            // 读取文件夹内容
            function readDirectoryEntry(entry, fileList) {
                const reader = entry.createReader();
                
                reader.readEntries(function(entries) {
                    entries.forEach(function(entry) {
                        if (entry.isFile) {
                            entry.file(function(file) {
                                fileList.push(file);
                            });
                        } else if (entry.isDirectory) {
                            readDirectoryEntry(entry, fileList);
                        }
                    });
                });
            }
            
            // 点击预览模态框外部关闭
            window.addEventListener('click', function(e) {
                const modal = document.getElementById('previewModal');
                if (e.target === modal) {
                    closePreview();
                }
                
                const uploadModal = document.getElementById('uploadModal');
                if (e.target === uploadModal) {
                    closeModal();
                }
                
                const moveModal = document.getElementById('moveModal');
                if (e.target === moveModal) {
                    closeMoveModal();
                }
                
                const addSystemModal = document.getElementById('addSystemModal');
                if (e.target === addSystemModal) {
                    closeAddSystemModal();
                }
            });
            
            // 初始化颜色预览
            const colorInput = document.getElementById('newSystemColor');
            if (colorInput) {
                colorInput.addEventListener('input', function() {
                    document.getElementById('colorPreview').style.backgroundColor = this.value;
                });
            }
        });
        
        // 预览Office文件（Word和Excel）的简化版本
        function previewOfficeFile(file, ext) {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            
            // 清除加载状态
            document.getElementById('previewLoading').style.display = 'none';
            
            try {
                // 创建预览区域
                const previewDiv = document.createElement('div');
                previewDiv.className = 'unsupported-preview';
                previewDiv.style.textAlign = 'center';
                previewDiv.style.padding = '40px';
                
                let fileType = currentLanguage === 'zh' ? 'Office文件' : 'Tệp Office';
                let icon = 'fa-file';
                
                if (ext === 'doc' || ext === 'docx') {
                    fileType = currentLanguage === 'zh' ? 'Word文档' : 'Tài liệu Word';
                    icon = 'fa-file-word';
                } else if (ext === 'xls' || ext === 'xlsx') {
                    fileType = currentLanguage === 'zh' ? 'Excel文件' : 'Tệp Excel';
                    icon = 'fa-file-excel';
                }
                
                const downloadText = currentLanguage === 'zh' ? '下载文件' : 'Tải xuống tệp';
                const previewNote = currentLanguage === 'zh' ? '系统支持在线预览PDF、图片和文本文件' : 'Hệ thống hỗ trợ xem trước trực tuyến PDF, hình ảnh và tệp văn bản';
                
                previewDiv.innerHTML = `
                    <i class="fas ${icon}" style="font-size: 64px; color: var(--primary-color); margin-bottom: 20px;"></i>
                    <h3>${fileType}${currentLanguage === 'zh' ? '预览' : ' Xem trước'}</h3>
                    <p>${currentLanguage === 'zh' ? '在线预览器无法直接预览此文件，但您可以：' : 'Trình xem trước trực tuyến không thể xem trực tiếp tệp này, nhưng bạn có thể:'}</p>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="downloadCurrentPreview()" style="margin-right: 10px;">
                            <i class="fas fa-download"></i> ${downloadText}
                        </button>
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i> ${previewNote}
                    </div>
                `;
                
                previewArea.appendChild(previewDiv);
                
                // 确保工具条和信息面板显示
                document.getElementById('previewToolbar').style.display = 'flex';
                document.getElementById('previewFileInfo').style.display = 'block';
                
            } catch (error) {
                console.error('Office文件预览失败:', error);
                showUnsupportedPreview();
            }
        }
        
        // 显示不支持预览的界面
        function showUnsupportedPreview() {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            
            // 清除加载状态
            document.getElementById('previewLoading').style.display = 'none';
            
            const unsupportedText = currentLanguage === 'zh' ? '不支持在线预览' : 'Không hỗ trợ xem trước trực tuyến';
            const downloadText = currentLanguage === 'zh' ? '下载文件' : 'Tải xuống tệp';
            const unsupportedDesc = currentLanguage === 'zh' ? '该文件格式不支持在线预览，您可以下载文件后使用本地软件打开' : 'Định dạng tệp này không hỗ trợ xem trước trực tuyến, bạn có thể tải xuống tệp và mở bằng phần mềm cục bộ';
            
            const unsupportedDiv = document.createElement('div');
            unsupportedDiv.className = 'unsupported-preview';
            unsupportedDiv.innerHTML = `
                <i class="fas fa-file" style="font-size: 64px; color: var(--primary-color); margin-bottom: 20px;"></i>
                <h3>${unsupportedText}</h3>
                <p>${unsupportedDesc}</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="downloadCurrentPreview()">
                        <i class="fas fa-download"></i> ${downloadText}
                    </button>
                </div>
            `;
            
            previewArea.appendChild(unsupportedDiv);
            
            document.getElementById('previewToolbar').style.display = 'flex';
            document.getElementById('previewFileInfo').style.display = 'block';
        }
        
        // 预览PDF文件（简化版）
        function previewPDF(file) {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            
            // 清除加载状态
            document.getElementById('previewLoading').style.display = 'none';
            
            try {
                // 创建iframe显示PDF
                const iframe = document.createElement('iframe');
                iframe.className = 'pdf-preview';
                iframe.src = file.data;
                iframe.title = file.name;
                
                previewArea.appendChild(iframe);
                
                // 确保工具条和信息面板显示
                document.getElementById('previewToolbar').style.display = 'flex';
                document.getElementById('previewFileInfo').style.display = 'block';
                
            } catch (error) {
                console.error('PDF预览失败:', error);
                showUnsupportedPreview();
            }
        }
        
        // 预览图片文件（简化版）
        function previewImage(file) {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            
            // 清除加载状态
            document.getElementById('previewLoading').style.display = 'none';
            
            try {
                // 创建img元素显示图片
                const img = document.createElement('img');
                img.className = 'image-preview';
                img.src = file.data;
                img.alt = file.name;
                
                previewArea.appendChild(img);
                
                // 确保工具条和信息面板显示
                document.getElementById('previewToolbar').style.display = 'flex';
                document.getElementById('previewFileInfo').style.display = 'block';
                
            } catch (error) {
                console.error('图片预览失败:', error);
                showUnsupportedPreview();
            }
        }
        
        // 预览文本文件（简化版）
        function previewText(file) {
            const previewArea = document.getElementById('previewArea');
            previewArea.innerHTML = '';
            
            // 清除加载状态
            document.getElementById('previewLoading').style.display = 'none';
            
            try {
                // 解码Base64数据
                let textContent;
                if (file.data.startsWith('data:')) {
                    const base64Data = file.data.split(',')[1];
                    textContent = atob(base64Data);
                } else {
                    textContent = atob(file.data);
                }
                
                // 创建文本预览区域
                const textDiv = document.createElement('div');
                textDiv.className = 'text-preview';
                textDiv.textContent = textContent.substring(0, 10000); // 限制显示长度
                
                if (textContent.length > 10000) {
                    const truncateText = currentLanguage === 'zh' ? '...（内容过长，已截断）' : '...（Nội dung quá dài, đã cắt bớt）';
                    textDiv.textContent += '\n\n' + truncateText;
                }
                
                previewArea.appendChild(textDiv);
                
                // 确保工具条和信息面板显示
                document.getElementById('previewToolbar').style.display = 'flex';
                document.getElementById('previewFileInfo').style.display = 'block';
                
            } catch (error) {
                console.error('文本预览失败:', error);
                showUnsupportedPreview();
            }
        }
        
        // 显示文件信息
        function displayFileInfo(file) {
            const fileInfoContent = document.getElementById('fileInfoContent');
            const deptName = getDepartmentName(file.department);
            const systemName = getSystemName(file.system);
            
            const fileNameLabel = currentLanguage === 'zh' ? '文件名称' : 'Tên tệp';
            const fileDescLabel = currentLanguage === 'zh' ? '文件描述' : 'Mô tả tệp';
            const isoLevelLabel = currentLanguage === 'zh' ? 'ISO级别' : 'Cấp ISO';
            const deptLabel = currentLanguage === 'zh' ? '所属部门' : 'Phòng ban';
            const systemLabel = currentLanguage === 'zh' ? '体系类型' : 'Loại hệ thống';
            const versionLabel = currentLanguage === 'zh' ? '版本号' : 'Số phiên bản';
            const fileSizeLabel = currentLanguage === 'zh' ? '文件大小' : 'Kích thước tệp';
            const uploadDateLabel = currentLanguage === 'zh' ? '上传日期' : 'Ngày tải lên';
            const confidenceLabel = currentLanguage === 'zh' ? '分类置信度' : 'Độ tin cậy phân loại';
            const noDesc = currentLanguage === 'zh' ? '无描述' : 'Không có mô tả';
            const noVersion = currentLanguage === 'zh' ? '无' : 'Không có';
            
            fileInfoContent.innerHTML = `
                <div class="info-item">
                    <label>${fileNameLabel}</label>
                    <div>${file.name}</div>
                </div>
                <div class="info-item">
                    <label>${fileDescLabel}</label>
                    <div>${file.description || noDesc}</div>
                </div>
                <div class="info-item">
                    <label>${isoLevelLabel}</label>
                    <div>${getLevelName(file.level)}</div>
                </div>
                <div class="info-item">
                    <label>${deptLabel}</label>
                    <div>${deptName}</div>
                </div>
                <div class="info-item">
                    <label>${systemLabel}</label>
                    <div>${systemName}</div>
                </div>
                <div class="info-item">
                    <label>${versionLabel}</label>
                    <div>${file.version || noVersion}</div>
                </div>
                <div class="info-item">
                    <label>${fileSizeLabel}</label>
                    <div>${formatFileSize(file.size)}</div>
                </div>
                <div class="info-item">
                    <label>${uploadDateLabel}</label>
                    <div>${file.uploadDate}</div>
                </div>
                ${file.classificationConfidence ? `
                <div class="info-item">
                    <label>${confidenceLabel}</label>
                    <div>${(file.classificationConfidence * 100).toFixed(1)}%</div>
                </div>
                ` : ''}
            `;
        }
        
        // 缩放功能（简化版）
        function zoomIn() {
            const previewArea = document.getElementById('previewArea');
            const currentScale = parseFloat(previewArea.style.transform?.replace('scale(', '')?.replace(')', '')) || 1;
            const newScale = Math.min(currentScale + 0.1, 3);
            previewArea.style.transform = `scale(${newScale})`;
            currentZoom = newScale;
        }
        
        function zoomOut() {
            const previewArea = document.getElementById('previewArea');
            const currentScale = parseFloat(previewArea.style.transform?.replace('scale(', '')?.replace(')', '')) || 1;
            const newScale = Math.max(currentScale - 0.1, 0.1);
            previewArea.style.transform = `scale(${newScale})`;
            currentZoom = newScale;
        }
        
        function resetZoom() {
            const previewArea = document.getElementById('previewArea');
            previewArea.style.transform = 'scale(1)';
            currentZoom = 1.0;
        }
        
        // 页面导航功能（简化版）
        function prevPage() {
            if (currentPreviewFile && currentPreviewFile.type === 'pdf') {
                // PDF页面导航逻辑
                const iframe = document.querySelector('.pdf-preview');
                if (iframe) {
                    // 这里可以添加PDF页面导航逻辑
                    const message = currentLanguage === 'zh' ? 'PDF页面导航功能需要PDF.js库支持' : 'Chức năng điều hướng trang PDF cần thư viện PDF.js';
                    showNotification(message, 'info');
                }
            }
        }
        
        function nextPage() {
            if (currentPreviewFile && currentPreviewFile.type === 'pdf') {
                // PDF页面导航逻辑
                const iframe = document.querySelector('.pdf-preview');
                if (iframe) {
                    // 这里可以添加PDF页面导航逻辑
                    const message = currentLanguage === 'zh' ? 'PDF页面导航功能需要PDF.js库支持' : 'Chức năng điều hướng trang PDF cần thư viện PDF.js';
                    showNotification(message, 'info');
                }
            }
        }
    </script>
</body>
</html>